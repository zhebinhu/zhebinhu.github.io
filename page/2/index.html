<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="eUR5SKlr43nnaOTR9jYvH7hmuRFkEWSOzCOoR7kUeNk" />
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>huzb的小书斋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一枚前行的小码农">
<meta property="og:type" content="website">
<meta property="og:title" content="huzb的小书斋">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="huzb的小书斋">
<meta property="og:description" content="一枚前行的小码农">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="huzb的小书斋">
<meta name="twitter:description" content="一枚前行的小码农">
  
    <link rel="alternative" href="/atom.xml" title="huzb的小书斋" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/headicon.jpg">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

  <script src="https://cdn.bootcss.com/pangu/3.3.0/pangu.min.js"></script>
</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/img/headicon.jpg" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">huzb</a></h1>
		</hgroup>
		
		<p class="header-subtitle">念念不忘，必有回响</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/photos/">相册</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/zhebinhu" title="github"><i class="icon-github"></i></a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/hu-zhe-bin-91/activities" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=huzhebin2017@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/img/headicon.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">huzb</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>念念不忘，必有回响<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/zhebinhu" title="github"><i class="icon-github"></i></a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/hu-zhe-bin-91/activities" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=huzhebin2017@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/photos/">相册</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-插入缓冲、两次写和自适应哈希索引" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/14/插入缓冲、两次写和自适应哈希索引/">插入缓冲、两次写和自适应哈希索引</a>
    </h1>
  

        
        <a href="/2019/01/14/插入缓冲、两次写和自适应哈希索引/" class="archive-article-date">
  	<time datetime="2019-01-14T03:56:25.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2019-01-14</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>InnoDB 是 MySQL 数据库从 5.5.8 版本开始的默认存储引擎，它将数据放在一个逻辑的表空间中，这个表空间就像黑盒一样由 InnoDB 存储引擎自身进行管理。从 MySQL 4.1 开始，它可以将每个 InnoDB 的表单独存在一个独立的 idb 文件中。此外，InnoDB 支持用裸设备（raw disk，不被操作系统管理的设备）建立其表空间。</p>
<p>InnoDB 通过使用多版本并发控制（MVCC）来获得高并发性，并且实现了 SQL 标准的四种隔离级别，默认为 REPEATABLE 级别。同时，使用一种称为 next-key locking 的策略来避免幻读。除此之外，InnoDB 还提供了<strong>插入缓冲、二次写、自适应哈希索引</strong>等高性能和高可用的功能。</p>
<h2 id="缓冲池"><a href="#缓冲池" class="headerlink" title="缓冲池"></a>缓冲池</h2><p>功能的实现离不开底层的配合。为了协调 CPU 速度与磁盘速度之间的鸿沟，InnoDB 在内存中开辟了一块空间叫内存池，将对数据库的修改首先保存在内存中。比如对于页的操作，首先会在内存中进行，然后后台线程会把脏页（还没有刷入磁盘的页）刷入磁盘。<br><img src="/2019/01/14/插入缓冲、两次写和自适应哈希索引/内存池.png"></p>
<p>缓冲池中缓存的数据页类型有：索引页、数据页、undo 页、插入缓冲、自适应哈希索引、InnoDB 存储的锁信息、数据字典信息等。不能简单地认为，缓冲池只是缓存索引页和数据页，它们只是占缓冲池很大的一部分而已。</p>
<h3 id="中点插入策略"><a href="#中点插入策略" class="headerlink" title="中点插入策略"></a>中点插入策略</h3><p>缓冲池对于数据页的管理，是使用 LRU 的方式管理的。和传统的 LRU 稍有不同的是，InnoDB 使用一种称为“中点插入策略”的方式插入数据：</p>
<ul>
<li>新页的第一次插入只会插入到 LRU 链表尾端 3/8（中点）的位置</li>
<li>页的再次命中（LRU 上的页被命中）才会把页插入到链表头部</li>
<li>可以设置一个 InnoDB_old_blocks_time 的参数，表示新页插入后过多久才有资格被插入到链表头部</li>
</ul>
<p>这样做的好处是避免了一些冷数据对真正热点数据的干扰。比如进行扫描操作时，需要访问表中的许多页，甚至是全部页，而这些页通常来说只在这次查询中需要，并不是活跃的热点数据。如果页被放入 LRU 链表头部，那么非常可能将所需的真正热点数据刷出。InnoDB_old_blocks_time 也是出于同样的目的。可以避免临近的几次查询把页刷入热数据的情况。</p>
<h2 id="插入缓冲"><a href="#插入缓冲" class="headerlink" title="插入缓冲"></a>插入缓冲</h2><p>InnoDB 底层使用聚簇索引管理数据。在进行插入操作的时候，数据页的存放是按主键顺序存放的，此时磁盘顺序访问，速度会很快。但对于非聚集索引叶子节点的插入则不再是顺序的了，这时需要离散地访问非聚集索引页，磁盘的随机读取效率很低，导致了插入操作的性能下降。</p>
<p>InnoDB 存储引擎创造性地设计了 Insert Buffer，对于非聚簇索引的插入或更新操作，不是每一次直接插入到索引页中，而是先判断插入的非聚簇索引页是否在缓冲池中，若在，则直接插入；若不在，则先放入到一个 Insert Buffer 对象中。然后再以一定的频率和情况进行 Insert Buffer 和辅助索引叶子节点的 merge 操作，这时通常能将多个插入合并到一个操作中（因为在一个索引页中），这就大大提高了对于非聚簇索引插入的性能。</p>
<p>然而 Insert Buffer 的使用需要同时满足以下两个条件：</p>
<ul>
<li>索引是辅助索引。</li>
<li>索引不是唯一的。（因为在插入缓冲时，数据库并不去查找索引页来判断插入的记录的唯一性。如果去查找肯定又会有离散读取的发生，就背离了 Insert Buffer 的初衷）</li>
</ul>
<p>Insert Buffer 的数据结构是一颗 B+树，4.1 版本之前每张表都有一颗 Insert Buffer B+树，4.1 版本之后所有表共用一颗 B+树。Insert Buffer B+树的非叶子节点存放的是查询的 search key，其构造如图：<br><img src="/2019/01/14/插入缓冲、两次写和自适应哈希索引/插入缓冲非叶子节点.png"></p>
<p>其中 space 表示待插入记录所在表的表空间 id，在 InnoDB 存储引擎中，每个表有一个唯一的 space id，可以通过 space id 查询得知是哪张表；maker 是用来兼容老版本的 Insert Buffer。offerset 表示页所在的偏移量。</p>
<p>当一个辅助索引要插入到页（space,offset）时，如果这个页不在缓冲池中，那么 InnoDB 存储引擎首先根据上述规则构造一个 search key，接下来查询 Insert Buffer 这棵 B+树，然后再将记录插入到 Insert Buffer B+树的叶子节点中。</p>
<h2 id="两次写"><a href="#两次写" class="headerlink" title="两次写"></a>两次写</h2><p>如果说 Insert Buffer 带给 InnoDB 存储引擎的是性能上的提升，那么 doublewrite（两次写）带给 InnoDB 存储引擎的是数据页的可靠性。</p>
<p>InnoDB 中有记录（Row）被更新时，先将其在 Buffer Pool 中的 page 更新，并将这次更新记录到 Redo Log file 中，这时候 Buffer Pool 中的该 page 就是被标记为 Dirty。在适当的时候（Buffer Pool 不够、Redo 不够，系统闲置等），这些 Dirty Page 会被 Checkpoint 刷新到磁盘进行持久化操作。</p>
<p>但尴尬的地方在于 InnoDB 的 Page Size 是 16KB，其数据校验也是针对这 16KB 来计算的，将数据写入到磁盘是以 Page 为单位进行操作的，而文件系统是以 4k 为单位写入，磁盘 IO 的最小单位是 512K，因此并不能保证数据页的写入就是原子性的。</p>
<p>那么可不可以通过 redo log 来进行恢复呢？答案是只能恢复校验完整（还没写）的页，不能恢复已损坏的页。比如某次 checkpoint 要刷入 4 个数据页，其中第一页写了 2KB，后三页还未写。那么根据 redo log 可以恢复后三页，但已经写了 2KB 的页没法恢复，因为没法知道在宕机前第一页到底写了多少。</p>
<p><strong>为什么 redo log 不需要 doublewrite 的支持？</strong></p>
<blockquote>
<p>因为 redolog 写入的单位就是 512 字节，也就是磁盘 IO 的最小单位，所以无所谓数据损坏。</p>
</blockquote>
<p>double write 由两部分组成，一部分是内存中的 doublewrite buffer，大小为 2MB，另一部分是物理磁盘上共享表空间中连续的 128 个页，即 2 个区，大小同样为 2MB。在对缓冲池的脏页进行刷新时，并不直接写磁盘，而是会通过 memcpy 函数将脏页先复制到内存中的 doublewrite buffer，之后通过 doublewrite buffer 再分两次，每次 1MB 顺序地写入共享表空间的物理磁盘上，然后马上调用 fsync 函数，同步磁盘。在这个过程中，因为 doublewrite 页是连续的，因此这个过程是顺序写的，开销不是很大。其工作流程如下图所示：<br><img src="/2019/01/14/插入缓冲、两次写和自适应哈希索引/两次写工作流程.png"></p>
<p>现在我们来分析一下为什么 double write 可以生效。当宕机发生时，有那么几种情况：1、磁盘还未写，此时可以通过 redo log 恢复；2、磁盘正在进行从内存到共享表空间的写，此时数据文件中的页还没开始被写入，因此也同样可以通过 redo log 恢复；3、磁盘正在写数据文件，此时共享表空间已经写完，可以从共享表空间拷贝页的副本到数据文件实现恢复。</p>
<h2 id="自适应哈希索引"><a href="#自适应哈希索引" class="headerlink" title="自适应哈希索引"></a>自适应哈希索引</h2><p>哈希是一种非常快的查询方法，一般只需要一次查找就能定位数据。InnoDB 存储引擎会监控对表上各索引页的查询，如果观察到建立哈希索引可以带来速度提升，则建立哈希索引，称之为自适应哈希索引。</p>
<p>自适应哈希索引有一个要求，即对这个页的连续访问模式必须是一样的。例如对于（a,b）这样的联合索引页，其访问模式可以是以下情况：</p>
<ul>
<li>WHERE a=xxx</li>
<li>WHERE a=xxx and b=xxx</li>
</ul>
<p>若交替以上两种查询，那么 InnoDB 存储引擎不会对该页构造哈希索引（这是因为哈希索引是以索引的哈希值为键值存放的，hash(a) 和 hash(a,b) 是两个完全不同的值）</p>
<p>在连续的查询模式一样的条件下，如果能满足以下条件，InnoDB 存储引擎就会创建相应的哈希索引：</p>
<ul>
<li>以该连续模式连续访问了 100 次</li>
<li>以该模式连续访问了 页中记录总数/16 次</li>
</ul>
<p>哈希索引只能用来搜索等值的查询，如 SELECT * FROM table WHERE index_col=’xxx’。对于其它类型的查找，如范围查找，是不能使用哈希索引的。</p>
<p>InnoDB 存储引擎官方文档显示，启用 AHI 后,读取和写入速度可以提高 2 倍，辅助索引的连接操作性能可以提高 5 倍。 </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>InnoDB 存储引擎在 MySQL 原有的基础上做了很多优化，主要涉及到的就是缓冲池和磁盘的交互。尽可能多地读缓存，尽量少地读磁盘，于是有了自适应哈希索引；尽量多地顺序写，尽量少地离散写，于是有了插入缓冲；由于缓存的易失性，带来的数据恢复问题，又有了两次写。这些设计思想不只可以用于数据库，也可以用于程序设计的方方面面。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">MySQL</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2019/01/14/插入缓冲、两次写和自适应哈希索引/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Java-NIO 浅析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/09/Java-NIO 浅析/">Java NIO 浅析</a>
    </h1>
  

        
        <a href="/2019/01/09/Java-NIO 浅析/" class="archive-article-date">
  	<time datetime="2019-01-09T04:10:18.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2019-01-09</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>NIO（Non-blocking I/O），是一种同步非阻塞的 I/O 模型，也是 I/O 多路复用的基础，已经被越来越多地应用到大型应用服务器，成为解决高并发与大量连接、I/O 处理问题的有效方式。Java 中的 NIO 是 jdk 1.4 之后新出的一套 IO 接口，相比传统 IO(BIO)，两者有如下区别：</p>
<ul>
<li>IO 是面向流的，NIO 是面向缓冲区的</li>
<li>IO 流是同步阻塞的，NIO 流是同步非阻塞的</li>
<li>NIO 有选择器（Selector），IO 没有</li>
<li>IO 的流是单向的，NIO 的通道（Channel）是双向的</li>
</ul>
<h2 id="IO-基本概念"><a href="#IO-基本概念" class="headerlink" title="IO 基本概念"></a>IO 基本概念</h2><p>Linux 的内核将所有外部设备都可以看做一个文件来操作。那么我们对与外部设备的操作都可以看做对文件进行操作。我们对一个文件的读写，都通过调用内核提供的系统调用；内核给我们返回一个 file descriptor（fd,文件描述符）。对一个 socket 的读写也会有相应的描述符，称为 socketfd(socket 描述符）。描述符就是一个数字 (可以理解为一个索引)，指向内核中一个结构体（文件路径，数据区，等一些属性）。应用程序对文件的读写就通过对描述符的读写完成。</p>
<p>一个基本的 IO，它会涉及到两个系统对象，一个是调用这个 IO 的进程对象，另一个就是系统内核 (kernel)。当一个 read 操作发生时，它会经历四个阶段：</p>
<ul>
<li>1、通过 read 系统调用想内核发起读请求。</li>
<li>2、内核向硬件发送读指令，并等待读就绪。</li>
<li>3、内核把将要读取的数据复制到描述符所指向的内核缓存区中。</li>
<li>4、将数据从内核缓存区拷贝到用户进程空间中。</li>
</ul>
<h3 id="同步和异步"><a href="#同步和异步" class="headerlink" title="同步和异步"></a>同步和异步</h3><p>同步和异步关注的是消息通信机制 (synchronous communication / asynchronous communication)<br>。所谓同步，就是在发出一个调用时，在没有得到结果之前，该调用就不返回。但是一旦调用返回，就得到返回值了。 而异步则是相反，调用在发出之后，这个调用就直接返回了，所以没有返回结果。换句话说，当一个异步过程调用发出后，调用者不会立刻得到结果。而是在调用发出后，被调用者通过状态、通知来通知调用者，或通过回调函数处理这个调用。</p>
<h3 id="阻塞和非阻塞"><a href="#阻塞和非阻塞" class="headerlink" title="阻塞和非阻塞"></a>阻塞和非阻塞</h3><p>阻塞和非阻塞关注的是程序在等待调用结果（消息，返回值）时的状态。阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。 非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程。</p>
<h2 id="常见-I-O-模型对比"><a href="#常见-I-O-模型对比" class="headerlink" title="常见 I/O 模型对比"></a>常见 I/O 模型对比</h2><p>所有的系统 I/O 都分为两个阶段：等待就绪和操作。举例来说，读函数，分为等待系统可读和真正的读；同理，写函数分为等待网卡可以写和真正的写。需要说明的是等待就绪的阻塞是不使用 CPU 的，是在“空等”；而真正的读写操作的阻塞是使用 CPU 的，真正在”干活”，而且这个过程非常快，属于 memory copy，带宽通常在 1GB/s 级别以上，可以理解为基本不耗时。</p>
<p>以 socket.read() 为例子：传统的 BIO 里面 socket.read()，如果 TCP RecvBuffer 里没有数据，函数会一直阻塞，直到收到数据，返回读到的数据。对于 NIO，如果 TCP RecvBuffer 有数据，就把数据从网卡读到内存，并且返回给用户；反之则直接返回 0，永远不会阻塞。最新的 AIO(Async I/O) 里面会更进一步：不但等待就绪是非阻塞的，就连数据从网卡到内存的过程也是异步的。换句话说，BIO 里用户最关心“我要读”，NIO 里用户最关心”我可以读了”，在 AIO 模型里用户更需要关注的是“读完了”。NIO 一个重要的特点是：socket 主要的读、写、注册和接收函数，在等待就绪阶段都是非阻塞的，真正的 I/O 操作是同步阻塞的（消耗 CPU 但性能非常高）。</p>
<h3 id="传统-BIO-模型分析"><a href="#传统-BIO-模型分析" class="headerlink" title="传统 BIO 模型分析"></a>传统 BIO 模型分析</h3><p>了解 NIO 就要从传统 BIO 的弊端说起。</p>
<p><img src="/2019/01/09/Java-NIO 浅析/常见 IO 模型对比.jpg"></p>
<p>在传统的 BIO 中，一旦用户线程发起 IO 请求，则必须要等内核将数据报准备好，才能将数据从内核复制到用户空间。这是一种效率很低的方式。传统的 BIO 一般要配合线程池来使用，我们的编程范式（伪代码）一般是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Excutors.newFixedThreadPollExecutor(<span class="number">100</span>); <span class="comment">// 线程池</span></span><br><span class="line">ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">serverSocket.bind(<span class="number">8088</span>);</span><br><span class="line"><span class="keyword">while</span>(!Thread.currentThread.isInturrupted())&#123; <span class="comment">// 主线程死循环等待新连接到来</span></span><br><span class="line">    Socket socket = serverSocket.accept();</span><br><span class="line">    executor.submit(<span class="keyword">new</span> ConnectIOnHandler(socket)); <span class="comment">// 为新的连接创建新的线程</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectIOnHandler</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConnectIOnHandler</span><span class="params">(Socket socket)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(!Thread.currentThread.isInturrupted()&amp;&amp;!socket.isClosed())&#123; <span class="comment">// 死循环处理读写事件</span></span><br><span class="line">            String someThing = socket.read()....<span class="comment">// 读取数据</span></span><br><span class="line">            <span class="keyword">if</span>(someThing!=<span class="keyword">null</span>)&#123;</span><br><span class="line">         ......<span class="comment">//处理数据</span></span><br><span class="line">                socket.write()....<span class="comment">// 写数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个经典的每连接每线程的模型，之所以使用多线程，主要原因在于 socket.accept()、socket.read()、socket.write() 三个主要函数都是同步阻塞的，当一个连接在处理 I/O 的时候，系统是阻塞的，如果是单线程的话必然就挂死在那里；但 CPU 是被释放出来的，开启多线程，就可以让 CPU 去处理更多的事情。其实这也是所有使用多线程的本质：</p>
<ul>
<li>利用多核。</li>
<li>当 I/O 阻塞系统，但 CPU 空闲的时候，可以利用多线程使用 CPU 资源。</li>
</ul>
<p>现在的多线程一般都使用线程池，可以让线程的创建和回收成本相对较低。在活动连接数不是特别高（小于单机 1000）的情况下，这种模型是比较不错的，可以让每一个连接专注于自己的 I/O 并且编程模型简单，也不用过多考虑系统的过载、限流等问题。线程池本身就是一个天然的漏斗，可以缓冲一些系统处理不了的连接或请求。</p>
<p>不过，这个模型最本质的问题在于，严重依赖于线程。但线程是很”贵”的资源，主要表现在：</p>
<ul>
<li>线程的创建和销毁成本很高，在 Linux 这样的操作系统中，线程本质上就是一个进程。创建和销毁都是重量级的系统函数。</li>
<li>线程本身占用较大内存，像 Java 的线程栈，一般至少分配 512K～1M 的空间，如果系统中的线程数过千，恐怕整个 JVM 的内存都会被吃掉一半。</li>
<li>线程的切换成本是很高的。操作系统发生线程切换的时候，需要保留线程的上下文，然后执行系统调用。如果线程数过高，可能执行线程切换的时间甚至会大于线程执行的时间，这时候带来的表现往往是系统 load 偏高、CPU sy 使用率特别高（超过 20%以上)，导致系统几乎陷入不可用的状态。</li>
<li>容易造成锯齿状的系统负载。因为系统负载是用活动线程数或 CPU 核心数，一旦线程数量高但外部网络环境不是很稳定，就很容易造成大量请求的结果同时返回，激活大量阻塞线程从而使系统负载压力过大。</li>
</ul>
<p>所以，当面对十万甚至百万级连接的时候，传统的 BIO 模型是无能为力的。随着移动端应用的兴起和各种网络游戏的盛行，百万级长连接日趋普遍，此时，必然需要一种更高效的 I/O 处理模型。</p>
<h3 id="NIO-是如何工作的"><a href="#NIO-是如何工作的" class="headerlink" title="NIO 是如何工作的"></a>NIO 是如何工作的</h3><p><img src="/2019/01/09/Java-NIO 浅析/NIO1.jpg"></p>
<p>这是一个 NIO 基本的工作方式（但不常用），我们把一个套接口设置为非阻塞，当所请求的 I/O 操作不能满足要求时候，不把本进程投入睡眠，而是返回一个错误。也就是说当数据没有到达时并不等待，而是以一个错误返回。</p>
<h3 id="事件驱动的-I-O-复用模型（常用）"><a href="#事件驱动的-I-O-复用模型（常用）" class="headerlink" title="事件驱动的 I/O 复用模型（常用）"></a>事件驱动的 I/O 复用模型（常用）</h3><p>在 BIO 的场景下，为了避免线程长时间阻塞在等待内核准备上，我们选择了每连接每线程的方式。但在 NIO 的场景下，如果当前的连接没有准备好，可以选择下一个连接。比如我们的聊天程序，我们可以建立两个连接：一个发送端，一个接收端。程序会不断轮询这两个连接，如果接收端有数据达到，那就把它显示在屏幕上；如果发送端有数据发出，那就把它发出。但如果接收端没有数据，或者发送端的网卡没有准备好，程序也不会停下来，而是继续轮询，直到有一方准备好。<strong>这种一个进程/线程处理多个 IO 的方式，被称为 I/O 复用模型。</strong></p>
<p>而如果我们把发送就绪和接收就绪当成两类事件，只有在这两类事件发生的时候才会触发轮询，其它时候（比如等待请求时），程序不会被唤醒，那么这种方式就被称为<strong>事件驱动。</strong></p>
<p>Linux 中的 select,poll,epoll 是典型的事件驱动的 I/O 复用模型：</p>
<p><img src="/2019/01/09/Java-NIO 浅析/NIO2.jpg"></p>
<p>select() 会把所有的 I/O 请求封装为文件描述符 (fd) 的形式给操作系统，让操作系统内核去查询这些套接字上是否有事件发生，轮询完后，再将句柄数据复制到用户态，让服务器应用程序轮询处理已发生的网络事件，以此来实现一个线程/进程管理多个 I/O 的功能。</p>
<p>poll() 在 select 上支持更多数量的 fd。因为 select 中使用数组形式存放文件描述符，数量有限（一般 1024 个），poll 使用链表的形式，理论上支持的描述符数量没有上限。</p>
<p>epoll() 在 select/poll 的基础上有了大幅改进：</p>
<ul>
<li>它使用红黑树来存储所有需要查询的事件，事件的添加和删除对应红黑树的插入和删除，复杂度从 O(N) 降为了 O(logN)。</li>
<li>它使用双向链表来保存就绪的事件。所有添加到红黑树上的事件都会与设备 (网卡) 驱动程序建立回调关系，当相应的事件发生时会调用这个回调方法，回调方法会把事件放入双向链表中。</li>
<li>返回时返回的是就绪事件（双向链表）而不是所有事件，既减少了内核到用户空间的拷贝数据量，又省了用户程序筛选就绪事件的时间。</li>
<li>相比 select/poll 的水平触发模式，epoll 也支持边沿触发模式。即用户可以选择到底是接受所有就绪的事件（水平触发），还是只接受上次检查以后新就绪的事件（边沿触发）。</li>
</ul>
<h2 id="Java-中的-NIO-模型"><a href="#Java-中的-NIO-模型" class="headerlink" title="Java 中的 NIO 模型"></a>Java 中的 NIO 模型</h2><p>Java 中的 NIO 模型选用了事件驱动的 I/O 复用模型。事实上，在 Linux 上 Java 的 NIO 就是基于 select,poll,epoll 来实现的（Linux 2.6 之前是 select、poll，2.6 之后是 epoll）。</p>
<p>在 Java 的 NIO 中，有 4 类事件：读就绪（OP_READ），写就绪（OP_WRITE），收到请求（仅服务端有效，OP_ACCEPT），发出请求（仅客户端有效，OP_CONNECT）。我们需要注册当这几个事件到来的时候所对应的处理器。然后在合适的时机告诉事件选择器：我对这个事件感兴趣。对于写操作，就是写不出去的时候对写事件感兴趣；对于读操作，就是完成连接和系统没有办法承载新读入的数据的时；对于 accept，一般是服务器刚启动的时候；而对于 connect，一般是 connect 失败需要重连或者直接异步调用 connect 的时候。新事件到来的时候，会在 selector 上注册标记位，标示可读、可写或者有连接到来。编程范式（伪代码）一般如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//处理器抽象接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ChannelHandler</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelReadable</span><span class="params">(Channel channel)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelWritable</span><span class="params">(Channel channel)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Channel</span></span>&#123;</span><br><span class="line">    Socket socket;</span><br><span class="line">    Event event;<span class="comment">//读，写或者连接</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Map&lt;Channel，ChannelHandler&gt; handlerMap;<span class="comment">//所有 channel 的对应事件处理器</span></span><br><span class="line"><span class="comment">//IO 线程主循环:</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IoThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Channel channel;</span><br><span class="line">        <span class="keyword">while</span>(channel=Selector.select())&#123;<span class="comment">//选择就绪的事件和对应的连接</span></span><br><span class="line">            <span class="keyword">if</span>(channel.event==accept)&#123;</span><br><span class="line">                registerNewChannelHandler(channel);<span class="comment">//如果是新连接，则注册一个新的读写处理器</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(channel.event==write)&#123;</span><br><span class="line">                getChannelHandler(channel).channelWritable(channel);<span class="comment">//如果可以写，则执行写事件</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(channel.event==read)&#123;</span><br><span class="line">                getChannelHandler(channel).channelReadable(channel);<span class="comment">//如果可以读，则执行读事件</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Buffer-的选择"><a href="#Buffer-的选择" class="headerlink" title="Buffer 的选择"></a>Buffer 的选择</h3><p>Java 中的 NIO 还有一个特点是面向缓冲区的。这一特性其实在传统 IO 中就有用到，这里不再赘述。但是 Buffer 的选择也是一个值得注意的地方。</p>
<p>通常情况下，操作系统的一次写操作分为两步： 1. 将数据从用户空间拷贝到系统空间。 2. 从系统空间往网卡写。同理，读操作也分为两步： ① 将数据从网卡拷贝到系统空间； ② 将数据从系统空间拷贝到用户空间。</p>
<p>对于 NIO 来说，缓存的使用可以使用 DirectByteBuffer 和 HeapByteBuffer。如果使用了 DirectByteBuffer，一般来说可以减少一次系统空间到用户空间的拷贝。但 Buffer 创建和销毁的成本更高，更不宜维护，通常会用内存池来提高性能。如果数据量比较小的中小应用情况下，可以考虑使用 heapBuffer；反之可以用 directBuffer。</p>
<p>使用 NIO != 高性能，当连接数 &lt;1000，并发程度不高或者局域网环境下 NIO 并没有显著的性能优势。</p>
<p>NIO 并没有完全屏蔽平台差异，它仍然是基于各个操作系统的 I/O 系统实现的，差异仍然存在。使用 NIO 做网络编程构建事件驱动模型并不容易，陷阱重重。</p>
<p>推荐大家使用成熟的 NIO 框架，如 Netty，MINA 等。解决了很多 NIO 的陷阱，并屏蔽了操作系统的差异，有较好的性能和编程模型。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后总结一下 Java 中的 NIO 为我们带来了什么：</p>
<ul>
<li>非阻塞 I/O，I/O 读写不再阻塞，而是返回 0</li>
<li>避免多线程，单个线程可以处理多个任务</li>
<li>事件驱动模型</li>
<li>基于 block 的传输，通常比基于流的传输更高效</li>
<li>IO 多路复用大大提高了 Java 网络应用的可伸缩性和实用性</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2019/01/09/Java-NIO 浅析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Java-线程池浅析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/15/Java-线程池浅析/">Java 线程池浅析</a>
    </h1>
  

        
        <a href="/2018/09/15/Java-线程池浅析/" class="archive-article-date">
  	<time datetime="2018-09-15T05:58:26.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-09-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>Java 中的线程池是运用场景最多的并发框架，几乎所有需要异步或并发执行任务的程序都可以使用线程池。在开发过程中，合理地使用线程池能够带来 3 个好处。</p>
<ul>
<li><strong>降低资源消耗</strong>。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li>
<li><strong>提高响应速度</strong>。当任务到达时，任务可以不需要等到线程创建就能立即执行。</li>
<li><strong>提高线程的可管理性</strong>。线程是稀缺资源，如果无限制地创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一分配、调优和监控。</li>
</ul>
<p>线程池的继承关系如下图：</p>
<p><img src="/2018/09/15/Java-线程池浅析/线程池继承关系.png"></p>
<p>线程池最顶层是<em>Executor</em>，这是只有一个 execute 方法的接口，也是整个 Executor 框架的顶层接口，所有 Executor 框架的组件都要实现这个接口。</p>
<p><em>ExecutorService</em>继承了 Executor，在此基础上增加了 submit(Runnable) 和 submit(Callable<t>)，表示任务的提交，Runnable 和 Callable<t> 的区别在于 Callable 的 call() 方法有返回值，而 Runnable 的 run 没有。</t></t></p>
<p><em>ThreadPoolExecutor</em>是线程池的核心实现类，大部分线程池的功能都在这个类中被定义，它有多个参数和构造函数，根据不同的构造参数可以实现不同功能的线程池。线程池的参数会在下文详细介绍。</p>
<p><em>Executors</em>是 ThreadPoolExecutor 的工厂类，封装了一些常用的线程池，具体类型也会在下文详细介绍。</p>
<h2 id="线程池基本概念"><a href="#线程池基本概念" class="headerlink" title="线程池基本概念"></a>线程池基本概念</h2><h3 id="创建一个线程池"><a href="#创建一个线程池" class="headerlink" title="创建一个线程池"></a>创建一个线程池</h3><p>我们可以通过 ThreadPoolExecutor 来创建一个线程池：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ThreadPoolExecutor(corePoolSize,maximumPoolSize,keepAliveTime,unit,workQueue,ThreadFactory,RejectedExecutionHandler)</span><br></pre></td></tr></table></figure>
<p>线程池的构造函数中需要接收 7 个参数，它们分别是：</p>
<ul>
<li>corePoolSize 核心线程数，指保留的线程池大小（不超过 maximumPoolSize 值时，线程池中最多有 corePoolSize 个线程工作） </li>
<li>maximumPoolSize 指的是线程池的最大大小（线程池中最大有 maximumPoolSize 个线程可运行）</li>
<li>keepAliveTime 指的是空闲线程结束的超时时间（当一个线程不工作时，过 keepAliveTime 长时间将停止该线程）</li>
<li>unit 是一个枚举，表示 keepAliveTime 的单位（有 NANOSECONDS, MICROSECONDS, MILLISECONDS, SECONDS, MINUTES, HOURS, DAYS，7 个可选值）</li>
<li>workQueue 表示存放任务的队列（存放需要被线程池执行的线程队列）。它的类型是 BlockingQueue<runnable> 就是阻塞队列，有关阻塞队列的内容可以参考这篇<a href="www.huzb.me">《阻塞队列源码阅读》</a></runnable></li>
<li>threadFactory 是一个线程工厂，负责线程的创建，一般会使用默认的 Executors.defaultThreadFactory()。</li>
<li>handler 拒绝策略（添加任务失败后如何处理该任务）</li>
</ul>
<h3 id="线程池的运行策略"><a href="#线程池的运行策略" class="headerlink" title="线程池的运行策略"></a>线程池的运行策略</h3><p>线程池刚创建时，里面没有一个线程。任务队列是作为参数传进来的。我们可以使用<em>execute()</em>方法提交任务到线程池：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>也可以使用<em>submit()</em>方法提交任务到线程池：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Future future = executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>区别在于 submit() 会返回一个 Future 对象，通过这个 Future 对象可以判断任务是否执行成功，并且可以通过 Future 的 get() 方法来获取返回值。另外继承了 ExecutorService 接口的 ScheduledExecutorService 还可以使用<em>schedule()</em>方法来提交一个定时任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">//TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<p>上面代码就会在 1 秒后执行我们的定时任务。无论是 submit() 还是 schedule()，其底层最后都会调用 execute() 来提交执行任务。不过，就算队列里面有任务，线程池也不会马上执行它们。</p>
<p>当添加一个任务时，线程池会做如下判断：</p>
<ul>
<li>如果正在运行的线程数量小于 corePoolSize，那么马上创建线程运行这个任务；</li>
<li>如果正在运行的线程数量大于或等于 corePoolSize，那么将这个任务放入队列；</li>
<li>如果这时候队列满了，而且正在运行的线程数量小于 maximumPoolSize，那么还是要创建线程运行这个任务；</li>
<li>如果队列满了，而且正在运行的线程数量大于或等于 maximumPoolSize，那么线程池会调用 reject()，这个方法会调用 handler.rejectedExecution() 方法，根据不同的 handler 策略会有不同的处理方式。</li>
</ul>
<p>当一个线程完成任务时，它会从队列中取下一个任务来执行。</p>
<p>当一个线程无事可做，超过一定的时间（keepAliveTime）时，线程池会判断，如果当前运行的线程数大于 corePoolSize，那么这个线程就被停掉。所以线程池的所有任务完成后，它最终会收缩到 corePoolSize 的大小。</p>
<h3 id="线程池的拒绝策略"><a href="#线程池的拒绝策略" class="headerlink" title="线程池的拒绝策略"></a>线程池的拒绝策略</h3><p>上面提到任务添加失败后，线程池会调用 reject() 方法，这个方法会调用 handler.rejectedExecution() 方法，根据不同的 handler 策略会有不同的处理方式。线程池中预设有以下几种处理方式：</p>
<ul>
<li>AbortPolicy：为 Java 线程池默认的阻塞策略，不执行此任务，而且直接抛出一个运行时异常，切记 ThreadPoolExecutor.execute 需要 try catch，否则程序会直接退出。</li>
<li>DiscardPolicy：直接抛弃，任务不执行，空方法。</li>
<li>DiscardOldestPolicy：从队列里面抛弃 head 的一个任务，并再次 execute 此 task。</li>
<li>CallerRunsPolicy：还给原线程自己执行，会阻塞入口。</li>
<li>用户自定义拒绝策略：实现 RejectedExecutionHandler，并自己定义策略模式。</li>
</ul>
<h3 id="关闭线程池"><a href="#关闭线程池" class="headerlink" title="关闭线程池"></a>关闭线程池</h3><p>Java 线程池提供了两个方法用于关闭一个线程池，一个是 shutdownNow()，另一个是 shutdown()。我们可以看一下这两个方法的声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>这两个方法的区别在于：</p>
<ul>
<li>shutdown()：当线程池调用该方法时，线程池的状态则立刻变成 SHUTDOWN 状态。我们不能再往线程池中添加任何任务，否则将会抛出 RejectedExecutionException 异常；但是，此时线程池不会立刻退出，直到添加到线程池中的任务都已经处理完成后才会退出。</li>
<li>shutdownNow()：当执行该方法，线程池的状态立刻变成 STOP 状态，并试图停止所有正在执行的线程，不再处理还在池队列中等待的任务，并以返回值的形式返回那些未执行的任务。此方法会通过调用 Thread.interrupt() 方法来试图停止正在运行的 Worker 线程，但是这种方法的作用有限，如果线程中没有 sleep 、wait、Condition、定时锁等操作时，interrupt() 方法是无法中断当前的线程的。所以，shutdownNow() 并不代表线程池就一定立即就能退出，可能必须要等待所有正在执行的任务都执行完成了才能退出。</li>
</ul>
<h3 id="Executors-提供的线程池"><a href="#Executors-提供的线程池" class="headerlink" title="Executors 提供的线程池"></a>Executors 提供的线程池</h3><p>ThreadPoolExecutor 提供的线程创建方式参数太多，对开发人员并不友好。因此 Java 在 Executors 类中封装了几种常用的线程池，它们分别是：</p>
<ul>
<li><strong>Executors.newCachedThreadPool</strong> 这是一个会根据需要创建线程的线程池，它的 corePoolSize 被设置为 0，maximumPoolSize 被设置为 Integer.MAX_VALUE，KeepAliveTime 被设置为 60s，使用没有容量的 SynchronousQueue 作为线程池的工作队列。这就意味着，线程池中没有固定的线程数量，任何一个任务被提交时，线程池都会为它创建或者分配一个线程；而任何一个线程空闲时间超过 60s，都会关闭它。使用该线程池时要注意主线程提交任务的速度和线程池处理任务的速度，若提交速度大于处理速度，CachedThreadPool 会因为创建过多线程而耗尽 CPU 和内存资源。该线程池的吞吐量在几种预设线程池中是最大的。</li>
<li><strong>Executors.newFixedThreadPool</strong> 这是被称为可重用固定线程数的线程池，它的 corePoolSize 等于 maximumPoolSize，KeepAliveTime 被设置为 0，使用最大长度的有界队列 LinkedBlockingQueue（队列容量为 Integer.MAX_VALUE）作为工作队列，这也意味着 FixedThreadPool 运行稳定后线程数量是不变的，且所有任务都会进入工作队列，不会拒绝任务。</li>
<li><strong>Executors.newSingleThreadExecutor</strong> 这是一个只有一个工作线程的线程池，它的 corePoolSize 和 maximumPoolSize 都被设置为 1，其它参数与 FixedThreadPool 相同，可以把它理解为 newFixedThreadPool(1)，线程执行完任务后会无限反复从 LinkedBlockingQueue 获取任务来执行。</li>
<li><strong>Executors.newScheduledThreadPool</strong> 这是一个可以定时执行的线程池，它的 maximumPoolSize 被设置为 Integer.MAX_VALUE，KeepAliveTime 被设置为 10ms，使用 DelayedWorkQueue 作为阻塞队列，这是一个类似于 DelayedQueue 和 PriorityBlockingQueue 的阻塞队列，每次会取出队列中执行时间最早的任务，如果没有到执行之间，则 await 两者的差值，以此来达到定时执行的目的。同时 newScheduledThreadPool 的 scheduleAtFixedRate 和 scheduleWithFixedRate 方法还可以实现周期执行的功能。两者都是依靠给 ScheduledFutureTask（newScheduledThreadPool 中被执行的任务）设置下一次执行时间来实现的。区别在于 scheduleAtFixedRate 中下次执行时间=本次开始时间+间隔时间，而 scheduleWithFixedRate 中下次执行时间=本次结束时间+间隔时间。</li>
</ul>
<h2 id="线程池代码分析"><a href="#线程池代码分析" class="headerlink" title="线程池代码分析"></a>线程池代码分析</h2><h3 id="线程池的属性字段"><a href="#线程池的属性字段" class="headerlink" title="线程池的属性字段"></a>线程池的属性字段</h3><p>在开始深入了解 ThreadPoolExecutor 代码之前, 我们先来简单地看一下 ThreadPoolExecutor 类中到底有哪些重要的字段。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这个是一个复用字段, 它复用地表示了当前线程池的状态, 当前线程数信息.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用于存放提交到线程池中, 但是还未执行的那些任务.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程池内部锁, 对线程池内部操作加锁, 防止竞态条件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个 Set 结构, 包含了当前线程池中的所有工作线程.</span></span><br><span class="line">    <span class="comment">// 对 workers 字段的操作前, 需要获取到这个锁.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 条件变量, 用于支持 awaitTermination 操作</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition termination = mainLock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录线程池中曾经到达过的最大的线程数.</span></span><br><span class="line">    <span class="comment">// 这个字段在获取 mainLock 锁的前提下才能操作.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> largestPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录已经完成的任务数. 仅仅当工作线程结束时才更新此字段.</span></span><br><span class="line">    <span class="comment">// 这个字段在获取 mainLock 锁的前提下才能操作.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> completedTaskCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程工厂. 当需要一个新的线程时, 这里生成.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 任务提交失败后的处理 handler</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空闲线程的等待任务时间, 以纳秒为单位.</span></span><br><span class="line">    <span class="comment">// 当当前线程池中的线程数大于 corePoolSize 时, </span></span><br><span class="line">    <span class="comment">// 或者 allowCoreThreadTimeOut 为真时, 线程才有 idle 等待超时时间, </span></span><br><span class="line">    <span class="comment">// 如果超时则此线程会停止.; </span></span><br><span class="line">    <span class="comment">// 反之线程会一直等待新任务到来.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认为 false.</span></span><br><span class="line">    <span class="comment">// 当为 false 时, keepAliveTime 不起作用, 线程池中的 core 线程会一直存活, </span></span><br><span class="line">    <span class="comment">// 即使这些线程是 idle 状态.</span></span><br><span class="line">    <span class="comment">// 当为 true 时, core 线程使用 keepAliveTime 作为 idle 超时</span></span><br><span class="line">    <span class="comment">// 时间来等待新的任务.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心线程数.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最大线程数.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maximumPoolSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ThreadPoolExecutor 中, 使用到 ctl 这个字段来维护线程池中当前线程数和线程池的状态。ctl 是一个 AtomicInteger 类型, 它的低 29 位用于存放当前的线程数，因此一个线程池在理论上最大的线程数是 536870911；高 3 位是用于表示当前线程池的状态，其中高三位的值和状态对应如下：</p>
<ul>
<li>111: <strong>RUNNING</strong> 此时能够接收新任务，以及对已添加的任务进行处理。<br>状态切换：线程池初始化时就是 RUNNING 状态。</li>
<li>000: <strong>SHUTDOWN</strong> 此时不接收新任务，但能处理已添加的任务。<br>状态切换：调用线程池的 shutdown() 接口时，线程池由 RUNNING -&gt; SHUTDOWN。</li>
<li>001: <strong>STOP</strong> 此时不接收新任务，不处理已添加的任务，并且会中断正在处理的任务。<br>状态切换：调用线程池的 shutdownNow() 接口时，线程池由 (RUNNING or SHUTDOWN ) -&gt; STOP。</li>
<li>010: <strong>TIDYING</strong> 当所有的任务已终止，ctl 记录的”任务数量”为 0，线程池会变为 TIDYING 状态。当线程池变为 TIDYING 状态时，会执行钩子函数 terminated()。terminated() 在 ThreadPoolExecutor 类中是空的，若用户想在线程池变为 TIDYING 时，进行相应的处理；可以通过重载 terminated() 函数来实现。<br>状态切换：当线程池在 SHUTDOWN 状态下，阻塞队列为空并且线程池中执行的任务也为空时，就会由 SHUTDOWN -&gt; TIDYING。当线程池在 STOP 状态下，线程池中执行的任务为空时，就会由 STOP -&gt; TIDYING。</li>
<li>011: <strong>TERMINATED</strong> 线程池彻底终止，就变成 TERMINATED 状态。<br>状态切换：线程池处在 TIDYING 状态时，执行完 terminated() 之后，就会由 TIDYING -&gt; TERMINATED。 </li>
</ul>
<h3 id="提交任务到线程池"><a href="#提交任务到线程池" class="headerlink" title="提交任务到线程池"></a>提交任务到线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码有三个步骤，首先第一步是检查当前线程池的线程数是否小于 corePoolSize，如果小于，那么由我们前面提到的规则，线程池会创建一个新的线程来执行此任务，因此在第一个 if 语句中，会调用 addWorker(command, true) 来创建一个新 Worker 线程，并执行此任务。</p>
<p>如果当前线程池的线程数不小于 corePoolSize，那么会尝试将此任务插入到工作队列中，即 workQueue.offer(command)。当插入到 workQueue 成功后，我们还需要再次检查一下此时线程池是否还是 RUNNING 状态，如果不是的话就会将原来插入队列中的那个任务删除，然后调用 reject 方法拒绝此任务的提交；接着考虑到在我们插入任务到 workQueue 中的同时，如果此时线程池中的线程都执行完毕并终止了，在这样的情况下刚刚插入到 workQueue 中的任务就永远不会得到执行了。为了避免这样的情况，因此我们要再次检查一下线程池中的线程数，如果为零，则调用 addWorker(null, false) 来添加一个线程。</p>
<p>最后如果任务插入到工作队列失败了，就会直接调用 addWorker(command, false) 来新开一个线程。如果失败了，那么我们就知道线程池已经关闭或者饱和了，就拒绝这次添加。</p>
<h3 id="关于-addWorker-方法"><a href="#关于-addWorker-方法" class="headerlink" title="关于 addWorker 方法"></a>关于 addWorker 方法</h3><p>前面我们大体分析了一下 execute 提交任务的流程，不过省略了一个关键步骤，即 addWorker 方法。现在我们来看看这个方法里究竟发生了什么。</p>
<p>首先看一下 addWorker 方法的签名：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span></span></span><br></pre></td></tr></table></figure></p>
<p>这个方法接收两个参数，第一个是一个 Runnable 类型的参数，一般来说是我们调用 execute 方法所传输的参数，不过也有可能是 null 值，这样的情况我们在前面一小节中也见到过。<br>那么第二个参数是做什么的呢？第二个参数是一个 boolean 类型的变量，它的作用是标识是否使用 corePoolSize 属性。我们知道，ThreadPoolExecutor 中，有一个 corePoolSize 属性，用于规定线程池中的核心线程数。那么当 core 这个参数是 true 时，则表示在添加新任务时，需要考虑到 corePoolSzie 的影响（例如如果此时线程数已经大于 corePoolSize 了，那么就不能再添加新线程了）；当 core 为 false 时，就不考虑 corePoolSize 的影响，而是以 maximumPoolSize 代替 corePoolSize 来做判断条件。</p>
<p>然后是 addWorker 的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> c = ctl.get();;) &#123;</span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (runStateAtLeast(c, SHUTDOWN)</span><br><span class="line">            &amp;&amp; (runStateAtLeast(c, STOP)</span><br><span class="line">                || firstTask != <span class="keyword">null</span></span><br><span class="line">                || workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// 当 core 为真, 那么就判断当前线程是否大于 corePoolSize</span></span><br><span class="line">            <span class="comment">// 当 core 为假, 那么就判断当前线程数是否大于 maximumPoolSize</span></span><br><span class="line">            <span class="comment">// 这里的 for 循环是一个自旋 CAS(CompareAndSwap) 操作, 用于确保多线程环境下的正确性</span></span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c)</span><br><span class="line">                &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="keyword">if</span> (runStateAtLeast(c, SHUTDOWN))</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">    Worker w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">        <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">                <span class="keyword">if</span> (isRunning(c) ||</span><br><span class="line">                    (runStateLessThan(c, STOP) &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先在 addWorker 的一开始，有一个 for 循环，用于判断当前是否可以添加新的 Worker 线程。它的逻辑如下：</p>
<ul>
<li>如果传入的 core 为真，那么判断当前的线程数是否大于 corePoolSize，如果大于，则不能新建 Worker 线程，返回 false。</li>
<li>如果传入的 core 为假，那么判断当前的线程数是否大于 maximumPoolSize，如果大于，则不能新建 Worker 线程，返回 false。</li>
</ul>
<p>如果条件符合，那么在 for 循环内，又有一个自旋 CAS 更新逻辑，用于递增当前的线程数，即 compareAndIncrementWorkerCount(c)，这个方法会原子地更新 ctl 的值，将当前线程数的值+1。addWorker 接下来有一个 try…finally 语句块，这里就是实际上的创建线程、启动线程、添加线程到线程池中的工作了。首先可以看到 w = new Worker(firstTask)；这里是实例化一个 Worker 对象，这个类其实就是 ThreadPoolExecutor 中对工作线程的封装。Worker 类继承于 AbstractQueuedSynchronizer 并实现了 Runnable 接口，我们来看一下它的构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Worker(Runnable firstTask) &#123;</span><br><span class="line">    setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">    <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">    <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它会把我们提交的任务（firstTask）设置为自己的内部属性 firstTask，然后使用 ThreadPoolExecutor 中的 threadFactory 来创建一个新的线程，并保存在 thread 字段中，而且注意到，创建线程时，我们传递给新线程的 Runnable 其实是 Worker 对象本身（this），因此当这个线程启动时，实际上运行的是 Worker.run() 中的代码。</p>
<p>回过头来再看一下 addWorker 方法。当创建好 Worker 线程后，就会将这个 worker 线程存放在 workers 这个 HashSet<worker> 类型的字段中。而且注意到，正如我们在前面所提到的，mainLock 是 ThreadPoolExecutor 的内部锁，我们对 ThreadPoolExecutor 中的字段进行操作时，为了保证线程安全，需要在获取到 mainLock 的前提下才能操作。</worker></p>
<p>最后，我们可以看到，在 addWorker 方法的最后，调用了 t.start()；来真正启动这个新建的线程。</p>
<h3 id="任务的分配与调度"><a href="#任务的分配与调度" class="headerlink" title="任务的分配与调度"></a>任务的分配与调度</h3><p>线程池在执行完 firstTask 后并不会立即销毁，而是可以根据情况复用。线程的复用就涉及到任务的分配与调度。Java 线程池的调度方式很简单，就是执行完之后从 workQueue 中拿出下一个任务，如果获取到了任务，那就再次执行。</p>
<p>前一小节中，我们看到 addWorker 中会新建一个 Worker 对象来代表一个 worker 线程，接着会调用线程的 start() 来启动这个线程，我们也提到了当启动这个线程后，会运行到 Worker 中的 run 方法，我们来看一下 Worker.run 具体的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    runWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Worker.run 方法很简单，只是调用了 ThreadPoolExecutor.runWorker 方法而已。runWorker 方法比较关键，它是整个线程池任务分配的核心：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">    Thread wt = Thread.currentThread();</span><br><span class="line">    Runnable task = w.firstTask;</span><br><span class="line">    w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="keyword">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>runWorker 方法是整个工作线程的核心循环，在这个循环中，工作线程会不断的从 workerQuque 中获取新的 task，然后执行它。我们注意到在 runWorker 一开始，有一个 w.unlock()，咦, 这是为什么呢? 其实这是 Worker 类玩的一个小把戏。回想一下，Worker 类继承于 AQS 并实现了 Runnable 接口，它的构造器如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Worker(Runnable firstTask) &#123;</span><br><span class="line">    setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">    <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">    <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>setState(-1) 方法是 AQS 提供的，初始化 Worker 时，会先设置 state 为 -1，根据注释，这样做的原因是为了抑制工作线程的 interrupt 信号，直到此工作线程开始执行 task。那么在 addWorker 中的 w.unlock() 就是允许 Worker 的 interrupt 信号。</p>
<p>接着在 addWorker 中会进入一个 while 循环，在这里此工作线程会不断地从 workQueue 中取出一个任务，然后调用 task.run() 来执行这个任务，因此就执行到了用户所提交的 Runnable 中的 run() 方法了。</p>
<h3 id="工作线程的-idle-超时处理"><a href="#工作线程的-idle-超时处理" class="headerlink" title="工作线程的 idle 超时处理"></a>工作线程的 idle 超时处理</h3><p>工作线程的 idle 超出处理在底层依赖于 BlockingQueue 带超时的 poll 方法，即工作线程会不断地从 workQueue 这个 BlockingQueue 中获取任务，如果 allowCoreThreadTimeOut 字段为 true，或者当前的工作线程数大于 corePoolSize，那么线程的 idle 超时机制就生效了，此时工作线程会以带超时的 poll 方式从 workQueue 中获取任务。当超时了还没有获取到任务，那么我们就知道此线程已经到达 idle 超时时间了，就终止此工作线程。具体源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">        <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedOut = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从源码中就可以看到，一开始会判断当前的线程池状态，如果不是 SHUTDOWN 或 STOP 之类的状态，那么接着获取当前的工作线程数，然后判断工作线程数量是否已经大于了 corePoolSize。当 allowCoreThreadTimeOut 字段为 true，或者当前的工作线程数大于 corePoolSize，那么线程的 idle 超时机制就生效，此时工作线程会以带超时的 workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) 方式从 workQueue 中获取任务；反之会以 workQueue.take() 方式阻塞等待任务，直到获取一个新的任务。当从 workQueue 获取新任务超时时，会调用 compareAndDecrementWorkerCount 将当前的工作线程数-1，并返回 null。getTask 方法返回 null 后， runWorker 中的 while 循环自然也就结束了，因此也导致了 runWorker 方法的返回，最后自然整个工作线程的 run() 方法执行完毕，工作线程自然就终止了。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/09/15/Java-线程池浅析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Java-阻塞队列浅析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/03/Java-阻塞队列浅析/">Java 阻塞队列浅析</a>
    </h1>
  

        
        <a href="/2018/09/03/Java-阻塞队列浅析/" class="archive-article-date">
  	<time datetime="2018-09-03T13:58:36.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-09-03</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>阻塞队列（BlockingQueue）是一个支持两个附加操作的队列。这两个附加的操作是：在队列为空时，获取元素的线程会等待队列变为非空。当队列满时，存储元素的线程会等待队列可用。阻塞队列常用于生产者和消费者的场景，生产者是往队列里添加元素的线程，消费者是从队列里拿元素的线程。阻塞队列就是生产者存放元素的容器，而消费者也只从容器里拿元素。</p>
<h2 id="一、Java-中的阻塞队列"><a href="#一、Java-中的阻塞队列" class="headerlink" title="一、Java 中的阻塞队列"></a>一、Java 中的阻塞队列</h2><p>JDK7 中提供了 7 个阻塞队列，分别是：</p>
<ul>
<li>ArrayBlockingQueue ：一个由数组结构组成的有界阻塞队列。</li>
<li>LinkedBlockingQueue ：一个由链表结构组成的有界阻塞队列。</li>
<li>PriorityBlockingQueue ：一个支持优先级排序的无界阻塞队列。</li>
<li>DelayQueue：一个使用优先级队列实现的无界阻塞队列。</li>
<li>SynchronousQueue：一个不存储元素的阻塞队列。</li>
<li>LinkedTransferQueue：一个由链表结构组成的无界阻塞队列。</li>
<li>LinkedBlockingDeque：一个由链表结构组成的双向阻塞队列。</li>
</ul>
<h3 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h3><p>ArrayBlockingQueue 是一个用数组实现的有界阻塞队列。此队列按照先进先出（FIFO）的原则对元素进行排序。默认情况下不保证访问者公平的访问队列，所谓公平访问队列是指阻塞的所有生产者线程或消费者线程，当队列可用时，可以按照阻塞的先后顺序访问队列，即先阻塞的生产者线程，可以先往队列里插入元素，先阻塞的消费者线程，可以先从队列里获取元素。ArrayBlockingQueue 的公平性是由 ReentrantLock 实现的，公平模式下的 ReentrantLock 在有一个线程申请锁时，会检测 AQS 队头是否有等待的线程，如果有则执行队头的线程，而非公平模式下则不会进行检测。通常情况下为了保证公平性会降低吞吐量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">this</span>.items = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">        lock = <span class="keyword">new</span> ReentrantLock(fair); <span class="comment">// ReentrantLock 实现了公平策略</span></span><br><span class="line">        notEmpty = lock.newCondition();</span><br><span class="line">        notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h3><p>LinkedBlockingQueue 是一个用链表实现的有界阻塞队列。此队列的默认最大长度为 Integer.MAX_VALUE。此队列按照先进先出的原则对元素进行排序。</p>
<h3 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h3><p>PriorityBlockingQueue 是一个支持优先级的无界队列，底层由数组实现，数组最大长度为 Integer.MAX_VALUE - 8（所以并不是真的无界），默认数组大小为 11，如果元素超过数组大小，数组会进行扩容，具体扩容的大小，在数组长度小于 64 时+2，大于 64 时变为 150%，当数组扩容后大小超过 Integer.MAX_VALUE - 8 时，不会再用 150%扩容，而是使用+1 的方式扩容。最后若+1 的方式扩容的数组大小也超过了 Integer.MAX_VALUE - 8，则报 OutOfMemoryError()。默认情况下元素采取自然顺序，排列采用二叉树最小堆实现（所以有序不是数据存储的有序，而是取出数据的有序），也可以通过比较器 comparator 来指定元素的排序规则。元素按照升序排列。</p>
<h3 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h3><p>DelayQueue 是一个支持延时获取元素的无界阻塞队列。队列使用 PriorityQueue，PriorityQueue 和 PriorityBlockingQueue 一样都是使用小顶堆实现的，唯一的区别在于 PriorityQueue 是非线程安全的，而 PriorityBlockingQueue 是线程安全的。队列中的元素必须实现 Delayed 接口（该接口有两个方法<em>getDelay()</em>和<em>compareTo()</em>），在创建元素时可以指定多久才能从队列中获取当前元素。只有在延迟期满时才能从队列中提取元素。我们可以将 DelayQueue 运用在以下应用场景：</p>
<ul>
<li>缓存系统的设计：可以用 DelayQueue 保存缓存元素的有效期，使用一个线程循环查询 DelayQueue，一旦能从 DelayQueue 中获取元素时，表示缓存有效期到了。</li>
<li>定时任务调度。使用 DelayQueue 保存当天将会执行的任务和执行时间，一旦从 DelayQueue 中获取到任务就开始执行，从比如 TimerQueue 就是使用 DelayQueue 实现的。</li>
</ul>
<h4 id="compareTo-接口实现示例"><a href="#compareTo-接口实现示例" class="headerlink" title="compareTo() 接口实现示例"></a>compareTo() 接口实现示例</h4><p>队列中的 Delayed 必须实现 compareTo 来指定元素的顺序。比如让延时时间最长的放在队列的末尾。实现代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed other)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (other == <span class="keyword">this</span>) <span class="comment">// compare zero ONLY if same object</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> (other <span class="keyword">instanceof</span> ScheduledFutureTask) &#123;</span><br><span class="line">                ScheduledFutureTask x = (ScheduledFutureTask)other;</span><br><span class="line">                <span class="keyword">long</span> diff = time - x.time;</span><br><span class="line">                <span class="keyword">if</span> (diff &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span> (sequenceNumber &lt; x.sequenceNumber)&#123;</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">long</span> d = (getDelay(TimeUnit.NANOSECONDS) - other.getDelay(TimeUnit.NANOSECONDS));</span><br><span class="line">           <span class="keyword">return</span> (d == <span class="number">0</span>) ? <span class="number">0</span> : ((d &lt; <span class="number">0</span>) ? -<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="getDelay-接口实现示例"><a href="#getDelay-接口实现示例" class="headerlink" title="getDelay() 接口实现示例"></a>getDelay() 接口实现示例</h4><p>getDelay() 可以查询当前元素还需要延时多久，需要在对象创建时传入一个开始时间。以 ScheduledThreadPoolExecutor 里 ScheduledFutureTask 类为例。这个类实现了 Delayed 接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ScheduledFutureTask(Runnable r, V result, <span class="keyword">long</span> ns, <span class="keyword">long</span> period) &#123;</span><br><span class="line">            <span class="keyword">super</span>(r, result);</span><br><span class="line">            <span class="keyword">this</span>.time = ns; <span class="comment">// 这个 time 就是开始时间</span></span><br><span class="line">            <span class="keyword">this</span>.period = period;</span><br><span class="line">            <span class="keyword">this</span>.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后使用 getDelay 可以查询当前元素还需要延时多久，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> unit.convert(time - now(), TimeUnit.NANOSECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后是延时队列的使用，当消费者从队列里获取元素时，如果元素没有达到延时时间，就阻塞当前线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> delay = first.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">   <span class="keyword">return</span> q.poll();</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (leader != <span class="keyword">null</span>)</span><br><span class="line">   available.await();</span><br></pre></td></tr></table></figure></p>
<h3 id="SynchronousQueue"><a href="#SynchronousQueue" class="headerlink" title="SynchronousQueue"></a>SynchronousQueue</h3><p>SynchronousQueue 是一个不存储元素的阻塞队列。每一个 put 操作必须等待一个 take 操作，否则不能继续添加元素。SynchronousQueue 可以看成是一个传球手，负责把生产者线程处理的数据直接传递给消费者线程。队列本身并不存储任何元素，非常适合于传递性场景,比如在一个线程中使用的数据，传递给另外一个线程使用，SynchronousQueue 的吞吐量高于 LinkedBlockingQueue 和 ArrayBlockingQueue。</p>
<h3 id="LinkedTransferQueue"><a href="#LinkedTransferQueue" class="headerlink" title="LinkedTransferQueue"></a>LinkedTransferQueue</h3><p>LinkedTransferQueue 是一个由链表结构组成的无界阻塞 TransferQueue 队列。TransferQueue 队列继承了 BlockingQueue，在 BlockingQueue 的基础上多了 tryTransfer 和 transfer 方法。transfer 会在元素进入阻塞队列前，先判断有没有消费者线程在等待获取，若有，则直接移交；否则将元素插入到队列尾部。tryTransfer 相比 transfer 少了插入的步骤，多了返回值 boolean，即若当前没有消费者线程空闲，则直接返回 false，不会插入到阻塞队列。</p>
<h3 id="LinkedBlockingDeque"><a href="#LinkedBlockingDeque" class="headerlink" title="LinkedBlockingDeque"></a>LinkedBlockingDeque</h3><p>LinkedBlockingDeque 是一个由链表结构组成的双向阻塞队列。所谓双向队列指的你可以从队列的两端插入和移出元素。双端队列因为多了一个操作队列的入口，在多线程同时入队时，也就减少了一半的竞争。相比其他的阻塞队列，LinkedBlockingDeque 多了 addFirst，addLast，offerFirst，offerLast，peekFirst，peekLast 等方法，以 First 单词结尾的方法，表示插入，获取（peek）或移除双端队列的第一个元素。以 Last 单词结尾的方法，表示插入，获取或移除双端队列的最后一个元素。另外插入方法 add 等同于 addLast，移除方法 remove 等效于 removeFirst。但是 take 方法却等同于 takeFirst，不知道是不是 Jdk 的 bug，使用时还是用带有 First 和 Last 后缀的方法更清楚。在初始化 LinkedBlockingDeque 时可以初始化队列的容量，用来防止其再扩容时过渡膨胀。另外双向阻塞队列可以运用在“工作窃取”模式中。</p>
<h2 id="二、阻塞队列的实现原理"><a href="#二、阻塞队列的实现原理" class="headerlink" title="二、阻塞队列的实现原理"></a>二、阻塞队列的实现原理</h2><p>阻塞队列的实现需要满足这样两个要求：如果队列为空，消费者会一直等待；如果队列为满，生产者会一直等待。因此，在实现阻塞队列的方式上，消费者和生产者的通信是必不可少的。JDK 使用 Condition 实现了线程间通信，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull; <span class="comment">// 非满条件，插入元素的时候需要满足这个条件</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty; <span class="comment">// 非空条件，取出元素的时候需要满足这个条件</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始容量必须大于 0</span></span><br><span class="line">        <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="comment">// 初始化数组</span></span><br><span class="line">        <span class="keyword">this</span>.items = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">        <span class="comment">// 初始化可重入锁</span></span><br><span class="line">        lock = <span class="keyword">new</span> ReentrantLock(fair);</span><br><span class="line">        <span class="comment">// 初始化等待条件</span></span><br><span class="line">        notEmpty = lock.newCondition();</span><br><span class="line">        notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        <span class="comment">// 获取可重入锁</span></span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        <span class="comment">// 如果当前线程未被中断，则获取锁</span></span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == items.length) <span class="comment">// 判断元素是否已满</span></span><br><span class="line">                <span class="comment">// 若满，则等待</span></span><br><span class="line">                notFull.await();</span><br><span class="line">            <span class="comment">// 入队列</span></span><br><span class="line">            enqueue(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 可重入锁</span></span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        <span class="comment">// 如果当前线程未被中断，则获取锁，中断会抛出异常</span></span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>) <span class="comment">// 元素数量为 0，即 Object 数组为空</span></span><br><span class="line">                <span class="comment">// 则等待 notEmpty 条件</span></span><br><span class="line">                notEmpty.await();</span><br><span class="line">            <span class="comment">// 出队列</span></span><br><span class="line">            <span class="keyword">return</span> dequeue();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">        <span class="comment">// assert items[putIndex] == null;</span></span><br><span class="line">        <span class="comment">// 获取数组</span></span><br><span class="line">        <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">        <span class="comment">// 将元素放入</span></span><br><span class="line">        items[putIndex] = x;</span><br><span class="line">        <span class="keyword">if</span> (++putIndex == items.length) <span class="comment">// 放入后存元素的索引等于数组长度（表示已满）</span></span><br><span class="line">            <span class="comment">// 重置存索引为 0</span></span><br><span class="line">            putIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 元素数量加 1</span></span><br><span class="line">        count++;</span><br><span class="line">        <span class="comment">// 唤醒在 notEmpty 条件上等待的线程</span></span><br><span class="line">        notEmpty.signal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">        <span class="comment">// assert items[takeIndex] != null;</span></span><br><span class="line">        <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="comment">// 取元素</span></span><br><span class="line">        E x = (E) items[takeIndex];</span><br><span class="line">        <span class="comment">// 该索引的值赋值为 null</span></span><br><span class="line">        items[takeIndex] = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 取值索引等于数组长度</span></span><br><span class="line">        <span class="keyword">if</span> (++takeIndex == items.length)</span><br><span class="line">            <span class="comment">// 重新赋值取值索引</span></span><br><span class="line">            takeIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 元素个数减 1</span></span><br><span class="line">        count--;</span><br><span class="line">        <span class="keyword">if</span> (itrs != <span class="keyword">null</span>) </span><br><span class="line">            itrs.elementDequeued();</span><br><span class="line">        <span class="comment">// 唤醒在 notFull 条件上等待的线程</span></span><br><span class="line">        notFull.signal();</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当我们往队列里插入一个元素时或者取出一个元素时，如果队列不可用，则会调用 Condition 的 await() 方法来阻塞当前线程，该方法主要通过是 LockSupport.park(this);来实现的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        <span class="comment">// 加入等待队列</span></span><br><span class="line">        Node node = addConditionWaiter();</span><br><span class="line">        <span class="comment">// 释放同步状态（锁）</span></span><br><span class="line">        <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">        <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 判断节点是否在同步队列中</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            LockSupport.park(<span class="keyword">this</span>); <span class="comment">// 核心部分，阻塞（和 Object.wait(0) 一样进入无限等待状态）</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 退出 while 循环说明节点被 signal() 调入同步队列中，调用 acquireQueued() 加入同步状态竞争，竞争到锁后从 await() 方法返回</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>函数的核心部分是第 8 行的 LockSupport.park() 函数，该函数表示阻塞当前线程，它的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(Object blocker)</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    setBlocker(t, blocker);</span><br><span class="line">    unsafe.park(<span class="keyword">false</span>, <span class="number">0L</span>); <span class="comment">// 核心部分</span></span><br><span class="line">    setBlocker(t, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>函数的核心部分是第 4 行 unsafe.park() 函数，这是一个 native 方法，park 这个方法会阻塞当前线程，只有以下四种情况中的一种发生时，该方法才会返回。</p>
<ul>
<li>与 park 对应的 unpark 执行或已经执行时。注意：已经执行是指 unpark 先执行，然后再执行的 park。</li>
<li>线程被中断时。</li>
<li>如果参数中的 time 不是零，等待了指定的毫秒数时。</li>
<li>发生异常现象时。这些异常事先无法确定。</li>
</ul>
<p>JVM 中 park 在不同的操作系统使用不同的方式实现，在 linux 下是使用的是系统方法 pthread_cond_wait 实现。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> os::PlatformEvent::park() &#123;</span><br><span class="line">             <span class="keyword">int</span> v ;</span><br><span class="line">         <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        v = _Event ;</span><br><span class="line">         <span class="keyword">if</span> (Atomic::cmpxchg (v<span class="number">-1</span>, &amp;_Event, v) == v) <span class="keyword">break</span> ;</span><br><span class="line">         &#125;</span><br><span class="line">         guarantee (v &gt;= <span class="number">0</span>, <span class="string">"invariant"</span>) ;</span><br><span class="line">         <span class="keyword">if</span> (v == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// Do this the hard way by blocking ...</span></span><br><span class="line">         <span class="keyword">int</span> status = pthread_mutex_lock(_mutex);</span><br><span class="line">         assert_status(status == <span class="number">0</span>, status, <span class="string">"mutex_lock"</span>);</span><br><span class="line">         guarantee (_nParked == <span class="number">0</span>, <span class="string">"invariant"</span>) ;</span><br><span class="line">         ++ _nParked ;</span><br><span class="line">         <span class="keyword">while</span> (_Event &lt; <span class="number">0</span>) &#123;</span><br><span class="line">         status = pthread_cond_wait(_cond, _mutex); <span class="comment">// 核心部分</span></span><br><span class="line">         <span class="comment">// for some reason, under 2.7 lwp_cond_wait() may return ETIME ...</span></span><br><span class="line">         <span class="comment">// Treat this the same as if the wait was interrupted</span></span><br><span class="line">         <span class="keyword">if</span> (status == ETIME) &#123; status = EINTR; &#125;</span><br><span class="line">         assert_status(status == <span class="number">0</span> || status == EINTR, status, <span class="string">"cond_wait"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         -- _nParked ;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">// In theory we could move the ST of 0 into _Event past the unlock(),</span></span><br><span class="line">         <span class="comment">// but then we'd need a MEMBAR after the ST.</span></span><br><span class="line">         _Event = <span class="number">0</span> ;</span><br><span class="line">         status = pthread_mutex_unlock(_mutex);</span><br><span class="line">         assert_status(status == <span class="number">0</span>, status, <span class="string">"mutex_unlock"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         guarantee (_Event &gt;= <span class="number">0</span>, <span class="string">"invariant"</span>) ;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></p>
<p>pthread_cond_wait 是一个多线程的条件变量函数，cond 是 condition 的缩写，字面意思可以理解为线程在等待一个条件发生，这个条件是一个全局变量。这个方法接收两个参数，一个共享变量_cond，一个互斥量_mutex。而 unpark 方法在 linux 下是使用 pthread_cond_signal 实现的。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/09/03/Java-阻塞队列浅析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-CAS 原理和缺陷" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/03/CAS 原理和缺陷/">CAS 原理和缺陷</a>
    </h1>
  

        
        <a href="/2018/09/03/CAS 原理和缺陷/" class="archive-article-date">
  	<time datetime="2018-09-03T12:21:30.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-09-03</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>JDK1.6 以后 JVM 对 synchronize 锁机制作了不少优化，加入了偏向锁和自旋锁，在锁的底层实现中或多或少的都借助了 CAS 操作，其实 Java 中 java.util.concurrent 包的实现也是差不多建立在 CAS 之上，可见 CAS 在 Java 同步领域的重要性。</p>
<p>CAS 是 Compare and Swap 的简写形式，可翻译为：比较并交换。用于在硬件层面上提供<strong>原子性</strong>操作。其实现方式是基于硬件平台的汇编指令，就是说 CAS 是靠硬件实现的，JVM 只是封装了汇编调用。比较是否和给定的数值一致，如果一致则修改，不一致则不修改。</p>
<h2 id="CAS-案例分析"><a href="#CAS-案例分析" class="headerlink" title="CAS 案例分析"></a>CAS 案例分析</h2><p>AtomicInteger 的原子特性就是 CAS 机制的典型使用场景。 其相关的源码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;  </span><br><span class="line">        <span class="keyword">int</span> current = get();  </span><br><span class="line">        <span class="keyword">int</span> next = current + <span class="number">1</span>;  </span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, next))  </span><br><span class="line">            <span class="keyword">return</span> next;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;     </span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AtomicInteger 在没有锁的机制下借助 volatile 原语，保证了线程间的数据是可见的（共享的）。其 get() 方法可以获取最新的内存中的值。</p>
<p>在 incrementAndGet() 的操作中，使用了 CAS 操作，每次从内存中读取最新的数据然后将此数据+1，最终写入内存时，先比较内存中最新的值，同累加之前读出来的值是否一致，不一致则写失败，循环重试直到成功为止。</p>
<p>compareAndSet 的具体实现调用了 unsafe 类的 compareAndSwapInt 方法，它其实是一个 Java Native Interface（简称 JNI）java 本地方法，会根据不同的 JDK 环境调用不同平台的对应 C 实现，下面以 windows 操作系统，X86 处理器的实现为例，这个本地方法在 openjdk 中依次调用的 c++代码为：unsafe.cpp，atomic.cpp 和 atomic_windows_x86.inline.hpp，它的实现代码存在于：openjdk7\hotspot\src\os_cpu\windows_x86\vm\atomic_windows_x86.inline.hpp，下面是相关的代码片段：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Adding a lock prefix to an instruction on MP machine  </span></span><br><span class="line"><span class="comment">// VC++ doesn't like the lock prefix to be on a single line  </span></span><br><span class="line"><span class="comment">// so we can't insert a label after the lock prefix.  </span></span><br><span class="line"><span class="comment">// By emitting a lock prefix, we can define a label after it.  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCK_IF_MP(mp) __asm cmp mp, 0  \  </span></span><br><span class="line">                       __asm je L0      \  </span><br><span class="line">                       __asm _emit <span class="number">0xF0</span> \  </span><br><span class="line">                       __asm L0:  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">inline</span> jint     Atomic::cmpxchg    (jint     exchange_value, <span class="keyword">volatile</span> jint*     dest, jint     compare_value) &#123;  </span><br><span class="line">  <span class="comment">// alternative for InterlockedCompareExchange  </span></span><br><span class="line">  <span class="keyword">int</span> mp = os::is_MP();  </span><br><span class="line">  __asm &#123;  </span><br><span class="line">    mov edx, dest  </span><br><span class="line">    mov ecx, exchange_value  </span><br><span class="line">    mov eax, compare_value  </span><br><span class="line">    LOCK_IF_MP(mp)  </span><br><span class="line">    cmpxchg dword ptr [edx], ecx  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由上面源代码可见在该平台的处理器上 CAS 通过指令 cmpxchg（就是 x86 的比较并交换指令）实现，并且程序会根据当前处理器是否是多处理器 (is_MP) 来决定是否为 cmpxchg 指令添加 lock 前缀 (LOCK_IF_MP)，如果是单核处理器则省略 lock 前缀 (单处理器自身会维护单处理器内的顺序一致性，不需要 lock 前缀提供的内存屏障效果 (而在 JDK9 中，已经忽略了这种判断都会直接添加 lock 前缀，这或许是因为现代单核处理器几乎已经消亡)。关于 Lock 前缀指令：</p>
<ul>
<li>Lock 前缀指令可以通过对总线或者处理器内部缓存加锁，使得其他处理器无法读写该指令要访问的内存区域，因此能保存指令执行的原子性。</li>
<li>Lock 前缀指令将禁止该指令与之前和之后的读和写指令重排序。</li>
<li>Lock 前缀指令将会把写缓冲区中的所有数据立即刷新到主内存中。</li>
</ul>
<p>上面的第 1 点保证了 CAS 操作是一个原子操作，第 2 点和第 3 点所具有的内存屏障效果，保证了 CAS 同时具有 volatile 读和 volatile 写的内存语义（不过一般还是认为 CAS 只具有原子性而不具有可见性，因为底层的处理器平台可能不同）。</p>
<p><strong>关于总线锁定和缓存锁定</strong></p>
<blockquote>
<p>1、早期的处理器只支持通过总线锁保证原子性。所谓总线锁就是使用处理器提供的一个 LOCK＃信号，当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住,那么该处理器可以独占使用共享内存。很显然，这会带来昂贵的开销。<br>2、缓存锁定是改进后的方案。在同一时刻我们只需保证对某个内存地址的操作是原子性即可，但总线锁定把 CPU 和内存之间通信锁住了，这使得锁定期间，其他处理器不能操作其他内存地址的数据，所以总线锁定的开销比较大，最近的处理器在某些场合下使用缓存锁定代替总线锁定来进行优化。缓存锁定是指当两个 CPU 的缓存行同时指向一片内存区域时，如果 A CPU 希望对该内存区域进行修改并使用了缓存锁定，那么 B CPU 将无法访问自己缓存中相应的缓存行，自然也没法访问对应的内存区域，这样就 A CPU 就实现了独享内存。<br>　<br>但是有两种情况下处理器不会使用缓存锁定。第一种情况是：当操作的数据不能被缓存在处理器内部，或操作的数据跨多个缓存行（cache line），则处理器会调用总线锁定。第二种情况是：有些处理器不支持缓存锁定。对于 Inter486 和奔腾处理器，就算锁定的内存区域在处理器的缓存行中也会调用总线锁定。</p>
</blockquote>
<p><strong>关于同样使用 Lock 前缀的 volatile 却无法保证原子性</strong></p>
<blockquote>
<p>volatile 和 cas 都是基于 lock 前缀实现，但 volatile 却无法保证原子性这是因为：Lock 前缀只能保证缓存一致性，但不能保证寄存器中数据的一致性，如果指令在 lock 的缓存刷新生效之前把数据写入了寄存器，那么寄存器中的数据不会因此失效而是继续被使用，就好像数据库中的事务执行失败却没有回滚，原子性就被破坏了。以被 volatile 修饰的 i 作 i++为例，实际上分为 4 个步骤：<br>mov　　　　 0xc(%r10),%r8d ; 把 i 的值赋给寄存器<br>inc　　　　　%r8d　　　　　 ; 寄存器的值+1<br>mov　　　　 %r8d,0xc(%r10) ; 把寄存器的值写回<br>lock addl　　$0x0,(%rsp)　　; 内存屏障，禁止指令重排序，并同步所有缓存<br>　<br>如果两个线程 AB 同时把 i 读进自己的寄存器，此时 B 线程等待，A 线程继续工作，把 i++后放回内存。按照原子性的性质，此时 B 应该回滚，重新从内存中读取 i，但因为此时 i 已经拷贝到寄存器中，所以 B 线程会继续运行，原子性被破坏。<br>　<br>而 cas 没有这个问题，因为 cas 操作对应指令只有一个：<br>lock cmpxchg dword ptr [edx], ecx ;<br>　<br>该指令确保了直接从内存拿数据（ptr [edx]），然后放回内存这一系列操作都在 lock 状态下，所以是原子性的。<br>　<br>总结：volatile 之所以不是原子性的原因是 jvm 对 volatile 语义的实现只是在 volatile 写后面加一个内存屏障，而内存屏障前的操作不在 lock 状态下，这些操作可能会把数据放入寄存器从而导致无法有效同步；cas 能保证原子性是因为 cas 指令只有一个，这个指令从头到尾都是在 lock 状态下而且从内存到内存，所以它是原子性的。</p>
</blockquote>
<h2 id="CAS-缺陷"><a href="#CAS-缺陷" class="headerlink" title="CAS 缺陷"></a>CAS 缺陷</h2><p>1、<strong>ABA 问题</strong>。因为 CAS 需要在操作值的时候检查下值有没有发生变化，如果没有发生变化则更新，但是如果一个值原来是 A，变成了 B，又变成了 A，那么使用 CAS 进行检查时会发现它的值没有发生变化，但是实际上却变化了。ABA 问题的解决思路就是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加一，那么 A－B－A 就会变成 1A - 2B－3A。</p>
<p>从 Java1.5 开始 JDK 的 atomic 包里提供了一个类 AtomicStampedReference 来解决 ABA 问题。这个类的 compareAndSet 方法作用是首先检查当前引用是否等于预期引用，并且当前标志是否等于预期标志，如果全部相等，则以原子方式将该引用和该标志的值设置为给定的更新值。</p>
<p>2、<strong>循环时间长开销大</strong>。自旋 CAS 如果长时间不成功，会给 CPU 带来非常大的执行开销。如果 JVM 能支持处理器提供的 pause 指令那么效率会有一定的提升，pause 指令有两个作用，第一它可以延迟流水线执行指令（de-pipeline），使 CPU 不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零。第二它可以避免在退出循环的时候因内存顺序冲突（memory order violation）而引起 CPU 流水线被清空（CPU pipeline flush），从而提高 CPU 的执行效率。 </p>
<p>3、<strong>只能保证一个共享变量的原子操作</strong>。当对一个共享变量执行操作时，我们可以使用循环 CAS 的方式来保证原子操作，但是对多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候就可以用锁，或者有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如有两个共享变量 i＝2，j=a，合并一下 ij=2a，然后用 CAS 来操作 ij。从 Java1.5 开始 JDK 提供了 AtomicReference 类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行 CAS 操作。 </p>
<p>4、<strong>总线风暴带来的本地延迟</strong>。在多处理架构中，所有处理器会共享一条总线，靠此总线连接主存，每个处理器核心都有自己的高速缓存，各核相对于 BUS 对称分布，这种结构称为“对称多处理器”即 SMP。当主存中的数据同时存在于多个处理器高速缓存的时候，某一个处理器的高速缓存中相应的数据更新之后，会通过总线使其它处理器的高速缓存中相应的数据失效，从而使其重新通过总线从主存中加载最新的数据，大家通过总线的来回通信称为“Cache 一致性流量”，因为总线被设计为固定的“通信能力”，如果 Cache 一致性流量过大，总线将成为瓶颈。而 CAS 恰好会导致 Cache 一致性流量，如果有很多线程都共享同一个对象，当某个核心 CAS 成功时必然会引起总线风暴，这就是所谓的本地延迟。而偏向锁就是为了消除 CAS，降低 Cache 一致性流量。</p>
<p>　<br><strong>关于偏向锁如何消除 CAS</strong></p>
<blockquote>
<p>试想这样一种情况：线程 A：申请锁 - 执行临界区代码 - 释放锁 - 申请锁 - 执行临界区代码 - 释放锁。锁的申请和释放都会执行 CAS，一共执行 4 次 CAS。而在偏向锁中，线程 A：申请锁 - 执行临界区代码 - 比较对象头 - 执行临界区代码。只执行了 1 次 CAS。</p>
</blockquote>
<p><strong>关于总线风暴</strong></p>
<blockquote>
<p>其实也不是所有的 CAS 都会导致总线风暴，这跟 Cache 一致性协议有关，具体参考：<a href="http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot" target="_blank" rel="noopener">http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot</a><br>另外与 SMP 对应还有非对称多处理器架构，现在主要应用在一些高端处理器上，主要特点是没有总线，没有公用主存，每个 Core 有自己的内存。</p>
</blockquote>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/09/03/CAS 原理和缺陷/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-《高性能 MySQL》读书笔记——查询优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/28/《高性能 MySQL》读书笔记——查询优化/">《高性能 MySQL》读书笔记——查询优化</a>
    </h1>
  

        
        <a href="/2018/08/28/《高性能 MySQL》读书笔记——查询优化/" class="archive-article-date">
  	<time datetime="2018-08-28T10:34:21.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-08-28</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>在设计了最优的库表结构、如何建立最好的索引，这些对于高性能来说必不可少。但这些还不够，还需要合理地设计查询。</p>
<h2 id="一、查询执行的基础"><a href="#一、查询执行的基础" class="headerlink" title="一、查询执行的基础"></a>一、查询执行的基础</h2><p>当 MySQL 执行一个查询语句时，会经历以下几个步骤：<br><img src="/2018/08/28/《高性能 MySQL》读书笔记——查询优化/查询执行基础.png"></p>
<ul>
<li>客户端发送一条查询给服务器。</li>
<li>服务器先检查查询缓存，如果命中了缓存，则立刻返回存储在缓存中的结果。否则进入下一阶段。</li>
<li>服务器端进行 SQL 解析、预处理，再由优化器生成对应的执行计划。</li>
<li>MySQL 根据优化器生成的执行计划，调用存储引擎的 API 来执行查询。</li>
<li>将结果返回给客户端。</li>
</ul>
<h2 id="二、MySQL-查询优化器"><a href="#二、MySQL-查询优化器" class="headerlink" title="二、MySQL 查询优化器"></a>二、MySQL 查询优化器</h2><p>MySQL 查询优化器会做大量的工作，这些工作包括但不限于：</p>
<h3 id="1-重新定义关联表的顺序"><a href="#1-重新定义关联表的顺序" class="headerlink" title="1. 重新定义关联表的顺序"></a>1. 重新定义关联表的顺序</h3><p>MySQL 使用一种叫 “嵌套循环关联” 的方式来执行关联查询。顾名思义，这是一种嵌套式的查询。在正常情况下，最左边的表会嵌套在最外层，然后根据表中的每一行数据去遍历内层表，找到所有符合条件的行。如果外层表行数为 m，内层表行数为 n，则总共要遍历 m*n 行数据。</p>
<p>但如果内层表使用了索引，而关联字段恰好就被索引覆盖的话，就只需要几次查询就可以定位内层表的数据行。总行数从 m*n 变为 m*i(i 一般小于 3)。这无疑大大加快了关联查询的速度。MySQL 查询优化器会调整关联表查询的顺序来尽可能使用多的索引查询。</p>
<h3 id="2-将外连接转化成内连接"><a href="#2-将外连接转化成内连接" class="headerlink" title="2. 将外连接转化成内连接"></a>2. 将外连接转化成内连接</h3><p>并不是所有的 OUTER JOIN 语句都必须以外连接的方式执行。诸多原因，例如 WHERE 条件、库表结构都可能让一个外连接等价于一个内连接。MySQL 能够识别这点并重写查询，让其可以调整关联顺序（外连接分左右，所以无法调整顺序）。</p>
<h3 id="3-使用等价变换规则"><a href="#3-使用等价变换规则" class="headerlink" title="3. 使用等价变换规则"></a>3. 使用等价变换规则</h3><p>MySQL 可以合并和减少一些比较，例如（5=5 AND a&gt;5）将被改写成（a&gt;5）。</p>
<h3 id="4-优化-COUNT-、MIN-和-MAX"><a href="#4-优化-COUNT-、MIN-和-MAX" class="headerlink" title="4. 优化 COUNT()、MIN() 和 MAX()"></a>4. 优化 COUNT()、MIN() 和 MAX()</h3><p>索引和是否可为空可以帮助 MySQL 优化这类表达式。例如要找某一列的最小值，只需查询对应 B-tree 索引最左端的记录，而最大值只需查询对应 B-tree 索引最右端。另外，没有任何 WHERE 条件的 COUNT(*) 查询在 MyISAM 中也是 O(1)，因为 MyISAM 维护了一个变量来存放数据表的行数（不过 innodb 没有，innodb 中执行 COUNT(*) 会做全表查询）。</p>
<h3 id="5-预估并转化为常数表达式"><a href="#5-预估并转化为常数表达式" class="headerlink" title="5. 预估并转化为常数表达式"></a>5. 预估并转化为常数表达式</h3><p>当 MySQL 检测到一个表达式或者一个子查询可以转化为常数的时候，就会一直把该表达式作为常数进行优化处理。</p>
<h3 id="6-覆盖索引扫描"><a href="#6-覆盖索引扫描" class="headerlink" title="6. 覆盖索引扫描"></a>6. 覆盖索引扫描</h3><p>当索引中的列覆盖所有查询中需要使用的列时，MySQL 将直接使用索引返回所需数据而不做回表查询。</p>
<h3 id="7-提前终止查询"><a href="#7-提前终止查询" class="headerlink" title="7. 提前终止查询"></a>7. 提前终止查询</h3><p>在发现已经满足查询要求的时候，MySQL 总是能够立刻终止查询。比如 LIMIT。</p>
<h3 id="8-子查询优化"><a href="#8-子查询优化" class="headerlink" title="8. 子查询优化"></a>8. 子查询优化</h3><p>MySQL 5.6 中处理子查询的思路是，基于查询重写技术的规则，尽可能将子查询转换为连接，并配合基于代价估算的 Materialize、exists 等优化策略让子查询执行更优。</p>
<h3 id="9-等值传播"><a href="#9-等值传播" class="headerlink" title="9. 等值传播"></a>9. 等值传播</h3><p>如果两个列的值通过等式关联，那么 MySQL 能够把其中一个列的 WHERE 语句条件传递到另一列上。例如：</p>
<blockquote>
<p>SELECT film.film_id FROM film INNER JOIN film_actor USING(film_id) WHERE film.film_id &gt; 500;</p>
</blockquote>
<p>优化器会把它优化为：</p>
<blockquote>
<p>SELECT film.film_id FROM film INNER JOIN film_actor USING(film_id) WHERE film.film_id &gt; 500 AND film_actor.film_id &gt; 500;</p>
</blockquote>
<h3 id="10-列表-IN-的比较"><a href="#10-列表-IN-的比较" class="headerlink" title="10. 列表 IN() 的比较"></a>10. 列表 IN() 的比较</h3><p>MySQL 会将 IN() 列表中的数据先进行排序，然后通过二分查找的形式来确定取出的值是否在列表中。</p>
<h3 id="11-索引合并"><a href="#11-索引合并" class="headerlink" title="11. 索引合并"></a>11. 索引合并</h3><p>当 WHERE 子句中包含多个复杂条件涉及到多个索引时，MySQL 会先根据不同索引取出多组数据，再将这些数据合并。</p>
<h2 id="三、MySQL-查询优化器的局限"><a href="#三、MySQL-查询优化器的局限" class="headerlink" title="三、MySQL 查询优化器的局限"></a>三、MySQL 查询优化器的局限</h2><h3 id="1-关联子查询"><a href="#1-关联子查询" class="headerlink" title="1. 关联子查询"></a>1. 关联子查询</h3><p>上一节有提到 MySQL 查询优化器会把 IN 子查询变为 EXISTS 子查询的形式，大部分情况下这种优化会带来性能提升，但某些情况下，会让查询更慢。比如：</p>
<blockquote>
<p>SELECT * FROM film WHERE film_id IN(SELECT film_id FROM film_actor WHERE actor_id = 1);</p>
</blockquote>
<p>假设 film 和 film_actor 表在 film_id 上都有索引，那么这条语句会走 film_actor 和 film 的索引，速度非常快。但查询优化器会把它 “优化” 为：</p>
<blockquote>
<p>SELECT * FROM film WHERE EXISTS(SELECT 1 FROM film_actor WHERE actor_id = 1 AND film.film_id = actor.film_id);</p>
</blockquote>
<p>此时 MySQL 只会走 film_actor 的索引而会对 film 做全表扫描，效率大大下降。</p>
<p>解决的方法就是使用左外连接改造：</p>
<blockquote>
<p>SELECT film.* FROM film LEFT OUTER JOIN film_actor USING(film_id) WHERE film_actor.actor_id = 1;</p>
</blockquote>
<p><strong>PS：5.6 及以后版本的 MySQL 对关联子查询做了大量优化，现在的思路是，基于查询重写技术的规则，尽可能将子查询转换为连接，并配合基于代价估算的 Materialize、exists 等优化策略让子查询执行更优。因此 5.6 以后将不存在这个问题。</strong></p>
<h3 id="2-UNION-的限制"><a href="#2-UNION-的限制" class="headerlink" title="2.UNION 的限制"></a>2.UNION 的限制</h3><p>MySQL 无法将限制条件从外层 “下推” 到内层，其中一个典型就是 UNION：</p>
<blockquote>
<p>(SELECT first_name FROM actor) UNION ALL (SELECT first_name FROM customer) LIMIT 20;</p>
</blockquote>
<p>MySQL 会把 actor 和 customer 中的所有记录放在同一张临时表中，然后从临时表中取出前 20 条。可以通过把 LIMIT 放入内部来解决这个问题：</p>
<blockquote>
<p>(SELECT first_name FROM actor LIMIT 20) UNION ALL (SELECT first_name FROM customer LIMIT 20) LIMIT 20;</p>
</blockquote>
<p>这样临时表的规模就缩小到 40 了。</p>
<h3 id="3-最大值和最小值优化"><a href="#3-最大值和最小值优化" class="headerlink" title="3. 最大值和最小值优化"></a>3. 最大值和最小值优化</h3><p>MySQL 优化器会对不加条件的 MAX 和 MIN 做优化，但并没有对加条件的这两个函数做优化。比如：</p>
<blockquote>
<p>SELECT MIN(actor_id) FROM actor WHERE first_name = “PENELOPE”;</p>
</blockquote>
<p>actor_id 是主键，严格按照大小排序，那么其实在找到第一个满足条件的记录就可以返回了。而 MySQL 会继续遍历整张表。修改的方式是使用 LIMIT：</p>
<blockquote>
<p>SELECT actor_id FROM actor WHERE first_name = “PENELOPE” LIMIT 1;</p>
</blockquote>
<p>此时会触发提前终止机制，返回最小的 actor_id。</p>
<h2 id="四、优化特定类型的查询"><a href="#四、优化特定类型的查询" class="headerlink" title="四、优化特定类型的查询"></a>四、优化特定类型的查询</h2><h3 id="1-优化-COUNT-查询"><a href="#1-优化-COUNT-查询" class="headerlink" title="1. 优化 COUNT() 查询"></a>1. 优化 COUNT() 查询</h3><p>很多时候一些业务场景并不要求完全精确的 COUNT 值，可以使用</p>
<blockquote>
<p>EXPLAIN SELECT * FROM film;</p>
</blockquote>
<p>得到的近似值来代替。</p>
<p>innodb 下，如果表中单行数据量很大，且没有二级索引的话，可以对表上较短的且不为空的字段加索引，再执行 count(*），此时优化器会自动选择走二级索引，由于二级索引是短字段，单页存储的数据行数就多，减少了取页的次数，查询时间也就更短了。</p>
<h3 id="2-优化关联查询"><a href="#2-优化关联查询" class="headerlink" title="2. 优化关联查询"></a>2. 优化关联查询</h3><p>确保 ON 或者 USING 子句中的列上有索引，这样只需要全表扫描第一个表，第二个表可以走索引。</p>
<p>确保任何的 GROUP BY 和 ORDER BY 中的表达式只涉及到一个表中的列，这样 MySQL 才可能使用索引来优化这个过程。</p>
<h3 id="3-优化-LIMIT-分页"><a href="#3-优化-LIMIT-分页" class="headerlink" title="3. 优化 LIMIT 分页"></a>3. 优化 LIMIT 分页</h3><p>LIMIT 分页在系统偏移量非常大的时候效果会很差。比如 LIMIT 1000,20 这样的查询，这时 MySQL 需要查询 10020 条记录然后只返回最后 20 条。</p>
<p>优化此类分页查询的一个最简单的办法就是尽可能利用索引覆盖扫描。考虑下面的查询：</p>
<blockquote>
<p>SELECT film_id, description FROM film ORDER BY title LIMIT 50,5;</p>
</blockquote>
<p>这个语句可以被改写成：</p>
<blockquote>
<p>SELECT film.film_id,film,description FROM film INNER JOIN(SELECT film_id FROM film ORDER BY title LIMIT 50,5)AS lim USING(film_id);</p>
</blockquote>
<p>这里的 “延迟关联” 操作将大大提升查询效率，它会利用覆盖索引直接定位到分页所需数据所在的位置，而不需要从头遍历。</p>
<p>记录上一次取数据的位置也是一个不错的主意。比如在频繁使用 “下一页” 这个功能的时候，记录下上次取数据最后的位置，然后可以把查询语句写成：</p>
<blockquote>
<p>SELECT film_id, description FROM film WHERE film_id&gt;16030 ORDER BY film_id LIMIT 5;</p>
</blockquote>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">MySQL</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/08/28/《高性能 MySQL》读书笔记——查询优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-《高性能 MySQL》读书笔记——索引优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/25/《高性能 MySQL》读书笔记——索引优化/">《高性能 MySQL》读书笔记——索引优化</a>
    </h1>
  

        
        <a href="/2018/08/25/《高性能 MySQL》读书笔记——索引优化/" class="archive-article-date">
  	<time datetime="2018-08-25T09:34:28.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-08-25</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>索引是数据库得以高效的关键，以最常见的 B+Tree 索引为例，至少有以下三个优点：1）索引大大减少了服务器需要扫描的数据量；2）索引可以帮助服务器避免排序和临时表；3）索引可以将随机 I/O 变为顺序 I/O。因此，如何使用索引也成了高效 MySQL 重要的一部分。</p>
<h2 id="一、MySQL-中的索引"><a href="#一、MySQL-中的索引" class="headerlink" title="一、MySQL 中的索引"></a>一、MySQL 中的索引</h2><h3 id="1、B-Tree-索引"><a href="#1、B-Tree-索引" class="headerlink" title="1、B-Tree 索引"></a>1、B-Tree 索引</h3><p>B-Tree 和其变体 B+Tree 是绝大部分数据库引擎默认使用的数据结构，我们在谈到索引时若无特殊指代一般是指 B+Tree（B-Tree 和 B+Tree 的区别及选择这种数据结构的原因可以看<a href="http://huzb.me/2018/03/13/MySQL%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">这里 </a>）</p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><p>B-Tree 索引适用于全键值、键值范围或键前缀查找。其中键前缀查找只适用于根据最左前缀的查找。以下表为例</p>
<table>
<thead>
<tr>
<th>family_name</th>
<th>first_name</th>
<th>birthday</th>
</tr>
</thead>
<tbody>
<tr>
<td>张</td>
<td>三</td>
<td>1960-1-1</td>
</tr>
<tr>
<td>李</td>
<td>四</td>
<td>1962-3-2</td>
</tr>
<tr>
<td>王</td>
<td>五</td>
<td>1966-4-5</td>
</tr>
</tbody>
</table>
<p>依次在 family_name、first_name 和 birthday 上建立 B-Tree 索引（暂不考虑主键的影响），则上述的索引对如下的索引有效：</p>
<ul>
<li>全值匹配：全值匹配指的是和索引中的所有列进行匹配，如查找 family_name = 张，first_name = 三，birthday = 1960-1-1 的人。</li>
<li>匹配最左前缀：查找所有 family_name= 张 的人。</li>
<li>匹配列前缀：查找所有 family_name = 张，first_name = 三，birthday = 196X 的人。列前缀的语法有很多，比如 where birthday(3) = 196 或者 where birthday like “196%” 都是合法的匹配列前缀的语法，但 birthday like “%96%” 不是合法的列前缀匹配，不会使用索引查找。</li>
<li>匹配范围值：查找所有 family_name = 张，first_name = 三，birthday &gt; 1960-1-1 and birthday &lt; 1969-12-31 的人。</li>
<li>只访问索引的查询：若查询的内容在索引中便可全部找到，则无需回表查询，可以节省大量磁盘 IO，这种索引有个专有名词叫“覆盖索引”。</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>B-Tree 索引的功能强大，但也有局限，仍以上述的索引为例：</p>
<ul>
<li>如果不是按照索引的最左列开始查找，则无法使用索引。例如我们无法用索引查找 first_name = 四 的人。</li>
<li>不能跳过索引中的列。例如我们无法用索引查找 family_name = 张，birthday = 1960-1-1 的人。</li>
<li>查询中可以使用范围查询，但只能使用一次，且它右边所有的列都无法使用索引优化查找。如查找 family_name = 张，first_name &gt; 三 and first_name &lt; 五（字典序），birthday = 1960-1-1 的人，只会用到姓和名两个索引列，无法使用第三个索引列。（这个涉及到联合索引底层的数据结构，如下图）</li>
</ul>
<p><img src="/2018/08/25/《高性能 MySQL》读书笔记——索引优化/联合索引数据结构.png"></p>
<p>B-Tree 在建立联合索引的时候只会对第一个字段建立 B-Tree 索引，其它字段会在对应的叶子节点的 data 域上按给定字段的顺序作为优先级排序后储存。如上图，对 id、family_name、first_name 三个列建立索引。则底层存储时会先按 id 构造 B-Tree，再在 B-Tree 的叶子节点上按 family_name、first_name 的优先级排序后存储对应的地址。对于叶子节点上数据的查找，会采用二分查找的方式。而一旦确定了前一个字段使用范围查找后，得到的一组数据对于后一个字段而言是无序的，无法继续使用二分查找，只能遍历，此时索引失效。除了范围查询，整个 B-Tree 的最左匹配原则的原因也是和这个数据存储的方式息息相关的，理解了这个数据结构也就理解了 B-Tree 的最左匹配原则。</p>
<h3 id="2、哈希索引"><a href="#2、哈希索引" class="headerlink" title="2、哈希索引"></a>2、哈希索引</h3><p>哈希索引基于哈希表实现，使用链表法解决哈希冲突，只有精确匹配索引所有列的查询才有效。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码，哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。</p>
<p>在 MySQL 中，只有 Memory 引擎显式支持哈希索引，这也是 Memory 引擎表的默认索引类型。</p>
<h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ul>
<li>索引的结构十分紧凑，查找的速度非常快。</li>
</ul>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>哈希索引只包含哈希值和指针，而不存储字段值，所以不能使用覆盖查询。</li>
<li>哈希索引数据并不是按照索引值顺序存储的，所以也就无法用于排序。</li>
<li>哈希索引也不支持部分索引列匹配查找，因为哈希值的计算是使用索引列的全部内容计算的。</li>
<li>哈希索引只支持等值比较，不支持任何范围查询</li>
</ul>
<p>哈希索引的缺点也决定了哈希索引只适用于某些特定的场合，但一旦适合哈希索引，则它带来的性能提升将非常显著。</p>
<h3 id="3、全文索引"><a href="#3、全文索引" class="headerlink" title="3、全文索引"></a>3、全文索引</h3><p>在标准的 MySQL 中只有 MyISAM 引擎支持全文索引，同时 innodb 也开始实验性质地支持全文索引。</p>
<p>MyISAM 的全文索引作用对象是一个“全文集合”，这可能是某个数据表的一列，也可能使多个列。具体的，对数据表的某一条记录，MySQL 会将需要索引的列全部拼接成一个字符串，然后进行索引。</p>
<p>MyISAM 的全文索引是一类特殊的 B-Tree 索引，共有两层。第一层是所有关键字，然后对于每一个关键字的第二层，包含的是一组相关的“文档指针”。</p>
<h2 id="二、innodb-中的索引"><a href="#二、innodb-中的索引" class="headerlink" title="二、innodb 中的索引"></a>二、innodb 中的索引</h2><h3 id="1、聚簇索引"><a href="#1、聚簇索引" class="headerlink" title="1、聚簇索引"></a>1、聚簇索引</h3><p>聚簇索引不是一种单独的索引类型，而是一种数据存储方式。innodb 的聚簇索引是在 B-tree 的叶子节点上存放了数据行。</p>
<p><img src="/2018/08/25/《高性能 MySQL》读书笔记——索引优化/聚簇索引.jpeg"></p>
<p>innodb 所有表中的数据都会以这种形式保存在磁盘，这也意味着 innodb 每张表中至少要有一个主键。如果没有显式地定义主键，innodb 会选择一个唯一的非空索引代替；如果没有这样的索引，innodb 会隐式定义一个主键作为聚簇索引。</p>
<p>聚簇索引中，每个叶子节点称为一个数据页，相邻的数据页之间有双向指针相连，范围查找可以直接按顺序读出，速度非常快。</p>
<h3 id="2、非聚簇索引（辅助索引）"><a href="#2、非聚簇索引（辅助索引）" class="headerlink" title="2、非聚簇索引（辅助索引）"></a>2、非聚簇索引（辅助索引）</h3><p>innodb 中每张表有且仅有一个聚簇索引，剩下的都是非聚簇索引。对于非聚簇索引，叶子节点并不会包含行记录的全部数据，而是保存指向聚簇索引中某一条记录的指针。比如 user 表中使用 user_id 作为主键，那么在它的非聚簇索引的叶子节点中，保存的就是 user_id。对于一次使用了非聚簇索引的查找，数据库引擎会先在非聚簇索引上找到 user_id，再根据 user_id 在聚簇索引上找到对应的数据行，这也就是 innodb 中的二次查询。</p>
<h3 id="3、自适应哈希索引"><a href="#3、自适应哈希索引" class="headerlink" title="3、自适应哈希索引"></a>3、自适应哈希索引</h3><p>自适应哈希索引是 innodb 上的一种优化措施。InnoDB 存储引擎会监控对表上各索引页的查询。如果观察到建立哈希索引可以带来速度提升，则建立哈希索引，称之为自适应哈希索引 (Adaptive Hash Index, AHI)。AHI 是通过缓冲池的 B+树页构造而来，因此建立的速度很快，而且不需要对整张表构建哈希索引。InnoDB 存储引擎会自动根据访问的频率和模式来自动地为某些热点页建立哈希索引。</p>
<p>AHI 有一个要求，对这个页的连续访问模式必须是一样的。例如对于 (a,b) 这样的联合索引页，其访问模式可以是下面情况： </p>
<ul>
<li>where a=xxx </li>
<li>where a =xxx and b=xxx </li>
</ul>
<p>访问模式一样是指查询的条件是一样的，若交替进行上述两种查询，那么 InnoDB 存储引擎不会对该页构造 AHI。<br>AHI 还有下面几个要求： </p>
<ul>
<li>以该模式连续访问了 100 次 </li>
<li>以该模式连续访问了 页中记录总数/16 次</li>
</ul>
<p>必须同时满足上述所有要求才会建立 AHI。</p>
<p>InnoDB 存储引擎官方文档显示，启用 AHI 后,读取和写入速度可以提高 2 倍，辅助索引的连接操作性能可以提高 5 倍。</p>
<h2 id="三、常见索引失效场景"><a href="#三、常见索引失效场景" class="headerlink" title="三、常见索引失效场景"></a>三、常见索引失效场景</h2><h3 id="1、查询条件包含-or"><a href="#1、查询条件包含-or" class="headerlink" title="1、查询条件包含 or"></a>1、查询条件包含 or</h3><blockquote>
<p>SELECT * FROM order WHERE order_id = 1 OR pay_method=’123’;</p>
</blockquote>
<p>当 or 左右查询字段只有一个是索引，该索引失效；只有当 or 左右查询字段均为索引时，才会生效。</p>
<h3 id="2、索引列上有计算、函数等操作"><a href="#2、索引列上有计算、函数等操作" class="headerlink" title="2、索引列上有计算、函数等操作"></a>2、索引列上有计算、函数等操作</h3><blockquote>
<p>SELECT * FROM order WHERE order_id +1 = 2;</p>
</blockquote>
<h3 id="3、使用负向查询（-、-lt-gt-、not-in、not-exists、not-like-等）"><a href="#3、使用负向查询（-、-lt-gt-、not-in、not-exists、not-like-等）" class="headerlink" title="3、使用负向查询（!=、&lt;&gt;、not in、not exists、not like 等）"></a>3、使用负向查询（!=、&lt;&gt;、not in、not exists、not like 等）</h3><blockquote>
<p>SELECT * FROM order WHERE order_id &lt;&gt; 2;</p>
</blockquote>
<h3 id="4、5-7-之前的-is-null-和-is-not-null"><a href="#4、5-7-之前的-is-null-和-is-not-null" class="headerlink" title="4、5.7 之前的 is null 和 is not null"></a>4、5.7 之前的 is null 和 is not null</h3><blockquote>
<p>SELECT * FROM order WHERE order_id is not null;</p>
</blockquote>
<p>5.7 之后 is null 和 is not null 也会走索引，但对于使用了声明了 NOT NULL 的索引行不会。</p>
<h3 id="5、不符合最左前缀原则的组合索引"><a href="#5、不符合最左前缀原则的组合索引" class="headerlink" title="5、不符合最左前缀原则的组合索引"></a>5、不符合最左前缀原则的组合索引</h3><p>当查询涉及到联合索引时，查询的条件必须是联合索引的一个前缀。比如对于联合索引 A/B/C/D，查询的条件可以是 A，也可以是 A/B/C，但不能是 B/C。另外对于范围查询，只能有一个条件是范围查询且必须是最后一个。比如查询 A/B/C，只有 C 可以是范围查询。另外在 MySQL 中，IN 被定义为范围查询，但却是当作多个条件等于来处理，因此 IN 语句放在中间，也会走索引。</p>
<h3 id="6、like-以通配符开头"><a href="#6、like-以通配符开头" class="headerlink" title="6、like 以通配符开头"></a>6、like 以通配符开头</h3><blockquote>
<p>SELECT * FROM order WHERE pay_method LIKE ‘%23’;</p>
</blockquote>
<h3 id="7、字符串不加单引号"><a href="#7、字符串不加单引号" class="headerlink" title="7、字符串不加单引号"></a>7、字符串不加单引号</h3><blockquote>
<p>SELECT * FROM order WHERE pay_method = 123;</p>
</blockquote>
<h3 id="8、当全表扫描速度比索引速度快时，mysql-会使用全表扫描，此时索引失效"><a href="#8、当全表扫描速度比索引速度快时，mysql-会使用全表扫描，此时索引失效" class="headerlink" title="8、当全表扫描速度比索引速度快时，mysql 会使用全表扫描，此时索引失效"></a>8、当全表扫描速度比索引速度快时，mysql 会使用全表扫描，此时索引失效</h3><p>一个有意思的例子是 IN 的索引失效。MySQL 优化器对开销代价的估算方法有两种：index dive 和 index statistics。前者统计速度慢但是能得到精准的值，后者统计速度快但是数据未必精准。老版本的 MySQL 默认使用 index dive 这种统计方式，但在 IN() 组合条件过多的时候会发生很多问题。查询优化可能需要花很多时间，并消耗大量内存。因此新版本 MySQL 在组合数超过一定的数量（eq_range_index_dive_limit）就会使用 index statistics 统计。而 index statistics 统计的结果不精确，因此可能会出现 IN 不走索引的情况。此时可以尝试通过增加 eq_range_index_dive_limit 的值（5.6 中默认是 10，5.7 中默认是 200）让 IN 语句走索引。</p>
<h2 id="四、高性能索引策略"><a href="#四、高性能索引策略" class="headerlink" title="四、高性能索引策略"></a>四、高性能索引策略</h2><h3 id="1、使用前缀索引"><a href="#1、使用前缀索引" class="headerlink" title="1、使用前缀索引"></a>1、使用前缀索引</h3><p>在对一个比较长的字符串建立索引的时候，把字符串所有字符放入索引是比较低效的做法。前文对字符串做哈希是一种方式。也可以使用字符串的前缀做索引。比如</p>
<blockquote>
<p>CREATE INDEX index_name ON table_name (column_name(10));</p>
</blockquote>
<p>表示将列的前 10 个字符做索引，这样做的好处是减少索引字段的大小，可以在一页内放入更多的数据，从而降低 B-tree 的高度，同时更短的索引字段带来更短的匹配时间，提高了查找效率。</p>
<h3 id="2、使用覆盖索引"><a href="#2、使用覆盖索引" class="headerlink" title="2、使用覆盖索引"></a>2、使用覆盖索引</h3><p>覆盖索引是一种索引包含了查询所需所有数据的情况，在这种情况下，MySQL 可以使用索引来直接获取列的数据，这样就不需要再读取数据行。覆盖索引是非常有用的工具，能够极大地提升性能：</p>
<ul>
<li>索引条目远小于数据行大小，所以如果只需要读取索引，MySQL 就会极大地减少数据访问量。这对缓存的负载非常重要，因为这种情况下响应时间大部分花费在数据拷贝上。</li>
<li>因为索引是按值顺序存储的（至少在单个页内如此），对于 I/O 密集型的范围查询会比随机从磁盘读取每一行数据的 I/O 要少得多。</li>
<li>对于 innodb 的聚簇索引，覆盖索引特别有用。innodb 的二级索引在叶子节点中保存了行的主键值，所以如果二级主键能够覆盖索引，则可以避免对主键索引的二次查询。</li>
</ul>
<h3 id="3、延迟关联"><a href="#3、延迟关联" class="headerlink" title="3、延迟关联"></a>3、延迟关联</h3><p>覆盖索引可以极大地提升查找的效率，但很多时候我们会遇到 select * 这样的需求，这时使用覆盖索引就不可能了。不过我们可以使用延迟关联的方式利用覆盖索引。</p>
<p>比如对于语句：</p>
<blockquote>
<p>select  from t_portal_user where create_time &gt; ‘2012-10:10’ and create_time&lt;’2017:10:10’ LIMIT 5000,10;</p>
</blockquote>
<p>可以改写成：</p>
<blockquote>
<p>SELECT  from t_portal_user INNER JOIN (select id from t_portal_user where create_time &gt; ‘2012-10:10’ and create_time&lt;’2017:10:10’ LIMIT 5000,10) as a USING(id);</p>
</blockquote>
<p>对于子查询：</p>
<blockquote>
<p>select id from t_portal_user where create_time &gt; ‘2012-10:10’ and create_time&lt;’2017:10:10’ LIMIT 5000,10;</p>
</blockquote>
<p>如果在 create_time 上做了索引（innodb 中主键会被默认添加进索引中），则可以利用覆盖索引找到符合条件的 id，再根据 id 做普通查询。</p>
<h3 id="4、利用索引来做排序"><a href="#4、利用索引来做排序" class="headerlink" title="4、利用索引来做排序"></a>4、利用索引来做排序</h3><p>MySQL 支持二种方式的排序，文件排序和索引，后者效率高，它指 MySQL 扫描索引本身完成排序。文件排序方式效率较低。ORDER BY 满足以下情况，会使用 Index 方式排序:</p>
<ul>
<li>使用覆盖索引，即通过扫描索引本身就可完成排序</li>
<li>ORDER BY 语句 或者 WHERE , JOIN 子句和 ORDER BY 语句组成的条件组合满足最左前缀（一个例外是 IN，IN 在没有排序的最左匹配中被视为等值查询，对排序来说是一种范围查询）</li>
<li>ORDER BY 语句中条件的排序顺序是一样（都为正序或者都为倒序）</li>
</ul>
<h3 id="5、自定义哈希索引"><a href="#5、自定义哈希索引" class="headerlink" title="5、自定义哈希索引"></a>5、自定义哈希索引</h3><p>如果存储引擎不支持哈希索引，则可以在 B-tree 基础上创建一个伪哈希索引。这和真正的哈希索引不是一回事，因为还是使用 B-tree 进行查找，但它使用的是哈希值而不是键本身进行查找。<br>如</p>
<blockquote>
<p>SELECT id FROM user WHERE address = “zhejiang ningbo”;</p>
</blockquote>
<p>若删除原来 URL 列上的索引，而新增一个被索引的 address_crc 列，使用 CRC32 做哈希，就可以使用下面的方式查询：</p>
<blockquote>
<p>SELECT id FROM user WHERE address=”zhejiang ningbo” AND url_crc=CRC32(“zhejiang ningbo”);</p>
</blockquote>
<p>这样做的性能会非常高，因为 MySQL 优化器会使用这个选择性很高而体积很小的基于 url_crc 列的索引来完成查找。即使有多个记录有相同的索引值，查找仍然很快，只需要根据哈希值做快速的整数比较就能找到索引条目，然后一一比较返回对应的行。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">MySQL</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/08/25/《高性能 MySQL》读书笔记——索引优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-《高性能 MySQL》读书笔记——库表结构优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/18/《高性能 MySQL》读书笔记——库表结构优化/">《高性能 MySQL》读书笔记——库表结构优化</a>
    </h1>
  

        
        <a href="/2018/08/18/《高性能 MySQL》读书笔记——库表结构优化/" class="archive-article-date">
  	<time datetime="2018-08-18T10:08:36.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-08-18</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>本文介绍了 MySQL 中的常用数据类型及其适用场景，以及数据库范式和反范式化的设计。</p>
<h2 id="1、MySQL-常用数据类型"><a href="#1、MySQL-常用数据类型" class="headerlink" title="1、MySQL 常用数据类型"></a>1、MySQL 常用数据类型</h2><p>MySQL 常用数据类型分为：整数、实数、字符串、日期和时间、位数据几种。</p>
<h3 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h3><p>整数类型可以分为：TINYINT，SMALLINT，MEDIUMINT，INT，BIGINT，分别使用：8，16，24，32，64 位的存储空间。</p>
<p>整数类型有可选的 UNSIGNED 属性，表示不允许负值，可以把正数的上限提高一倍。</p>
<p>整数可以指定宽度，比如 INT(11)，这表示在一些交互工具中 INT 会显示 11 个数字，对于存储和计算来说没有意义，INT(1) 和 INT(20) 都是 32 位。</p>
<h3 id="实数类型"><a href="#实数类型" class="headerlink" title="实数类型"></a>实数类型</h3><p>实数类型可以是带有小数部分的数字，也可以不是。比如可以使用 DECIMAL 存储比 BIGINT 还大的整数。</p>
<p>实数类型分为：FLOAT，DOUBLE 和 DECIMAL，其中 FLOAT 和 DOUBLE 用于存储不精确的小数类型，分别使用 32 和 64 位的存储空间；DECIMAL 用于存储精确的小数类型，存储空间的大小根据小数的长度决定。5.0 版本以后 DECIMAL 最多允许 65 个数字。</p>
<p>尽量使用 FLOAT 和 DOUBLE 存储小数类型。只有需要精确计算的场合才使用 DECIMAL，但在数据量比较大的时候，可以考虑使用 BIGINT 代替 DECIMAL，将需要存储的数字乘以相应的倍数即可。</p>
<h3 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h3><p>MySQL 中的字符串类型有 CHAR，VARCHAR，TEXT 和 BLOB 四种，其中 TEXT 和 BLOB 两种类型比较特别，MySQL 把每个 BLOB 和 TEXT 值当作一个独立的对象处理，存储引擎在处理时也通常会做相应的处理。比如当 TEXT 或 BLOB 的值较大时，innodb 会使用专门的“外部”存储区域来进行存储，此时每个值在行内需要 1~4 个字节存储一个指针。</p>
<p>TEXT 和 BLOB 之间仅有的不同是 BLOB 类型存储的是二进制数据，没有排序规则或字符集，而 TEXT 类型有字符集和排序规则。</p>
<p>MySQL 对 BLOB 和 TEXT 列进行排序与其他类型是不同的：它只对每个列的最前 max_sort_length 字节而不是整个字符串做排序。</p>
<p>VARCHAR 是变长字符串，而 CHAR 是定长字符串。VARCHAR 比 CHAR 更省空间，因为它仅使用必要的空间。VARCHAR 需要使用 1 或 2 个额外字节记录字符串的长度：如果列的最大长度小于或等于 255 字节，则只使用 1 个字节表示，否则使用 2 个。</p>
<p>VARCHAR 节省了存储空间，但由于行是变长的，在 UPDATE 时可能使行变得比原来更长，这就导致需要做额外的工作。如果一个行占用空间增长，超出页的大小，innodb 会使用裂页来使行可以放进页内。对于过长的 VARCHAR，innodb 会将其存储为 BLOB。</p>
<p>CHAR 值在存储时，MySQL 会删除所有的末尾空格。</p>
<h4 id="使用枚举（ENUM）代替字符串类型"><a href="#使用枚举（ENUM）代替字符串类型" class="headerlink" title="使用枚举（ENUM）代替字符串类型"></a>使用枚举（ENUM）代替字符串类型</h4><p>如果预计字符串可取的值范围确定且数量不大，可以使用枚举的方式替代字符串。比如存储水果，预计种类只有苹果、香蕉、梨。可以把水果种类定义为 ENUM(“apple”,”banana”,”pear”)，实际存储时 MySQL 只会在列表中保存数字，并在.frm 文件中保存一个“数字-字符串”的映射关系，可以大大减少存储的空间。</p>
<h3 id="日期和时间类型"><a href="#日期和时间类型" class="headerlink" title="日期和时间类型"></a>日期和时间类型</h3><p>MySQL 能存储的最小时间粒度为秒，但也可以通过使用 BIGINT 类型存储微秒级别的时间戳等方式绕开这一限制。MySQL 中存储时间的数据类型有两种：DATETIME 和 TIMESTAMP。两种类型的区别如下：</p>
<h4 id="DATETIME"><a href="#DATETIME" class="headerlink" title="DATETIME"></a>DATETIME</h4><ol>
<li>占用 8 个字节</li>
<li>允许为空值，可以自定义值，系统不会自动修改其值。</li>
<li>实际格式储存，格式为 YYYYMMDDHHMMSS 的整数</li>
<li>与时区无关</li>
<li>不可以设定默认值，所以在不允许为空值的情况下，必须手动指定 datetime 字段的值才可以成功插入数据。</li>
<li>可以在指定 datetime 字段的值的时候使用 now() 变量来自动插入系统的当前时间。</li>
</ol>
<p>结论：datetime 类型适合用来记录数据的原始的创建时间，因为无论你怎么更改记录中其他字段的值，datetime 字段的值都不会改变，除非你手动更改它。</p>
<h4 id="TIMESTAMP"><a href="#TIMESTAMP" class="headerlink" title="TIMESTAMP"></a>TIMESTAMP</h4><ol>
<li>占用 4 个字节，默认为 NOT NULL</li>
<li>TIMESTAMP 值不能早于 1970 或晚于 2037。这说明一个日期，例如 ‘1968-01-01’，虽然对于 DATETIME 或 DATE 值是有效的，但对于 TIMESTAMP 值却无效，如果分配给这样一个对象将被转换为 0。</li>
<li>值以 UTC 格式保存，为从 1970 年 1 月 1 日（格林尼治时间）午夜以来的秒数。</li>
<li>时区转化 ，存储时对当前的时区进行转换，检索时再转换回当前的时区。</li>
<li>默认情况下，如果插入或更新时没有指定第一个 TIMESTAMP 的值，MySQL 会设置这个列的值为当前时间。</li>
</ol>
<p>结论：timestamp 类型适合用来记录数据的最后修改时间，因为只要你更改了记录中其他字段的值，timestamp 字段的值都会被自动更新。</p>
<h3 id="位数据类型"><a href="#位数据类型" class="headerlink" title="位数据类型"></a>位数据类型</h3><p>BIT 和 SET 是 MySQL 中典型的位数据类型，位数据的本质是一个二进制字符串，使用位数据类型可以在一列中存储多个”true/false”值。</p>
<h2 id="2、范式和反范式"><a href="#2、范式和反范式" class="headerlink" title="2、范式和反范式"></a>2、范式和反范式</h2><h3 id="数据库中的范式"><a href="#数据库中的范式" class="headerlink" title="数据库中的范式"></a>数据库中的范式</h3><p>满足最低要求的范式是第一范式（1NF）。在第一范式的基础上进一步满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般说来，数据库只需满足第三范式 (3NF）就行了。 </p>
<p>范式的包含关系。一个数据库设计如果符合第二范式，一定也符合第一范式。如果符合第三范式，一定也符合第二范式。</p>
<ul>
<li>1NF：属性不可分 </li>
<li>2NF：属性完全依赖于主键 [消除部分子函数依赖 ] </li>
<li>3NF：属性不依赖于其它非主属性 [消除传递依赖 ] </li>
</ul>
<h4 id="第一范式-1NF"><a href="#第一范式-1NF" class="headerlink" title="第一范式 (1NF)"></a>第一范式 (1NF)</h4><p>符合 1NF 的关系中的每个属性都不可再分。<br>反例：<br><img src="/2018/08/18/《高性能 MySQL》读书笔记——库表结构优化/第一范式.jpg"></p>
<h4 id="第二范式-2NF"><a href="#第二范式-2NF" class="headerlink" title="第二范式 (2NF)"></a>第二范式 (2NF)</h4><p>2NF 在 1NF 的基础之上，消除了非主属性对于码（主键）的部分函数依赖</p>
<p>可以通过分解来满足。</p>
<p><strong>分解前</strong> </p>
<table>
<thead>
<tr>
<th>学号</th>
<th>姓名</th>
<th>系名</th>
<th>系主任</th>
<th>课名</th>
<th>分数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1022211101</td>
<td>李小明</td>
<td>经济系</td>
<td>王强</td>
<td>高等数学</td>
<td>95</td>
</tr>
<tr>
<td>1022211101</td>
<td>李小明</td>
<td>经济系</td>
<td>王强</td>
<td>大学英语</td>
<td>87</td>
</tr>
<tr>
<td>1022211101</td>
<td>李小明</td>
<td>经济系</td>
<td>王强</td>
<td>普通化学</td>
<td>76</td>
</tr>
<tr>
<td>1022211102</td>
<td>张莉莉</td>
<td>经济系</td>
<td>王强</td>
<td>高等数学</td>
<td>72</td>
</tr>
<tr>
<td>1022211102</td>
<td>张莉莉</td>
<td>经济系</td>
<td>王强</td>
<td>大学英语</td>
<td>98</td>
</tr>
<tr>
<td>1022211102</td>
<td>张莉莉</td>
<td>经济系</td>
<td>王强</td>
<td>计算机基础</td>
<td>88</td>
</tr>
<tr>
<td>1022511101</td>
<td>高芳芳</td>
<td>法律系</td>
<td>刘玲</td>
<td>高等数学</td>
<td>82</td>
</tr>
<tr>
<td>1022511101</td>
<td>高芳芳</td>
<td>法律系</td>
<td>刘玲</td>
<td>法律基础</td>
<td>82</td>
</tr>
</tbody>
</table>
<p>以上学生课程关系中，{学号, 课名} 为键码（主键），有如下函数依赖：</p>
<ul>
<li>（学号，课名） -&gt; 分数</li>
<li>学号 -&gt; 姓名</li>
<li>学号 -&gt; 系名 -&gt; 系主任</li>
</ul>
<p>分数完全函数依赖于键码，它没有任何冗余数据，每个学生的每门课都有特定的成绩。</p>
<p>姓名、系名和系主任都部分依赖于键码，我们需要把部分依赖变成完全依赖。</p>
<p><strong>分解后</strong> </p>
<p>关系-1</p>
<table>
<thead>
<tr>
<th>学号</th>
<th>姓名</th>
<th>系名</th>
<th>系主任</th>
</tr>
</thead>
<tbody>
<tr>
<td>1022211101</td>
<td>李小明</td>
<td>经济系</td>
<td>王强</td>
</tr>
<tr>
<td>1022211102</td>
<td>张莉莉</td>
<td>经济系</td>
<td>王强</td>
</tr>
<tr>
<td>1022211101</td>
<td>高芳芳</td>
<td>法律系</td>
<td>刘玲</td>
</tr>
</tbody>
</table>
<p>有以下函数依赖：</p>
<ul>
<li>Sno -&gt; Sname, Sdept</li>
<li>Sdept -&gt; Mname</li>
</ul>
<p>关系-2</p>
<table>
<thead>
<tr>
<th>学号</th>
<th>课名</th>
<th>分数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1022211101</td>
<td>高等数学</td>
<td>95</td>
</tr>
<tr>
<td>1022211101</td>
<td>大学英语</td>
<td>87</td>
</tr>
<tr>
<td>1022211101</td>
<td>普通化学</td>
<td>76</td>
</tr>
<tr>
<td>1022211102</td>
<td>高等数学</td>
<td>72</td>
</tr>
<tr>
<td>1022211102</td>
<td>大学英语</td>
<td>98</td>
</tr>
<tr>
<td>1022211102</td>
<td>计算机基础</td>
<td>88</td>
</tr>
<tr>
<td>1022511101</td>
<td>高等数学</td>
<td>82</td>
</tr>
<tr>
<td>1022511101</td>
<td>法学基础</td>
<td>82</td>
</tr>
</tbody>
</table>
<p>有以下函数依赖：</p>
<ul>
<li>Sno, Cname -&gt; Grade</li>
</ul>
<h4 id="第三范式-3NF"><a href="#第三范式-3NF" class="headerlink" title="第三范式 (3NF)"></a>第三范式 (3NF)</h4><p>3NF 在 2NF 的基础之上，消除了非主属性对于码（主键）的传递函数依赖</p>
<p>上面的 关系-1 中存在以下传递函数依赖：</p>
<ul>
<li>Sno -&gt; Sdept -&gt; Mname</li>
</ul>
<p>可以进行以下分解：</p>
<p>关系-11</p>
<table>
<thead>
<tr>
<th>学号</th>
<th>姓名</th>
<th>系名</th>
</tr>
</thead>
<tbody>
<tr>
<td>1022211101</td>
<td>李小明</td>
<td>经济系</td>
</tr>
<tr>
<td>1022211102</td>
<td>张莉莉</td>
<td>经济系</td>
</tr>
<tr>
<td>1022211101</td>
<td>高芳芳</td>
<td>法律系</td>
</tr>
</tbody>
</table>
<p>关系-12</p>
<table>
<thead>
<tr>
<th>系名</th>
<th>系主任</th>
</tr>
</thead>
<tbody>
<tr>
<td>经济系</td>
<td>王强</td>
</tr>
<tr>
<td>法律系</td>
<td>刘玲</td>
</tr>
</tbody>
</table>
<h3 id="范式的优缺点"><a href="#范式的优缺点" class="headerlink" title="范式的优缺点"></a>范式的优缺点</h3><p>优点：</p>
<ul>
<li>当数据较好地范式化时，就只有很少或者没有重复数据，所以更新时只需要修改更少的数据。</li>
<li>范式化的表通常更小，可以更好地放在内存里，所以执行操作很更快。</li>
<li>很少有多余的数据意味着检索列表数据时更少需要 DISTINCT 或者 GROUP BY 语句。比如前面的例子：在非范式化的结构中必须使用 DISTINCT 或者 GROUP BY 才能获得唯一的一张系名列表，但如果使用范式，只需要单独查询系名-系主任表就可以了。</li>
</ul>
<p>缺点：</p>
<ul>
<li>范式化的设计通常需要关联。稍微复杂一点的查询语句在符合范式的 schema 上都有可能需要至少一次关联，这不但代价昂贵，也可能使一些索引无效。例如，范式化可能将列存放在不同的表中，而这些列如果在一个表中本可以属于同一个索引。</li>
</ul>
<h3 id="常见反范式化设计"><a href="#常见反范式化设计" class="headerlink" title="常见反范式化设计"></a>常见反范式化设计</h3><p>范式化不一定适合所有场合，很多时候，一些冗余数据有助于我们提升性能。下面列举几个常见的反范式化操作。</p>
<h4 id="缓存表"><a href="#缓存表" class="headerlink" title="缓存表"></a>缓存表</h4><p>缓存表可以存储那些可以从其他表获取但每次获取的速度比较慢的数据。比如有时可能会需要很多不同的索引组合来加速各种类型的查询。这些矛盾的需求有时需要创建一张只包含主表中部分列的缓存表。有时候我们可能需要不同存储引擎提供的不同特性。例如，如果主表使用 innodb，用 MyISAM 作为缓存表的引擎将会得到更小的索引空间，并且可以做全文索引。</p>
<h4 id="汇总表"><a href="#汇总表" class="headerlink" title="汇总表"></a>汇总表</h4><p>汇总表保存的是 GROUP BY 语句聚合数据的表。相比缓存表，汇总表的数据不是逻辑上冗余的，但可以通过其它表计算得到。例如，计算某网站之前 24 小时内发送的消息数。我们可以通过 COUNT() 得到，但这样需要检索全表。作为替代方案，可以每小时生成一张汇总表。这样也许一条简单的查询就可以做到，并且比实时维护计数器要高效得多。缺点是计数并不是 100% 精确。</p>
<p>某网站之前 24 小时内发送的消息数的汇总表：</p>
<blockquote>
<p>CREATE TABLE msg_per_hr (<br>hr DATETIME NOT NULL,<br>cnt INT UNSIGNED NOT NULL,<br>PRIMARY KEY(hr)<br>);</p>
</blockquote>
<h4 id="计数器表"><a href="#计数器表" class="headerlink" title="计数器表"></a>计数器表</h4><p>计数器在应用中很常见。比如网站的点击数，文件下载次数等。 如果其它数据保存在一起，很可能碰到并发问题。创建一张独立的表是个比较好的办法，这样可使计数器表小且快。而且使用独立的表可以帮助避免查询缓存失效。</p>
<p>下面是一张简单的计数器表，只有一行数据，记录网站的点击次数：</p>
<blockquote>
<p>mysql&gt; CREATE TABLE hit_counter(<br>    -&gt;    cnt int unsigned not null<br>    -&gt; ) ENGINE=InnoDB;</p>
</blockquote>
<p>网站的每次点击都会导致对计数器进行更新：</p>
<blockquote>
<p>mysql&gt; UPDATE hit_counter SET cnt = cnt + 1;</p>
</blockquote>
<p>问题在于，对于任何想要更新这一行的事务来说，这条记录上都有一个全局的互斥锁。这会使得这些事务只能串行进行。要获得更高的并发性，可以将计数器保存在多个行中，每次随机选择一行更新：</p>
<blockquote>
<p>mysql&gt; CREATE TABLE hit_counter(<br>    -&gt;    slot tinyint unsigned not null primary key,<br>    -&gt;    cnt int unsigned not null<br>    -&gt; ) ENGINE=InnoDB;</p>
</blockquote>
<p>然后预先在这张表增加 100 行数据。现在选择一个随机的槽进行更新：</p>
<blockquote>
<p>mysql&gt; UPDATE hit_counter SET cnt = cnt + 1 WHERE slot = RAND() * 100;</p>
</blockquote>
<p>要获得统计结果，需要使用下面这样的聚合查询：</p>
<blockquote>
<p>mysql&gt; CREATE TABLE daily_hit_counter(<br>    -&gt;    day date not null,<br>    -&gt;    slot tinyint unsigned not null,<br>    -&gt;    cnt int unsigned not null,<br>    -&gt;    primary key(day, slot)<br>    -&gt;    ) ENGINE=InnoDB;</p>
</blockquote>
<p>一个常见的需求是每隔一段时间开始一个新的计算器（例如，每天一个）。再作进一步修改：</p>
<blockquote>
<p>mysql&gt; CREATE TABLE daily_hit_counter(<br>    -&gt;    day date not null,<br>    -&gt;    slot tinyint unsigned not null,<br>    -&gt;    cnt int unsigned not null,<br>    -&gt;    primary key(day, slot)<br>    -&gt;    ) ENGINE=InnoDB;</p>
</blockquote>
<p>在这个场景中可以不用预告生成行 ，而用 ON DUPLICATE KEY UPDATE（对唯一索引或主键字段的值会检查是否已存在，存在则更新，不存在则插入）代替：</p>
<blockquote>
<p>mysql&gt; INSERT INTO daily_hit_counter(day, slot, cnt)<br>    -&gt;    VALUES(CURRENT_DATE, RAND()*100, 1)<br>    -&gt;    ON DUPLICATE KEY UPDATE cnt = cnt + 1;</p>
</blockquote>
<p>如果希望减少表的行数，可以写一个周期执行的任务，合并所有结果到 0 号槽，并且删除所有其他的槽：</p>
<blockquote>
<p>UPDATE daily_hit_counter as c<br>    -&gt;    INNER JOIN (<br>    -&gt;       SELECT day, SUM(cnt) AS cnt, MIN(slot) AS mslot<br>    -&gt;       FROM daily_hit_counter<br>    -&gt;       GROUP BY day<br>    -&gt;    ) AS X USING(day)<br>    -&gt; SET c.cnt  = IF(c.slot = x.mslot, x.cnt, 0),<br>    -&gt;     c.slot = IF(c.slot = x.mslot, 0, c.slot);<br>mysql&gt; DELETE FROM daily_hit_counter WHERE slot &lt;&gt; 0 AND cnt = 0;</p>
</blockquote>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">MySQL</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/08/18/《高性能 MySQL》读书笔记——库表结构优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-GET 与 POST 的区别" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/15/GET 与 POST 的区别/">GET 与 POST 的区别</a>
    </h1>
  

        
        <a href="/2018/05/15/GET 与 POST 的区别/" class="archive-article-date">
  	<time datetime="2018-05-15T06:55:30.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>HTTP 定义了一组请求方法, 以表明要对给定资源执行的操作。而硕果仅存的只剩两个半（笑）。实际开发中我们常用到的一般是 POST 和 GET，极少数情况下会用到 PUT。<a href="https://tools.ietf.org/html/rfc7231#section-4" target="_blank" rel="noopener">RFC7231</a> 规范了 GET 方法用于请求一个指定资源的表示形式（transfer a current representation of the target resource），而 POST 方法用于将实体提交到指定的资源（Perform resource-specific processing on the request payload）。但仅仅了解规范是不够的，很多工具比如 chrome,nginx 有它自己履行规范的方式，从开发角度看，或许这些更有价值。</p>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>GET 传递的参数只能带 URL 后面，文本格式 QueryString，长度受限于浏览器发送长度和服务器接收长度。各家标准不一，作为开发人员宜选取其中最短一个（2083 字节）作为开发标准，以避免不必要的兼容问题。</p>
<ul>
<li>IE(Browser)　2,083 Bytes</li>
<li>Firefox(Browser)　65,536 Bytes</li>
<li>Safari(Browser)　80,000 Bytes</li>
<li>Opera(Browser)　190,000 Bytes</li>
<li>Google (chrome)　8,182 Bytes</li>
<li>Apache (Server)　8,182 Bytes</li>
<li>Microsoft Internet Information Server(IIS)　16,384 Bytes</li>
</ul>
<p>POST 的参数就比较灵活，可以传递 application/x-www-form-urlencoded 的类似 QueryString、multipart/form-data 的二进制报文格式（支持文件信息嵌入报文传输）、纯文本或二进制的 body 参数。很多时候我们把参数写在 body 里，这时参数没有长度上的限制。</p>
<h2 id="幂等"><a href="#幂等" class="headerlink" title="幂等"></a>幂等</h2><p>幂等是一个计算机术语，表示重复执行某一操作得到的结果总是相同的。在 HTTP 中，如果我们说一个 HTTP 方法是幂等的，指的是同样的请求被执行一次与连续执行多次的效果是一样的，服务器的状态也是一样的。</p>
<p>GET 是幂等的，我们使用 GET 获取服务器上同一份数据，拿到的数据应该都是相同的。每次请求后服务器的状态应该也是相同的（统计数据除外）。</p>
<p>POST 不是幂等的，多次 POST 返回的结果不一定相同，每次请求后服务器的状态也是不一样的。</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>GET 时默认可以复用前面的请求数据作为缓存结果返回，此时以完整的 URL 作为缓存数据的 KEY。所以有时候为了强制每次请求都是新数据，我们可以在 URL 后面加上一个随机参数或时间戳或版本号来避免从缓存中读取，也可以直接设置 Cache-Control 禁用缓存。</p>
<p>POST 则一般不会被这些缓存因素影响。</p>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>服务器的日志比如像 nginx 的 access log 会自动记录 GET 和 POST 的 URL，包括其中带的参数，但不会记录请求的报文。对于一些敏感数据，POST 更安全一些。</p>
<h2 id="自动化性能测试"><a href="#自动化性能测试" class="headerlink" title="自动化性能测试"></a>自动化性能测试</h2><p>基于上面提到的 nginx 日志，可以使用 grep GET+日期，awk 格式化，然后 sort -u 去重，从而提取到某天的所有 GET 请求 URL，使用程序模拟登陆，然后请求所有 URL 即可获取简单的性能测试数据，每个请求是否正确，响应时间多少等等。</p>
<p>但是对于 POST 请求，因为不知道报文，无法这样简单处理。可以通过 nginx-lua 获取报文输出到 log，这样格式化会麻烦很多，但不失为一个办法。</p>
<h2 id="TCP-包的数量"><a href="#TCP-包的数量" class="headerlink" title="TCP 包的数量"></a>TCP 包的数量</h2><p>GET 请求稳定只发送一个包，而 POST 请求在某些浏览器里会发送两个，具体的原因还在探究。</p>
<ul>
<li>IE 6 – 2 packets</li>
<li>IE 7 – 2 packets</li>
<li>IE 8 – 2 packets</li>
<li>Firefox 3.0.13 – 1 packet</li>
<li>Firefox 3.5.2 – 1 packet</li>
<li>Opera 9.27 – 2 packets</li>
<li>Safari 4.0.3 – 2 packets</li>
<li>Chrome 2.0.172.43 – 2 packets</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>1、<a href="https://www.cnblogs.com/henryhappier/archive/2010/10/09/1846554.html" target="_blank" rel="noopener">URL 最大长度问题 </a><br>2、<a href="https://blog.josephscott.org/2009/08/27/xmlhttprequest-xhr-uses-multiple-packets-for-http-post/" target="_blank" rel="noopener">xmlhttprequest-xhr-uses-multiple-packets-for-http-post</a><br>3、<a href="http://kimmking.github.io/2017/12/01/comparing-get-and-post/" target="_blank" rel="noopener">comparing-get-and-post</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">计算机网络</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/15/GET 与 POST 的区别/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-idea 常用快捷键备忘" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/08/idea 常用快捷键备忘/">idea 常用快捷键备忘</a>
    </h1>
  

        
        <a href="/2018/05/08/idea 常用快捷键备忘/" class="archive-article-date">
  	<time datetime="2018-05-08T07:00:32.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-08</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>记录一些开发中常用但不容易记住的快捷键。</p>
<h2 id="Ctrl"><a href="#Ctrl" class="headerlink" title="Ctrl"></a>Ctrl</h2><p>Ctrl + Ｙ　　　删除行<br>Ctrl + Ｒ　　　替换<br>Ctrl + Ｆ　　　当前代码中查找<br>Ctrl + Ｗ　　　选中光标所在的单词，连按范围扩大<br>Ctrl + －／＝　折叠／展开当前光标所在代码和注释<br>Ctrl + Ｉ　　　接口方法补全　</p>
<h2 id="Ctrl-Alt"><a href="#Ctrl-Alt" class="headerlink" title="Ctrl + Alt"></a>Ctrl + Alt</h2><p>Ctrl + Alt + Ｌ　　　　　　代码格式化<br>Ctrl + Alt + Ｔ　　　　　　选中的地方代码环绕提示<br>Ctrl + Alt + 空格　　　　　类名或接口名提示<br>Ctrl + Alt + 方向左／右　　回退／前进到上一个操作的地方<br>Ctrl + Alt + Ｂ　　　　　　查看一个方法的实现<br>Ctrl + Alt + Ｏ　　　　　　清除多余包</p>
<h2 id="Ctrl-Shift"><a href="#Ctrl-Shift" class="headerlink" title="Ctrl + Shift"></a>Ctrl + Shift</h2><p>Ctrl + Shift + Ｕ　　　大／小写转换<br>Ctrl + Shift + －／＝　折叠／展开当前文件下所有代码和注释</p>
<h2 id="Alt"><a href="#Alt" class="headerlink" title="Alt"></a>Alt</h2><p>Alt + 回车　　　　　智能提示<br>Alt + 方向上／下　　上／下一方法<br>Alt + Insert　　　　 类方法补全</p>
<h2 id="Shift"><a href="#Shift" class="headerlink" title="Shift"></a>Shift</h2><p>双击 Shift　　　　　在项目的所有目录查找特定内容<br>Shift ＋ F6　　　　 重命名类，方法，变量</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">备忘录</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/08/idea 常用快捷键备忘/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
    		<!-- &copy; 2019 huzb -->
		<span id="busuanzi_container_site_pv">本站总访问量		<span id="busuanzi_value_site_pv"></span>次</span>
    	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>
<script>!function (t) {
    function n(e) {
      if (r[e]) return r[e].exports;
      var i = r[e] = {exports: {}, id: e, loaded: !1};
      return t[e].call(i.exports, i, i.exports, n), i.loaded = !0, i.exports
    }

    var r = {};
    n.m = t, n.c = r, n.p = "./", n(0)
  }([function (t, n, r) {
    r(195), t.exports = r(191)
  }, function (t, n, r) {
    var e = r(3), i = r(52), o = r(27), u = r(28), c = r(53), f = "prototype", a = function (t, n, r) {
      var s, l, h, v, p = t & a.F, d = t & a.G, y = t & a.S, g = t & a.P, b = t & a.B,
        m = d ? e : y ? e[n] || (e[n] = {}) : (e[n] || {})[f], x = d ? i : i[n] || (i[n] = {}), w = x[f] || (x[f] = {});
      d && (r = n);
      for (s in r) l = !p && m && void 0 !== m[s], h = (l ? m : r)[s], v = b && l ? c(h, e) : g && "function" == typeof h ? c(Function.call, h) : h, m && u(m, s, h, t & a.U), x[s] != h && o(x, s, v), g && w[s] != h && (w[s] = h)
    };
    e.core = i, a.F = 1, a.G = 2, a.S = 4, a.P = 8, a.B = 16, a.W = 32, a.U = 64, a.R = 128, t.exports = a
  }, function (t, n, r) {
    var e = r(6);
    t.exports = function (t) {
      if (!e(t)) throw TypeError(t + " is not an object!");
      return t
    }
  }, function (t, n) {
    var r = t.exports = "undefined" != typeof window && window.Math == Math ? window : "undefined" != typeof self && self.Math == Math ? self : Function("return this")();
    "number" == typeof __g && (__g = r)
  }, function (t, n) {
    t.exports = function (t) {
      try {
        return !!t()
      } catch (t) {
        return !0
      }
    }
  }, function (t, n) {
    var r = t.exports = "undefined" != typeof window && window.Math == Math ? window : "undefined" != typeof self && self.Math == Math ? self : Function("return this")();
    "number" == typeof __g && (__g = r)
  }, function (t, n) {
    t.exports = function (t) {
      return "object" == typeof t ? null !== t : "function" == typeof t
    }
  }, function (t, n, r) {
    var e = r(126)("wks"), i = r(76), o = r(3).Symbol, u = "function" == typeof o;
    (t.exports = function (t) {
      return e[t] || (e[t] = u && o[t] || (u ? o : i)("Symbol." + t))
    }).store = e
  }, function (t, n) {
    var r = {}.hasOwnProperty;
    t.exports = function (t, n) {
      return r.call(t, n)
    }
  }, function (t, n, r) {
    var e = r(94), i = r(33);
    t.exports = function (t) {
      return e(i(t))
    }
  }, function (t, n, r) {
    t.exports = !r(4)(function () {
      return 7 != Object.defineProperty({}, "a", {
        get: function () {
          return 7
        }
      }).a
    })
  }, function (t, n, r) {
    var e = r(2), i = r(167), o = r(50), u = Object.defineProperty;
    n.f = r(10) ? Object.defineProperty : function (t, n, r) {
      if (e(t), n = o(n, !0), e(r), i) try {
        return u(t, n, r)
      } catch (t) {
      }
      if ("get" in r || "set" in r) throw TypeError("Accessors not supported!");
      return "value" in r && (t[n] = r.value), t
    }
  }, function (t, n, r) {
    t.exports = !r(18)(function () {
      return 7 != Object.defineProperty({}, "a", {
        get: function () {
          return 7
        }
      }).a
    })
  }, function (t, n, r) {
    var e = r(14), i = r(22);
    t.exports = r(12) ? function (t, n, r) {
      return e.f(t, n, i(1, r))
    } : function (t, n, r) {
      return t[n] = r, t
    }
  }, function (t, n, r) {
    var e = r(20), i = r(58), o = r(42), u = Object.defineProperty;
    n.f = r(12) ? Object.defineProperty : function (t, n, r) {
      if (e(t), n = o(n, !0), e(r), i) try {
        return u(t, n, r)
      } catch (t) {
      }
      if ("get" in r || "set" in r) throw TypeError("Accessors not supported!");
      return "value" in r && (t[n] = r.value), t
    }
  }, function (t, n, r) {
    var e = r(40)("wks"), i = r(23), o = r(5).Symbol, u = "function" == typeof o;
    (t.exports = function (t) {
      return e[t] || (e[t] = u && o[t] || (u ? o : i)("Symbol." + t))
    }).store = e
  }, function (t, n, r) {
    var e = r(67), i = Math.min;
    t.exports = function (t) {
      return t > 0 ? i(e(t), 9007199254740991) : 0
    }
  }, function (t, n, r) {
    var e = r(46);
    t.exports = function (t) {
      return Object(e(t))
    }
  }, function (t, n) {
    t.exports = function (t) {
      try {
        return !!t()
      } catch (t) {
        return !0
      }
    }
  }, function (t, n, r) {
    var e = r(63), i = r(34);
    t.exports = Object.keys || function (t) {
      return e(t, i)
    }
  }, function (t, n, r) {
    var e = r(21);
    t.exports = function (t) {
      if (!e(t)) throw TypeError(t + " is not an object!");
      return t
    }
  }, function (t, n) {
    t.exports = function (t) {
      return "object" == typeof t ? null !== t : "function" == typeof t
    }
  }, function (t, n) {
    t.exports = function (t, n) {
      return {enumerable: !(1 & t), configurable: !(2 & t), writable: !(4 & t), value: n}
    }
  }, function (t, n) {
    var r = 0, e = Math.random();
    t.exports = function (t) {
      return "Symbol(".concat(void 0 === t ? "" : t, ")_", (++r + e).toString(36))
    }
  }, function (t, n) {
    var r = {}.hasOwnProperty;
    t.exports = function (t, n) {
      return r.call(t, n)
    }
  }, function (t, n) {
    var r = t.exports = {version: "2.4.0"};
    "number" == typeof __e && (__e = r)
  }, function (t, n) {
    t.exports = function (t) {
      if ("function" != typeof t) throw TypeError(t + " is not a function!");
      return t
    }
  }, function (t, n, r) {
    var e = r(11), i = r(66);
    t.exports = r(10) ? function (t, n, r) {
      return e.f(t, n, i(1, r))
    } : function (t, n, r) {
      return t[n] = r, t
    }
  }, function (t, n, r) {
    var e = r(3), i = r(27), o = r(24), u = r(76)("src"), c = "toString", f = Function[c], a = ("" + f).split(c);
    r(52).inspectSource = function (t) {
      return f.call(t)
    }, (t.exports = function (t, n, r, c) {
      var f = "function" == typeof r;
      f && (o(r, "name") || i(r, "name", n)), t[n] !== r && (f && (o(r, u) || i(r, u, t[n] ? "" + t[n] : a.join(String(n)))), t === e ? t[n] = r : c ? t[n] ? t[n] = r : i(t, n, r) : (delete t[n], i(t, n, r)))
    })(Function.prototype, c, function () {
      return "function" == typeof this && this[u] || f.call(this)
    })
  }, function (t, n, r) {
    var e = r(1), i = r(4), o = r(46), u = function (t, n, r, e) {
      var i = String(o(t)), u = "<" + n;
      return "" !== r && (u += " " + r + '="' + String(e).replace(/"/g, "&quot;") + '"'), u + ">" + i + "</" + n + ">"
    };
    t.exports = function (t, n) {
      var r = {};
      r[t] = n(u), e(e.P + e.F * i(function () {
        var n = ""[t]('"');
        return n !== n.toLowerCase() || n.split('"').length > 3
      }), "String", r)
    }
  }, function (t, n, r) {
    var e = r(115), i = r(46);
    t.exports = function (t) {
      return e(i(t))
    }
  }, function (t, n, r) {
    var e = r(116), i = r(66), o = r(30), u = r(50), c = r(24), f = r(167), a = Object.getOwnPropertyDescriptor;
    n.f = r(10) ? a : function (t, n) {
      if (t = o(t), n = u(n, !0), f) try {
        return a(t, n)
      } catch (t) {
      }
      if (c(t, n)) return i(!e.f.call(t, n), t[n])
    }
  }, function (t, n, r) {
    var e = r(24), i = r(17), o = r(145)("IE_PROTO"), u = Object.prototype;
    t.exports = Object.getPrototypeOf || function (t) {
      return t = i(t), e(t, o) ? t[o] : "function" == typeof t.constructor && t instanceof t.constructor ? t.constructor.prototype : t instanceof Object ? u : null
    }
  }, function (t, n) {
    t.exports = function (t) {
      if (void 0 == t) throw TypeError("Can't call method on  " + t);
      return t
    }
  }, function (t, n) {
    t.exports = "constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")
  }, function (t, n) {
    t.exports = {}
  }, function (t, n) {
    t.exports = !0
  }, function (t, n) {
    n.f = {}.propertyIsEnumerable
  }, function (t, n, r) {
    var e = r(14).f, i = r(8), o = r(15)("toStringTag");
    t.exports = function (t, n, r) {
      t && !i(t = r ? t : t.prototype, o) && e(t, o, {configurable: !0, value: n})
    }
  }, function (t, n, r) {
    var e = r(40)("keys"), i = r(23);
    t.exports = function (t) {
      return e[t] || (e[t] = i(t))
    }
  }, function (t, n, r) {
    var e = r(5), i = "__core-js_shared__", o = e[i] || (e[i] = {});
    t.exports = function (t) {
      return o[t] || (o[t] = {})
    }
  }, function (t, n) {
    var r = Math.ceil, e = Math.floor;
    t.exports = function (t) {
      return isNaN(t = +t) ? 0 : (t > 0 ? e : r)(t)
    }
  }, function (t, n, r) {
    var e = r(21);
    t.exports = function (t, n) {
      if (!e(t)) return t;
      var r, i;
      if (n && "function" == typeof(r = t.toString) && !e(i = r.call(t))) return i;
      if ("function" == typeof(r = t.valueOf) && !e(i = r.call(t))) return i;
      if (!n && "function" == typeof(r = t.toString) && !e(i = r.call(t))) return i;
      throw TypeError("Can't convert object to primitive value")
    }
  }, function (t, n, r) {
    var e = r(5), i = r(25), o = r(36), u = r(44), c = r(14).f;
    t.exports = function (t) {
      var n = i.Symbol || (i.Symbol = o ? {} : e.Symbol || {});
      "_" == t.charAt(0) || t in n || c(n, t, {value: u.f(t)})
    }
  }, function (t, n, r) {
    n.f = r(15)
  }, function (t, n) {
    var r = {}.toString;
    t.exports = function (t) {
      return r.call(t).slice(8, -1)
    }
  }, function (t, n) {
    t.exports = function (t) {
      if (void 0 == t) throw TypeError("Can't call method on  " + t);
      return t
    }
  }, function (t, n, r) {
    var e = r(4);
    t.exports = function (t, n) {
      return !!t && e(function () {
        n ? t.call(null, function () {
        }, 1) : t.call(null)
      })
    }
  }, function (t, n, r) {
    var e = r(53), i = r(115), o = r(17), u = r(16), c = r(203);
    t.exports = function (t, n) {
      var r = 1 == t, f = 2 == t, a = 3 == t, s = 4 == t, l = 6 == t, h = 5 == t || l, v = n || c;
      return function (n, c, p) {
        for (var d, y, g = o(n), b = i(g), m = e(c, p, 3), x = u(b.length), w = 0, S = r ? v(n, x) : f ? v(n, 0) : void 0; x > w; w++) if ((h || w in b) && (d = b[w], y = m(d, w, g), t)) if (r) S[w] = y; else if (y) switch (t) {
          case 3:
            return !0;
          case 5:
            return d;
          case 6:
            return w;
          case 2:
            S.push(d)
        } else if (s) return !1;
        return l ? -1 : a || s ? s : S
      }
    }
  }, function (t, n, r) {
    var e = r(1), i = r(52), o = r(4);
    t.exports = function (t, n) {
      var r = (i.Object || {})[t] || Object[t], u = {};
      u[t] = n(r), e(e.S + e.F * o(function () {
        r(1)
      }), "Object", u)
    }
  }, function (t, n, r) {
    var e = r(6);
    t.exports = function (t, n) {
      if (!e(t)) return t;
      var r, i;
      if (n && "function" == typeof(r = t.toString) && !e(i = r.call(t))) return i;
      if ("function" == typeof(r = t.valueOf) && !e(i = r.call(t))) return i;
      if (!n && "function" == typeof(r = t.toString) && !e(i = r.call(t))) return i;
      throw TypeError("Can't convert object to primitive value")
    }
  }, function (t, n, r) {
    var e = r(5), i = r(25), o = r(91), u = r(13), c = "prototype", f = function (t, n, r) {
      var a, s, l, h = t & f.F, v = t & f.G, p = t & f.S, d = t & f.P, y = t & f.B, g = t & f.W,
        b = v ? i : i[n] || (i[n] = {}), m = b[c], x = v ? e : p ? e[n] : (e[n] || {})[c];
      v && (r = n);
      for (a in r) (s = !h && x && void 0 !== x[a]) && a in b || (l = s ? x[a] : r[a], b[a] = v && "function" != typeof x[a] ? r[a] : y && s ? o(l, e) : g && x[a] == l ? function (t) {
        var n = function (n, r, e) {
          if (this instanceof t) {
            switch (arguments.length) {
              case 0:
                return new t;
              case 1:
                return new t(n);
              case 2:
                return new t(n, r)
            }
            return new t(n, r, e)
          }
          return t.apply(this, arguments)
        };
        return n[c] = t[c], n
      }(l) : d && "function" == typeof l ? o(Function.call, l) : l, d && ((b.virtual || (b.virtual = {}))[a] = l, t & f.R && m && !m[a] && u(m, a, l)))
    };
    f.F = 1, f.G = 2, f.S = 4, f.P = 8, f.B = 16, f.W = 32, f.U = 64, f.R = 128, t.exports = f
  }, function (t, n) {
    var r = t.exports = {version: "2.4.0"};
    "number" == typeof __e && (__e = r)
  }, function (t, n, r) {
    var e = r(26);
    t.exports = function (t, n, r) {
      if (e(t), void 0 === n) return t;
      switch (r) {
        case 1:
          return function (r) {
            return t.call(n, r)
          };
        case 2:
          return function (r, e) {
            return t.call(n, r, e)
          };
        case 3:
          return function (r, e, i) {
            return t.call(n, r, e, i)
          }
      }
      return function () {
        return t.apply(n, arguments)
      }
    }
  }, function (t, n, r) {
    var e = r(183), i = r(1), o = r(126)("metadata"), u = o.store || (o.store = new (r(186))), c = function (t, n, r) {
      var i = u.get(t);
      if (!i) {
        if (!r) return;
        u.set(t, i = new e)
      }
      var o = i.get(n);
      if (!o) {
        if (!r) return;
        i.set(n, o = new e)
      }
      return o
    }, f = function (t, n, r) {
      var e = c(n, r, !1);
      return void 0 !== e && e.has(t)
    }, a = function (t, n, r) {
      var e = c(n, r, !1);
      return void 0 === e ? void 0 : e.get(t)
    }, s = function (t, n, r, e) {
      c(r, e, !0).set(t, n)
    }, l = function (t, n) {
      var r = c(t, n, !1), e = [];
      return r && r.forEach(function (t, n) {
        e.push(n)
      }), e
    }, h = function (t) {
      return void 0 === t || "symbol" == typeof t ? t : String(t)
    }, v = function (t) {
      i(i.S, "Reflect", t)
    };
    t.exports = {store: u, map: c, has: f, get: a, set: s, keys: l, key: h, exp: v}
  }, function (t, n, r) {
    "use strict";
    if (r(10)) {
      var e = r(69), i = r(3), o = r(4), u = r(1), c = r(127), f = r(152), a = r(53), s = r(68), l = r(66), h = r(27),
        v = r(73), p = r(67), d = r(16), y = r(75), g = r(50), b = r(24), m = r(180), x = r(114), w = r(6), S = r(17),
        _ = r(137), O = r(70), E = r(32), P = r(71).f, j = r(154), F = r(76), M = r(7), A = r(48), N = r(117),
        T = r(146), I = r(155), k = r(80), L = r(123), R = r(74), C = r(130), D = r(160), U = r(11), W = r(31), G = U.f,
        B = W.f, V = i.RangeError, z = i.TypeError, q = i.Uint8Array, K = "ArrayBuffer", J = "Shared" + K,
        Y = "BYTES_PER_ELEMENT", H = "prototype", $ = Array[H], X = f.ArrayBuffer, Q = f.DataView, Z = A(0), tt = A(2),
        nt = A(3), rt = A(4), et = A(5), it = A(6), ot = N(!0), ut = N(!1), ct = I.values, ft = I.keys, at = I.entries,
        st = $.lastIndexOf, lt = $.reduce, ht = $.reduceRight, vt = $.join, pt = $.sort, dt = $.slice, yt = $.toString,
        gt = $.toLocaleString, bt = M("iterator"), mt = M("toStringTag"), xt = F("typed_constructor"),
        wt = F("def_constructor"), St = c.CONSTR, _t = c.TYPED, Ot = c.VIEW, Et = "Wrong length!",
        Pt = A(1, function (t, n) {
          return Tt(T(t, t[wt]), n)
        }), jt = o(function () {
          return 1 === new q(new Uint16Array([1]).buffer)[0]
        }), Ft = !!q && !!q[H].set && o(function () {
          new q(1).set({})
        }), Mt = function (t, n) {
          if (void 0 === t) throw z(Et);
          var r = +t, e = d(t);
          if (n && !m(r, e)) throw V(Et);
          return e
        }, At = function (t, n) {
          var r = p(t);
          if (r < 0 || r % n) throw V("Wrong offset!");
          return r
        }, Nt = function (t) {
          if (w(t) && _t in t) return t;
          throw z(t + " is not a typed array!")
        }, Tt = function (t, n) {
          if (!(w(t) && xt in t)) throw z("It is not a typed array constructor!");
          return new t(n)
        }, It = function (t, n) {
          return kt(T(t, t[wt]), n)
        }, kt = function (t, n) {
          for (var r = 0, e = n.length, i = Tt(t, e); e > r;) i[r] = n[r++];
          return i
        }, Lt = function (t, n, r) {
          G(t, n, {
            get: function () {
              return this._d[r]
            }
          })
        }, Rt = function (t) {
          var n, r, e, i, o, u, c = S(t), f = arguments.length, s = f > 1 ? arguments[1] : void 0, l = void 0 !== s,
            h = j(c);
          if (void 0 != h && !_(h)) {
            for (u = h.call(c), e = [], n = 0; !(o = u.next()).done; n++) e.push(o.value);
            c = e
          }
          for (l && f > 2 && (s = a(s, arguments[2], 2)), n = 0, r = d(c.length), i = Tt(this, r); r > n; n++) i[n] = l ? s(c[n], n) : c[n];
          return i
        }, Ct = function () {
          for (var t = 0, n = arguments.length, r = Tt(this, n); n > t;) r[t] = arguments[t++];
          return r
        }, Dt = !!q && o(function () {
          gt.call(new q(1))
        }), Ut = function () {
          return gt.apply(Dt ? dt.call(Nt(this)) : Nt(this), arguments)
        }, Wt = {
          copyWithin: function (t, n) {
            return D.call(Nt(this), t, n, arguments.length > 2 ? arguments[2] : void 0)
          }, every: function (t) {
            return rt(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, fill: function (t) {
            return C.apply(Nt(this), arguments)
          }, filter: function (t) {
            return It(this, tt(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0))
          }, find: function (t) {
            return et(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, findIndex: function (t) {
            return it(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, forEach: function (t) {
            Z(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, indexOf: function (t) {
            return ut(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, includes: function (t) {
            return ot(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, join: function (t) {
            return vt.apply(Nt(this), arguments)
          }, lastIndexOf: function (t) {
            return st.apply(Nt(this), arguments)
          }, map: function (t) {
            return Pt(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, reduce: function (t) {
            return lt.apply(Nt(this), arguments)
          }, reduceRight: function (t) {
            return ht.apply(Nt(this), arguments)
          }, reverse: function () {
            for (var t, n = this, r = Nt(n).length, e = Math.floor(r / 2), i = 0; i < e;) t = n[i], n[i++] = n[--r], n[r] = t;
            return n
          }, some: function (t) {
            return nt(Nt(this), t, arguments.length > 1 ? arguments[1] : void 0)
          }, sort: function (t) {
            return pt.call(Nt(this), t)
          }, subarray: function (t, n) {
            var r = Nt(this), e = r.length, i = y(t, e);
            return new (T(r, r[wt]))(r.buffer, r.byteOffset + i * r.BYTES_PER_ELEMENT, d((void 0 === n ? e : y(n, e)) - i))
          }
        }, Gt = function (t, n) {
          return It(this, dt.call(Nt(this), t, n))
        }, Bt = function (t) {
          Nt(this);
          var n = At(arguments[1], 1), r = this.length, e = S(t), i = d(e.length), o = 0;
          if (i + n > r) throw V(Et);
          for (; o < i;) this[n + o] = e[o++]
        }, Vt = {
          entries: function () {
            return at.call(Nt(this))
          }, keys: function () {
            return ft.call(Nt(this))
          }, values: function () {
            return ct.call(Nt(this))
          }
        }, zt = function (t, n) {
          return w(t) && t[_t] && "symbol" != typeof n && n in t && String(+n) == String(n)
        }, qt = function (t, n) {
          return zt(t, n = g(n, !0)) ? l(2, t[n]) : B(t, n)
        }, Kt = function (t, n, r) {
          return !(zt(t, n = g(n, !0)) && w(r) && b(r, "value")) || b(r, "get") || b(r, "set") || r.configurable || b(r, "writable") && !r.writable || b(r, "enumerable") && !r.enumerable ? G(t, n, r) : (t[n] = r.value, t)
        };
      St || (W.f = qt, U.f = Kt), u(u.S + u.F * !St, "Object", {
        getOwnPropertyDescriptor: qt,
        defineProperty: Kt
      }), o(function () {
        yt.call({})
      }) && (yt = gt = function () {
        return vt.call(this)
      });
      var Jt = v({}, Wt);
      v(Jt, Vt), h(Jt, bt, Vt.values), v(Jt, {
        slice: Gt, set: Bt, constructor: function () {
        }, toString: yt, toLocaleString: Ut
      }), Lt(Jt, "buffer", "b"), Lt(Jt, "byteOffset", "o"), Lt(Jt, "byteLength", "l"), Lt(Jt, "length", "e"), G(Jt, mt, {
        get: function () {
          return this[_t]
        }
      }), t.exports = function (t, n, r, f) {
        f = !!f;
        var a = t + (f ? "Clamped" : "") + "Array", l = "Uint8Array" != a, v = "get" + t, p = "set" + t, y = i[a],
          g = y || {}, b = y && E(y), m = !y || !c.ABV, S = {}, _ = y && y[H], j = function (t, r) {
            var e = t._d;
            return e.v[v](r * n + e.o, jt)
          }, F = function (t, r, e) {
            var i = t._d;
            f && (e = (e = Math.round(e)) < 0 ? 0 : e > 255 ? 255 : 255 & e), i.v[p](r * n + i.o, e, jt)
          }, M = function (t, n) {
            G(t, n, {
              get: function () {
                return j(this, n)
              }, set: function (t) {
                return F(this, n, t)
              }, enumerable: !0
            })
          };
        m ? (y = r(function (t, r, e, i) {
          s(t, y, a, "_d");
          var o, u, c, f, l = 0, v = 0;
          if (w(r)) {
            if (!(r instanceof X || (f = x(r)) == K || f == J)) return _t in r ? kt(y, r) : Rt.call(y, r);
            o = r, v = At(e, n);
            var p = r.byteLength;
            if (void 0 === i) {
              if (p % n) throw V(Et);
              if ((u = p - v) < 0) throw V(Et)
            } else if ((u = d(i) * n) + v > p) throw V(Et);
            c = u / n
          } else c = Mt(r, !0), u = c * n, o = new X(u);
          for (h(t, "_d", {b: o, o: v, l: u, e: c, v: new Q(o)}); l < c;) M(t, l++)
        }), _ = y[H] = O(Jt), h(_, "constructor", y)) : L(function (t) {
          new y(null), new y(t)
        }, !0) || (y = r(function (t, r, e, i) {
          s(t, y, a);
          var o;
          return w(r) ? r instanceof X || (o = x(r)) == K || o == J ? void 0 !== i ? new g(r, At(e, n), i) : void 0 !== e ? new g(r, At(e, n)) : new g(r) : _t in r ? kt(y, r) : Rt.call(y, r) : new g(Mt(r, l))
        }), Z(b !== Function.prototype ? P(g).concat(P(b)) : P(g), function (t) {
          t in y || h(y, t, g[t])
        }), y[H] = _, e || (_.constructor = y));
        var A = _[bt], N = !!A && ("values" == A.name || void 0 == A.name), T = Vt.values;
        h(y, xt, !0), h(_, _t, a), h(_, Ot, !0), h(_, wt, y), (f ? new y(1)[mt] == a : mt in _) || G(_, mt, {
          get: function () {
            return a
          }
        }), S[a] = y, u(u.G + u.W + u.F * (y != g), S), u(u.S, a, {
          BYTES_PER_ELEMENT: n,
          from: Rt,
          of: Ct
        }), Y in _ || h(_, Y, n), u(u.P, a, Wt), R(a), u(u.P + u.F * Ft, a, {set: Bt}), u(u.P + u.F * !N, a, Vt), u(u.P + u.F * (_.toString != yt), a, {toString: yt}), u(u.P + u.F * o(function () {
          new y(1).slice()
        }), a, {slice: Gt}), u(u.P + u.F * (o(function () {
          return [1, 2].toLocaleString() != new y([1, 2]).toLocaleString()
        }) || !o(function () {
          _.toLocaleString.call([1, 2])
        })), a, {toLocaleString: Ut}), k[a] = N ? A : T, e || N || h(_, bt, T)
      }
    } else t.exports = function () {
    }
  }, function (t, n) {
    var r = {}.toString;
    t.exports = function (t) {
      return r.call(t).slice(8, -1)
    }
  }, function (t, n, r) {
    var e = r(21), i = r(5).document, o = e(i) && e(i.createElement);
    t.exports = function (t) {
      return o ? i.createElement(t) : {}
    }
  }, function (t, n, r) {
    t.exports = !r(12) && !r(18)(function () {
      return 7 != Object.defineProperty(r(57)("div"), "a", {
        get: function () {
          return 7
        }
      }).a
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(36), i = r(51), o = r(64), u = r(13), c = r(8), f = r(35), a = r(96), s = r(38), l = r(103),
      h = r(15)("iterator"), v = !([].keys && "next" in [].keys()), p = "keys", d = "values", y = function () {
        return this
      };
    t.exports = function (t, n, r, g, b, m, x) {
      a(r, n, g);
      var w, S, _, O = function (t) {
          if (!v && t in F) return F[t];
          switch (t) {
            case p:
            case d:
              return function () {
                return new r(this, t)
              }
          }
          return function () {
            return new r(this, t)
          }
        }, E = n + " Iterator", P = b == d, j = !1, F = t.prototype, M = F[h] || F["@@iterator"] || b && F[b],
        A = M || O(b), N = b ? P ? O("entries") : A : void 0, T = "Array" == n ? F.entries || M : M;
      if (T && (_ = l(T.call(new t))) !== Object.prototype && (s(_, E, !0), e || c(_, h) || u(_, h, y)), P && M && M.name !== d && (j = !0, A = function () {
          return M.call(this)
        }), e && !x || !v && !j && F[h] || u(F, h, A), f[n] = A, f[E] = y, b) if (w = {
          values: P ? A : O(d),
          keys: m ? A : O(p),
          entries: N
        }, x) for (S in w) S in F || o(F, S, w[S]); else i(i.P + i.F * (v || j), n, w);
      return w
    }
  }, function (t, n, r) {
    var e = r(20), i = r(100), o = r(34), u = r(39)("IE_PROTO"), c = function () {
    }, f = "prototype", a = function () {
      var t, n = r(57)("iframe"), e = o.length;
      for (n.style.display = "none", r(93).appendChild(n), n.src = "javascript:", t = n.contentWindow.document, t.open(), t.write("<script>document.F=Object<\/script>"), t.close(), a = t.F; e--;) delete a[f][o[e]];
      return a()
    };
    t.exports = Object.create || function (t, n) {
      var r;
      return null !== t ? (c[f] = e(t), r = new c, c[f] = null, r[u] = t) : r = a(), void 0 === n ? r : i(r, n)
    }
  }, function (t, n, r) {
    var e = r(63), i = r(34).concat("length", "prototype");
    n.f = Object.getOwnPropertyNames || function (t) {
      return e(t, i)
    }
  }, function (t, n) {
    n.f = Object.getOwnPropertySymbols
  }, function (t, n, r) {
    var e = r(8), i = r(9), o = r(90)(!1), u = r(39)("IE_PROTO");
    t.exports = function (t, n) {
      var r, c = i(t), f = 0, a = [];
      for (r in c) r != u && e(c, r) && a.push(r);
      for (; n.length > f;) e(c, r = n[f++]) && (~o(a, r) || a.push(r));
      return a
    }
  }, function (t, n, r) {
    t.exports = r(13)
  }, function (t, n, r) {
    var e = r(76)("meta"), i = r(6), o = r(24), u = r(11).f, c = 0, f = Object.isExtensible || function () {
      return !0
    }, a = !r(4)(function () {
      return f(Object.preventExtensions({}))
    }), s = function (t) {
      u(t, e, {value: {i: "O" + ++c, w: {}}})
    }, l = function (t, n) {
      if (!i(t)) return "symbol" == typeof t ? t : ("string" == typeof t ? "S" : "P") + t;
      if (!o(t, e)) {
        if (!f(t)) return "F";
        if (!n) return "E";
        s(t)
      }
      return t[e].i
    }, h = function (t, n) {
      if (!o(t, e)) {
        if (!f(t)) return !0;
        if (!n) return !1;
        s(t)
      }
      return t[e].w
    }, v = function (t) {
      return a && p.NEED && f(t) && !o(t, e) && s(t), t
    }, p = t.exports = {KEY: e, NEED: !1, fastKey: l, getWeak: h, onFreeze: v}
  }, function (t, n) {
    t.exports = function (t, n) {
      return {enumerable: !(1 & t), configurable: !(2 & t), writable: !(4 & t), value: n}
    }
  }, function (t, n) {
    var r = Math.ceil, e = Math.floor;
    t.exports = function (t) {
      return isNaN(t = +t) ? 0 : (t > 0 ? e : r)(t)
    }
  }, function (t, n) {
    t.exports = function (t, n, r, e) {
      if (!(t instanceof n) || void 0 !== e && e in t) throw TypeError(r + ": incorrect invocation!");
      return t
    }
  }, function (t, n) {
    t.exports = !1
  }, function (t, n, r) {
    var e = r(2), i = r(173), o = r(133), u = r(145)("IE_PROTO"), c = function () {
    }, f = "prototype", a = function () {
      var t, n = r(132)("iframe"), e = o.length;
      for (n.style.display = "none", r(135).appendChild(n), n.src = "javascript:", t = n.contentWindow.document, t.open(), t.write("<script>document.F=Object<\/script>"), t.close(), a = t.F; e--;) delete a[f][o[e]];
      return a()
    };
    t.exports = Object.create || function (t, n) {
      var r;
      return null !== t ? (c[f] = e(t), r = new c, c[f] = null, r[u] = t) : r = a(), void 0 === n ? r : i(r, n)
    }
  }, function (t, n, r) {
    var e = r(175), i = r(133).concat("length", "prototype");
    n.f = Object.getOwnPropertyNames || function (t) {
      return e(t, i)
    }
  }, function (t, n, r) {
    var e = r(175), i = r(133);
    t.exports = Object.keys || function (t) {
      return e(t, i)
    }
  }, function (t, n, r) {
    var e = r(28);
    t.exports = function (t, n, r) {
      for (var i in n) e(t, i, n[i], r);
      return t
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(3), i = r(11), o = r(10), u = r(7)("species");
    t.exports = function (t) {
      var n = e[t];
      o && n && !n[u] && i.f(n, u, {
        configurable: !0, get: function () {
          return this
        }
      })
    }
  }, function (t, n, r) {
    var e = r(67), i = Math.max, o = Math.min;
    t.exports = function (t, n) {
      return t = e(t), t < 0 ? i(t + n, 0) : o(t, n)
    }
  }, function (t, n) {
    var r = 0, e = Math.random();
    t.exports = function (t) {
      return "Symbol(".concat(void 0 === t ? "" : t, ")_", (++r + e).toString(36))
    }
  }, function (t, n, r) {
    var e = r(33);
    t.exports = function (t) {
      return Object(e(t))
    }
  }, function (t, n, r) {
    var e = r(7)("unscopables"), i = Array.prototype;
    void 0 == i[e] && r(27)(i, e, {}), t.exports = function (t) {
      i[e][t] = !0
    }
  }, function (t, n, r) {
    var e = r(53), i = r(169), o = r(137), u = r(2), c = r(16), f = r(154), a = {}, s = {},
      n = t.exports = function (t, n, r, l, h) {
        var v, p, d, y, g = h ? function () {
          return t
        } : f(t), b = e(r, l, n ? 2 : 1), m = 0;
        if ("function" != typeof g) throw TypeError(t + " is not iterable!");
        if (o(g)) {
          for (v = c(t.length); v > m; m++) if ((y = n ? b(u(p = t[m])[0], p[1]) : b(t[m])) === a || y === s) return y
        } else for (d = g.call(t); !(p = d.next()).done;) if ((y = i(d, b, p.value, n)) === a || y === s) return y
      };
    n.BREAK = a, n.RETURN = s
  }, function (t, n) {
    t.exports = {}
  }, function (t, n, r) {
    var e = r(11).f, i = r(24), o = r(7)("toStringTag");
    t.exports = function (t, n, r) {
      t && !i(t = r ? t : t.prototype, o) && e(t, o, {configurable: !0, value: n})
    }
  }, function (t, n, r) {
    var e = r(1), i = r(46), o = r(4), u = r(150), c = "[" + u + "]", f = "​", a = RegExp("^" + c + c + "*"),
      s = RegExp(c + c + "*$"), l = function (t, n, r) {
        var i = {}, c = o(function () {
          return !!u[t]() || f[t]() != f
        }), a = i[t] = c ? n(h) : u[t];
        r && (i[r] = a), e(e.P + e.F * c, "String", i)
      }, h = l.trim = function (t, n) {
        return t = String(i(t)), 1 & n && (t = t.replace(a, "")), 2 & n && (t = t.replace(s, "")), t
      };
    t.exports = l
  }, function (t, n, r) {
    t.exports = {default: r(86), __esModule: !0}
  }, function (t, n, r) {
    t.exports = {default: r(87), __esModule: !0}
  }, function (t, n, r) {
    "use strict";

    function e(t) {
      return t && t.__esModule ? t : {default: t}
    }

    n.__esModule = !0;
    var i = r(84), o = e(i), u = r(83), c = e(u),
      f = "function" == typeof c.default && "symbol" == typeof o.default ? function (t) {
        return typeof t
      } : function (t) {
        return t && "function" == typeof c.default && t.constructor === c.default && t !== c.default.prototype ? "symbol" : typeof t
      };
    n.default = "function" == typeof c.default && "symbol" === f(o.default) ? function (t) {
      return void 0 === t ? "undefined" : f(t)
    } : function (t) {
      return t && "function" == typeof c.default && t.constructor === c.default && t !== c.default.prototype ? "symbol" : void 0 === t ? "undefined" : f(t)
    }
  }, function (t, n, r) {
    r(110), r(108), r(111), r(112), t.exports = r(25).Symbol
  }, function (t, n, r) {
    r(109), r(113), t.exports = r(44).f("iterator")
  }, function (t, n) {
    t.exports = function (t) {
      if ("function" != typeof t) throw TypeError(t + " is not a function!");
      return t
    }
  }, function (t, n) {
    t.exports = function () {
    }
  }, function (t, n, r) {
    var e = r(9), i = r(106), o = r(105);
    t.exports = function (t) {
      return function (n, r, u) {
        var c, f = e(n), a = i(f.length), s = o(u, a);
        if (t && r != r) {
          for (; a > s;) if ((c = f[s++]) != c) return !0
        } else for (; a > s; s++) if ((t || s in f) && f[s] === r) return t || s || 0;
        return !t && -1
      }
    }
  }, function (t, n, r) {
    var e = r(88);
    t.exports = function (t, n, r) {
      if (e(t), void 0 === n) return t;
      switch (r) {
        case 1:
          return function (r) {
            return t.call(n, r)
          };
        case 2:
          return function (r, e) {
            return t.call(n, r, e)
          };
        case 3:
          return function (r, e, i) {
            return t.call(n, r, e, i)
          }
      }
      return function () {
        return t.apply(n, arguments)
      }
    }
  }, function (t, n, r) {
    var e = r(19), i = r(62), o = r(37);
    t.exports = function (t) {
      var n = e(t), r = i.f;
      if (r) for (var u, c = r(t), f = o.f, a = 0; c.length > a;) f.call(t, u = c[a++]) && n.push(u);
      return n
    }
  }, function (t, n, r) {
    t.exports = r(5).document && document.documentElement
  }, function (t, n, r) {
    var e = r(56);
    t.exports = Object("z").propertyIsEnumerable(0) ? Object : function (t) {
      return "String" == e(t) ? t.split("") : Object(t)
    }
  }, function (t, n, r) {
    var e = r(56);
    t.exports = Array.isArray || function (t) {
      return "Array" == e(t)
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(60), i = r(22), o = r(38), u = {};
    r(13)(u, r(15)("iterator"), function () {
      return this
    }), t.exports = function (t, n, r) {
      t.prototype = e(u, {next: i(1, r)}), o(t, n + " Iterator")
    }
  }, function (t, n) {
    t.exports = function (t, n) {
      return {value: n, done: !!t}
    }
  }, function (t, n, r) {
    var e = r(19), i = r(9);
    t.exports = function (t, n) {
      for (var r, o = i(t), u = e(o), c = u.length, f = 0; c > f;) if (o[r = u[f++]] === n) return r
    }
  }, function (t, n, r) {
    var e = r(23)("meta"), i = r(21), o = r(8), u = r(14).f, c = 0, f = Object.isExtensible || function () {
      return !0
    }, a = !r(18)(function () {
      return f(Object.preventExtensions({}))
    }), s = function (t) {
      u(t, e, {value: {i: "O" + ++c, w: {}}})
    }, l = function (t, n) {
      if (!i(t)) return "symbol" == typeof t ? t : ("string" == typeof t ? "S" : "P") + t;
      if (!o(t, e)) {
        if (!f(t)) return "F";
        if (!n) return "E";
        s(t)
      }
      return t[e].i
    }, h = function (t, n) {
      if (!o(t, e)) {
        if (!f(t)) return !0;
        if (!n) return !1;
        s(t)
      }
      return t[e].w
    }, v = function (t) {
      return a && p.NEED && f(t) && !o(t, e) && s(t), t
    }, p = t.exports = {KEY: e, NEED: !1, fastKey: l, getWeak: h, onFreeze: v}
  }, function (t, n, r) {
    var e = r(14), i = r(20), o = r(19);
    t.exports = r(12) ? Object.defineProperties : function (t, n) {
      i(t);
      for (var r, u = o(n), c = u.length, f = 0; c > f;) e.f(t, r = u[f++], n[r]);
      return t
    }
  }, function (t, n, r) {
    var e = r(37), i = r(22), o = r(9), u = r(42), c = r(8), f = r(58), a = Object.getOwnPropertyDescriptor;
    n.f = r(12) ? a : function (t, n) {
      if (t = o(t), n = u(n, !0), f) try {
        return a(t, n)
      } catch (t) {
      }
      if (c(t, n)) return i(!e.f.call(t, n), t[n])
    }
  }, function (t, n, r) {
    var e = r(9), i = r(61).f, o = {}.toString,
      u = "object" == typeof window && window && Object.getOwnPropertyNames ? Object.getOwnPropertyNames(window) : [],
      c = function (t) {
        try {
          return i(t)
        } catch (t) {
          return u.slice()
        }
      };
    t.exports.f = function (t) {
      return u && "[object Window]" == o.call(t) ? c(t) : i(e(t))
    }
  }, function (t, n, r) {
    var e = r(8), i = r(77), o = r(39)("IE_PROTO"), u = Object.prototype;
    t.exports = Object.getPrototypeOf || function (t) {
      return t = i(t), e(t, o) ? t[o] : "function" == typeof t.constructor && t instanceof t.constructor ? t.constructor.prototype : t instanceof Object ? u : null
    }
  }, function (t, n, r) {
    var e = r(41), i = r(33);
    t.exports = function (t) {
      return function (n, r) {
        var o, u, c = String(i(n)), f = e(r), a = c.length;
        return f < 0 || f >= a ? t ? "" : void 0 : (o = c.charCodeAt(f), o < 55296 || o > 56319 || f + 1 === a || (u = c.charCodeAt(f + 1)) < 56320 || u > 57343 ? t ? c.charAt(f) : o : t ? c.slice(f, f + 2) : u - 56320 + (o - 55296 << 10) + 65536)
      }
    }
  }, function (t, n, r) {
    var e = r(41), i = Math.max, o = Math.min;
    t.exports = function (t, n) {
      return t = e(t), t < 0 ? i(t + n, 0) : o(t, n)
    }
  }, function (t, n, r) {
    var e = r(41), i = Math.min;
    t.exports = function (t) {
      return t > 0 ? i(e(t), 9007199254740991) : 0
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(89), i = r(97), o = r(35), u = r(9);
    t.exports = r(59)(Array, "Array", function (t, n) {
      this._t = u(t), this._i = 0, this._k = n
    }, function () {
      var t = this._t, n = this._k, r = this._i++;
      return !t || r >= t.length ? (this._t = void 0, i(1)) : "keys" == n ? i(0, r) : "values" == n ? i(0, t[r]) : i(0, [r, t[r]])
    }, "values"), o.Arguments = o.Array, e("keys"), e("values"), e("entries")
  }, function (t, n) {
  }, function (t, n, r) {
    "use strict";
    var e = r(104)(!0);
    r(59)(String, "String", function (t) {
      this._t = String(t), this._i = 0
    }, function () {
      var t, n = this._t, r = this._i;
      return r >= n.length ? {value: void 0, done: !0} : (t = e(n, r), this._i += t.length, {value: t, done: !1})
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(5), i = r(8), o = r(12), u = r(51), c = r(64), f = r(99).KEY, a = r(18), s = r(40), l = r(38), h = r(23),
      v = r(15), p = r(44), d = r(43), y = r(98), g = r(92), b = r(95), m = r(20), x = r(9), w = r(42), S = r(22),
      _ = r(60), O = r(102), E = r(101), P = r(14), j = r(19), F = E.f, M = P.f, A = O.f, N = e.Symbol, T = e.JSON,
      I = T && T.stringify, k = "prototype", L = v("_hidden"), R = v("toPrimitive"), C = {}.propertyIsEnumerable,
      D = s("symbol-registry"), U = s("symbols"), W = s("op-symbols"), G = Object[k], B = "function" == typeof N,
      V = e.QObject, z = !V || !V[k] || !V[k].findChild, q = o && a(function () {
        return 7 != _(M({}, "a", {
          get: function () {
            return M(this, "a", {value: 7}).a
          }
        })).a
      }) ? function (t, n, r) {
        var e = F(G, n);
        e && delete G[n], M(t, n, r), e && t !== G && M(G, n, e)
      } : M, K = function (t) {
        var n = U[t] = _(N[k]);
        return n._k = t, n
      }, J = B && "symbol" == typeof N.iterator ? function (t) {
        return "symbol" == typeof t
      } : function (t) {
        return t instanceof N
      }, Y = function (t, n, r) {
        return t === G && Y(W, n, r), m(t), n = w(n, !0), m(r), i(U, n) ? (r.enumerable ? (i(t, L) && t[L][n] && (t[L][n] = !1), r = _(r, {enumerable: S(0, !1)})) : (i(t, L) || M(t, L, S(1, {})), t[L][n] = !0), q(t, n, r)) : M(t, n, r)
      }, H = function (t, n) {
        m(t);
        for (var r, e = g(n = x(n)), i = 0, o = e.length; o > i;) Y(t, r = e[i++], n[r]);
        return t
      }, $ = function (t, n) {
        return void 0 === n ? _(t) : H(_(t), n)
      }, X = function (t) {
        var n = C.call(this, t = w(t, !0));
        return !(this === G && i(U, t) && !i(W, t)) && (!(n || !i(this, t) || !i(U, t) || i(this, L) && this[L][t]) || n)
      }, Q = function (t, n) {
        if (t = x(t), n = w(n, !0), t !== G || !i(U, n) || i(W, n)) {
          var r = F(t, n);
          return !r || !i(U, n) || i(t, L) && t[L][n] || (r.enumerable = !0), r
        }
      }, Z = function (t) {
        for (var n, r = A(x(t)), e = [], o = 0; r.length > o;) i(U, n = r[o++]) || n == L || n == f || e.push(n);
        return e
      }, tt = function (t) {
        for (var n, r = t === G, e = A(r ? W : x(t)), o = [], u = 0; e.length > u;) !i(U, n = e[u++]) || r && !i(G, n) || o.push(U[n]);
        return o
      };
    B || (N = function () {
      if (this instanceof N) throw TypeError("Symbol is not a constructor!");
      var t = h(arguments.length > 0 ? arguments[0] : void 0), n = function (r) {
        this === G && n.call(W, r), i(this, L) && i(this[L], t) && (this[L][t] = !1), q(this, t, S(1, r))
      };
      return o && z && q(G, t, {configurable: !0, set: n}), K(t)
    }, c(N[k], "toString", function () {
      return this._k
    }), E.f = Q, P.f = Y, r(61).f = O.f = Z, r(37).f = X, r(62).f = tt, o && !r(36) && c(G, "propertyIsEnumerable", X, !0), p.f = function (t) {
      return K(v(t))
    }), u(u.G + u.W + u.F * !B, {Symbol: N});
    for (var nt = "hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","), rt = 0; nt.length > rt;) v(nt[rt++]);
    for (var nt = j(v.store), rt = 0; nt.length > rt;) d(nt[rt++]);
    u(u.S + u.F * !B, "Symbol", {
      for: function (t) {
        return i(D, t += "") ? D[t] : D[t] = N(t)
      }, keyFor: function (t) {
        if (J(t)) return y(D, t);
        throw TypeError(t + " is not a symbol!")
      }, useSetter: function () {
        z = !0
      }, useSimple: function () {
        z = !1
      }
    }), u(u.S + u.F * !B, "Object", {
      create: $,
      defineProperty: Y,
      defineProperties: H,
      getOwnPropertyDescriptor: Q,
      getOwnPropertyNames: Z,
      getOwnPropertySymbols: tt
    }), T && u(u.S + u.F * (!B || a(function () {
      var t = N();
      return "[null]" != I([t]) || "{}" != I({a: t}) || "{}" != I(Object(t))
    })), "JSON", {
      stringify: function (t) {
        if (void 0 !== t && !J(t)) {
          for (var n, r, e = [t], i = 1; arguments.length > i;) e.push(arguments[i++]);
          return n = e[1], "function" == typeof n && (r = n), !r && b(n) || (n = function (t, n) {
            if (r && (n = r.call(this, t, n)), !J(n)) return n
          }), e[1] = n, I.apply(T, e)
        }
      }
    }), N[k][R] || r(13)(N[k], R, N[k].valueOf), l(N, "Symbol"), l(Math, "Math", !0), l(e.JSON, "JSON", !0)
  }, function (t, n, r) {
    r(43)("asyncIterator")
  }, function (t, n, r) {
    r(43)("observable")
  }, function (t, n, r) {
    r(107);
    for (var e = r(5), i = r(13), o = r(35), u = r(15)("toStringTag"), c = ["NodeList", "DOMTokenList", "MediaList", "StyleSheetList", "CSSRuleList"], f = 0; f < 5; f++) {
      var a = c[f], s = e[a], l = s && s.prototype;
      l && !l[u] && i(l, u, a), o[a] = o.Array
    }
  }, function (t, n, r) {
    var e = r(45), i = r(7)("toStringTag"), o = "Arguments" == e(function () {
      return arguments
    }()), u = function (t, n) {
      try {
        return t[n]
      } catch (t) {
      }
    };
    t.exports = function (t) {
      var n, r, c;
      return void 0 === t ? "Undefined" : null === t ? "Null" : "string" == typeof(r = u(n = Object(t), i)) ? r : o ? e(n) : "Object" == (c = e(n)) && "function" == typeof n.callee ? "Arguments" : c
    }
  }, function (t, n, r) {
    var e = r(45);
    t.exports = Object("z").propertyIsEnumerable(0) ? Object : function (t) {
      return "String" == e(t) ? t.split("") : Object(t)
    }
  }, function (t, n) {
    n.f = {}.propertyIsEnumerable
  }, function (t, n, r) {
    var e = r(30), i = r(16), o = r(75);
    t.exports = function (t) {
      return function (n, r, u) {
        var c, f = e(n), a = i(f.length), s = o(u, a);
        if (t && r != r) {
          for (; a > s;) if ((c = f[s++]) != c) return !0
        } else for (; a > s; s++) if ((t || s in f) && f[s] === r) return t || s || 0;
        return !t && -1
      }
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(3), i = r(1), o = r(28), u = r(73), c = r(65), f = r(79), a = r(68), s = r(6), l = r(4), h = r(123),
      v = r(81), p = r(136);
    t.exports = function (t, n, r, d, y, g) {
      var b = e[t], m = b, x = y ? "set" : "add", w = m && m.prototype, S = {}, _ = function (t) {
        var n = w[t];
        o(w, t, "delete" == t ? function (t) {
          return !(g && !s(t)) && n.call(this, 0 === t ? 0 : t)
        } : "has" == t ? function (t) {
          return !(g && !s(t)) && n.call(this, 0 === t ? 0 : t)
        } : "get" == t ? function (t) {
          return g && !s(t) ? void 0 : n.call(this, 0 === t ? 0 : t)
        } : "add" == t ? function (t) {
          return n.call(this, 0 === t ? 0 : t), this
        } : function (t, r) {
          return n.call(this, 0 === t ? 0 : t, r), this
        })
      };
      if ("function" == typeof m && (g || w.forEach && !l(function () {
          (new m).entries().next()
        }))) {
        var O = new m, E = O[x](g ? {} : -0, 1) != O, P = l(function () {
          O.has(1)
        }), j = h(function (t) {
          new m(t)
        }), F = !g && l(function () {
          for (var t = new m, n = 5; n--;) t[x](n, n);
          return !t.has(-0)
        });
        j || (m = n(function (n, r) {
          a(n, m, t);
          var e = p(new b, n, m);
          return void 0 != r && f(r, y, e[x], e), e
        }), m.prototype = w, w.constructor = m), (P || F) && (_("delete"), _("has"), y && _("get")), (F || E) && _(x), g && w.clear && delete w.clear
      } else m = d.getConstructor(n, t, y, x), u(m.prototype, r), c.NEED = !0;
      return v(m, t), S[t] = m, i(i.G + i.W + i.F * (m != b), S), g || d.setStrong(m, t, y), m
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(27), i = r(28), o = r(4), u = r(46), c = r(7);
    t.exports = function (t, n, r) {
      var f = c(t), a = r(u, f, ""[t]), s = a[0], l = a[1];
      o(function () {
        var n = {};
        return n[f] = function () {
          return 7
        }, 7 != ""[t](n)
      }) && (i(String.prototype, t, s), e(RegExp.prototype, f, 2 == n ? function (t, n) {
        return l.call(t, this, n)
      } : function (t) {
        return l.call(t, this)
      }))
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(2);
    t.exports = function () {
      var t = e(this), n = "";
      return t.global && (n += "g"), t.ignoreCase && (n += "i"), t.multiline && (n += "m"), t.unicode && (n += "u"), t.sticky && (n += "y"), n
    }
  }, function (t, n) {
    t.exports = function (t, n, r) {
      var e = void 0 === r;
      switch (n.length) {
        case 0:
          return e ? t() : t.call(r);
        case 1:
          return e ? t(n[0]) : t.call(r, n[0]);
        case 2:
          return e ? t(n[0], n[1]) : t.call(r, n[0], n[1]);
        case 3:
          return e ? t(n[0], n[1], n[2]) : t.call(r, n[0], n[1], n[2]);
        case 4:
          return e ? t(n[0], n[1], n[2], n[3]) : t.call(r, n[0], n[1], n[2], n[3])
      }
      return t.apply(r, n)
    }
  }, function (t, n, r) {
    var e = r(6), i = r(45), o = r(7)("match");
    t.exports = function (t) {
      var n;
      return e(t) && (void 0 !== (n = t[o]) ? !!n : "RegExp" == i(t))
    }
  }, function (t, n, r) {
    var e = r(7)("iterator"), i = !1;
    try {
      var o = [7][e]();
      o.return = function () {
        i = !0
      }, Array.from(o, function () {
        throw 2
      })
    } catch (t) {
    }
    t.exports = function (t, n) {
      if (!n && !i) return !1;
      var r = !1;
      try {
        var o = [7], u = o[e]();
        u.next = function () {
          return {done: r = !0}
        }, o[e] = function () {
          return u
        }, t(o)
      } catch (t) {
      }
      return r
    }
  }, function (t, n, r) {
    t.exports = r(69) || !r(4)(function () {
      var t = Math.random();
      __defineSetter__.call(null, t, function () {
      }), delete r(3)[t]
    })
  }, function (t, n) {
    n.f = Object.getOwnPropertySymbols
  }, function (t, n, r) {
    var e = r(3), i = "__core-js_shared__", o = e[i] || (e[i] = {});
    t.exports = function (t) {
      return o[t] || (o[t] = {})
    }
  }, function (t, n, r) {
    for (var e, i = r(3), o = r(27), u = r(76), c = u("typed_array"), f = u("view"), a = !(!i.ArrayBuffer || !i.DataView), s = a, l = 0, h = "Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(","); l < 9;) (e = i[h[l++]]) ? (o(e.prototype, c, !0), o(e.prototype, f, !0)) : s = !1;
    t.exports = {ABV: a, CONSTR: s, TYPED: c, VIEW: f}
  }, function (t, n) {
    "use strict";
    var r = {
      versions: function () {
        var t = window.navigator.userAgent;
        return {
          trident: t.indexOf("Trident") > -1,
          presto: t.indexOf("Presto") > -1,
          webKit: t.indexOf("AppleWebKit") > -1,
          gecko: t.indexOf("Gecko") > -1 && -1 == t.indexOf("KHTML"),
          mobile: !!t.match(/AppleWebKit.*Mobile.*/),
          ios: !!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),
          android: t.indexOf("Android") > -1 || t.indexOf("Linux") > -1,
          iPhone: t.indexOf("iPhone") > -1 || t.indexOf("Mac") > -1,
          iPad: t.indexOf("iPad") > -1,
          webApp: -1 == t.indexOf("Safari"),
          weixin: -1 == t.indexOf("MicroMessenger")
        }
      }()
    };
    t.exports = r
  }, function (t, n, r) {
    "use strict";
    var e = r(85), i = function (t) {
      return t && t.__esModule ? t : {default: t}
    }(e), o = function () {
      function t(t, n, e) {
        return n || e ? String.fromCharCode(n || e) : r[t] || t
      }

      function n(t) {
        return e[t]
      }

      var r = {"&quot;": '"', "&lt;": "<", "&gt;": ">", "&amp;": "&", "&nbsp;": " "}, e = {};
      for (var u in r) e[r[u]] = u;
      return r["&apos;"] = "'", e["'"] = "&#39;", {
        encode: function (t) {
          return t ? ("" + t).replace(/['<> "&]/g, n).replace(/\r?\n/g, "<br/>").replace(/\s/g, "&nbsp;") : ""
        }, decode: function (n) {
          return n ? ("" + n).replace(/<br\s*\/?>/gi, "\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g, t).replace(/\u00a0/g, " ") : ""
        }, encodeBase16: function (t) {
          if (!t) return t;
          t += "";
          for (var n = [], r = 0, e = t.length; e > r; r++) n.push(t.charCodeAt(r).toString(16).toUpperCase());
          return n.join("")
        }, encodeBase16forJSON: function (t) {
          if (!t) return t;
          t = t.replace(/[\u4E00-\u9FBF]/gi, function (t) {
            return escape(t).replace("%u", "\\u")
          });
          for (var n = [], r = 0, e = t.length; e > r; r++) n.push(t.charCodeAt(r).toString(16).toUpperCase());
          return n.join("")
        }, decodeBase16: function (t) {
          if (!t) return t;
          t += "";
          for (var n = [], r = 0, e = t.length; e > r; r += 2) n.push(String.fromCharCode("0x" + t.slice(r, r + 2)));
          return n.join("")
        }, encodeObject: function (t) {
          if (t instanceof Array) for (var n = 0, r = t.length; r > n; n++) t[n] = o.encodeObject(t[n]); else if ("object" == (void 0 === t ? "undefined" : (0, i.default)(t))) for (var e in t) t[e] = o.encodeObject(t[e]); else if ("string" == typeof t) return o.encode(t);
          return t
        }, loadScript: function (t) {
          var n = document.createElement("script");
          document.getElementsByTagName("body")[0].appendChild(n), n.setAttribute("src", t)
        }, addLoadEvent: function (t) {
          var n = window.onload;
          "function" != typeof window.onload ? window.onload = t : window.onload = function () {
            n(), t()
          }
        }
      }
    }();
    t.exports = o
  }, function (t, n, r) {
    "use strict";
    var e = r(17), i = r(75), o = r(16);
    t.exports = function (t) {
      for (var n = e(this), r = o(n.length), u = arguments.length, c = i(u > 1 ? arguments[1] : void 0, r), f = u > 2 ? arguments[2] : void 0, a = void 0 === f ? r : i(f, r); a > c;) n[c++] = t;
      return n
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(11), i = r(66);
    t.exports = function (t, n, r) {
      n in t ? e.f(t, n, i(0, r)) : t[n] = r
    }
  }, function (t, n, r) {
    var e = r(6), i = r(3).document, o = e(i) && e(i.createElement);
    t.exports = function (t) {
      return o ? i.createElement(t) : {}
    }
  }, function (t, n) {
    t.exports = "constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")
  }, function (t, n, r) {
    var e = r(7)("match");
    t.exports = function (t) {
      var n = /./;
      try {
        "/./"[t](n)
      } catch (r) {
        try {
          return n[e] = !1, !"/./"[t](n)
        } catch (t) {
        }
      }
      return !0
    }
  }, function (t, n, r) {
    t.exports = r(3).document && document.documentElement
  }, function (t, n, r) {
    var e = r(6), i = r(144).set;
    t.exports = function (t, n, r) {
      var o, u = n.constructor;
      return u !== r && "function" == typeof u && (o = u.prototype) !== r.prototype && e(o) && i && i(t, o), t
    }
  }, function (t, n, r) {
    var e = r(80), i = r(7)("iterator"), o = Array.prototype;
    t.exports = function (t) {
      return void 0 !== t && (e.Array === t || o[i] === t)
    }
  }, function (t, n, r) {
    var e = r(45);
    t.exports = Array.isArray || function (t) {
      return "Array" == e(t)
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(70), i = r(66), o = r(81), u = {};
    r(27)(u, r(7)("iterator"), function () {
      return this
    }), t.exports = function (t, n, r) {
      t.prototype = e(u, {next: i(1, r)}), o(t, n + " Iterator")
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(69), i = r(1), o = r(28), u = r(27), c = r(24), f = r(80), a = r(139), s = r(81), l = r(32),
      h = r(7)("iterator"), v = !([].keys && "next" in [].keys()), p = "keys", d = "values", y = function () {
        return this
      };
    t.exports = function (t, n, r, g, b, m, x) {
      a(r, n, g);
      var w, S, _, O = function (t) {
          if (!v && t in F) return F[t];
          switch (t) {
            case p:
            case d:
              return function () {
                return new r(this, t)
              }
          }
          return function () {
            return new r(this, t)
          }
        }, E = n + " Iterator", P = b == d, j = !1, F = t.prototype, M = F[h] || F["@@iterator"] || b && F[b],
        A = M || O(b), N = b ? P ? O("entries") : A : void 0, T = "Array" == n ? F.entries || M : M;
      if (T && (_ = l(T.call(new t))) !== Object.prototype && (s(_, E, !0), e || c(_, h) || u(_, h, y)), P && M && M.name !== d && (j = !0, A = function () {
          return M.call(this)
        }), e && !x || !v && !j && F[h] || u(F, h, A), f[n] = A, f[E] = y, b) if (w = {
          values: P ? A : O(d),
          keys: m ? A : O(p),
          entries: N
        }, x) for (S in w) S in F || o(F, S, w[S]); else i(i.P + i.F * (v || j), n, w);
      return w
    }
  }, function (t, n) {
    var r = Math.expm1;
    t.exports = !r || r(10) > 22025.465794806718 || r(10) < 22025.465794806718 || -2e-17 != r(-2e-17) ? function (t) {
      return 0 == (t = +t) ? t : t > -1e-6 && t < 1e-6 ? t + t * t / 2 : Math.exp(t) - 1
    } : r
  }, function (t, n) {
    t.exports = Math.sign || function (t) {
      return 0 == (t = +t) || t != t ? t : t < 0 ? -1 : 1
    }
  }, function (t, n, r) {
    var e = r(3), i = r(151).set, o = e.MutationObserver || e.WebKitMutationObserver, u = e.process, c = e.Promise,
      f = "process" == r(45)(u);
    t.exports = function () {
      var t, n, r, a = function () {
        var e, i;
        for (f && (e = u.domain) && e.exit(); t;) {
          i = t.fn, t = t.next;
          try {
            i()
          } catch (e) {
            throw t ? r() : n = void 0, e
          }
        }
        n = void 0, e && e.enter()
      };
      if (f) r = function () {
        u.nextTick(a)
      }; else if (o) {
        var s = !0, l = document.createTextNode("");
        new o(a).observe(l, {characterData: !0}), r = function () {
          l.data = s = !s
        }
      } else if (c && c.resolve) {
        var h = c.resolve();
        r = function () {
          h.then(a)
        }
      } else r = function () {
        i.call(e, a)
      };
      return function (e) {
        var i = {fn: e, next: void 0};
        n && (n.next = i), t || (t = i, r()), n = i
      }
    }
  }, function (t, n, r) {
    var e = r(6), i = r(2), o = function (t, n) {
      if (i(t), !e(n) && null !== n) throw TypeError(n + ": can't set as prototype!")
    };
    t.exports = {
      set: Object.setPrototypeOf || ("__proto__" in {} ? function (t, n, e) {
        try {
          e = r(53)(Function.call, r(31).f(Object.prototype, "__proto__").set, 2), e(t, []), n = !(t instanceof Array)
        } catch (t) {
          n = !0
        }
        return function (t, r) {
          return o(t, r), n ? t.__proto__ = r : e(t, r), t
        }
      }({}, !1) : void 0), check: o
    }
  }, function (t, n, r) {
    var e = r(126)("keys"), i = r(76);
    t.exports = function (t) {
      return e[t] || (e[t] = i(t))
    }
  }, function (t, n, r) {
    var e = r(2), i = r(26), o = r(7)("species");
    t.exports = function (t, n) {
      var r, u = e(t).constructor;
      return void 0 === u || void 0 == (r = e(u)[o]) ? n : i(r)
    }
  }, function (t, n, r) {
    var e = r(67), i = r(46);
    t.exports = function (t) {
      return function (n, r) {
        var o, u, c = String(i(n)), f = e(r), a = c.length;
        return f < 0 || f >= a ? t ? "" : void 0 : (o = c.charCodeAt(f), o < 55296 || o > 56319 || f + 1 === a || (u = c.charCodeAt(f + 1)) < 56320 || u > 57343 ? t ? c.charAt(f) : o : t ? c.slice(f, f + 2) : u - 56320 + (o - 55296 << 10) + 65536)
      }
    }
  }, function (t, n, r) {
    var e = r(122), i = r(46);
    t.exports = function (t, n, r) {
      if (e(n)) throw TypeError("String#" + r + " doesn't accept regex!");
      return String(i(t))
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(67), i = r(46);
    t.exports = function (t) {
      var n = String(i(this)), r = "", o = e(t);
      if (o < 0 || o == 1 / 0) throw RangeError("Count can't be negative");
      for (; o > 0; (o >>>= 1) && (n += n)) 1 & o && (r += n);
      return r
    }
  }, function (t, n) {
    t.exports = "\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"
  }, function (t, n, r) {
    var e, i, o, u = r(53), c = r(121), f = r(135), a = r(132), s = r(3), l = s.process, h = s.setImmediate,
      v = s.clearImmediate, p = s.MessageChannel, d = 0, y = {}, g = "onreadystatechange", b = function () {
        var t = +this;
        if (y.hasOwnProperty(t)) {
          var n = y[t];
          delete y[t], n()
        }
      }, m = function (t) {
        b.call(t.data)
      };
    h && v || (h = function (t) {
      for (var n = [], r = 1; arguments.length > r;) n.push(arguments[r++]);
      return y[++d] = function () {
        c("function" == typeof t ? t : Function(t), n)
      }, e(d), d
    }, v = function (t) {
      delete y[t]
    }, "process" == r(45)(l) ? e = function (t) {
      l.nextTick(u(b, t, 1))
    } : p ? (i = new p, o = i.port2, i.port1.onmessage = m, e = u(o.postMessage, o, 1)) : s.addEventListener && "function" == typeof postMessage && !s.importScripts ? (e = function (t) {
      s.postMessage(t + "", "*")
    }, s.addEventListener("message", m, !1)) : e = g in a("script") ? function (t) {
      f.appendChild(a("script"))[g] = function () {
        f.removeChild(this), b.call(t)
      }
    } : function (t) {
      setTimeout(u(b, t, 1), 0)
    }), t.exports = {set: h, clear: v}
  }, function (t, n, r) {
    "use strict";
    var e = r(3), i = r(10), o = r(69), u = r(127), c = r(27), f = r(73), a = r(4), s = r(68), l = r(67), h = r(16),
      v = r(71).f, p = r(11).f, d = r(130), y = r(81), g = "ArrayBuffer", b = "DataView", m = "prototype",
      x = "Wrong length!", w = "Wrong index!", S = e[g], _ = e[b], O = e.Math, E = e.RangeError, P = e.Infinity, j = S,
      F = O.abs, M = O.pow, A = O.floor, N = O.log, T = O.LN2, I = "buffer", k = "byteLength", L = "byteOffset",
      R = i ? "_b" : I, C = i ? "_l" : k, D = i ? "_o" : L, U = function (t, n, r) {
        var e, i, o, u = Array(r), c = 8 * r - n - 1, f = (1 << c) - 1, a = f >> 1,
          s = 23 === n ? M(2, -24) - M(2, -77) : 0, l = 0, h = t < 0 || 0 === t && 1 / t < 0 ? 1 : 0;
        for (t = F(t), t != t || t === P ? (i = t != t ? 1 : 0, e = f) : (e = A(N(t) / T), t * (o = M(2, -e)) < 1 && (e--, o *= 2), t += e + a >= 1 ? s / o : s * M(2, 1 - a), t * o >= 2 && (e++, o /= 2), e + a >= f ? (i = 0, e = f) : e + a >= 1 ? (i = (t * o - 1) * M(2, n), e += a) : (i = t * M(2, a - 1) * M(2, n), e = 0)); n >= 8; u[l++] = 255 & i, i /= 256, n -= 8) ;
        for (e = e << n | i, c += n; c > 0; u[l++] = 255 & e, e /= 256, c -= 8) ;
        return u[--l] |= 128 * h, u
      }, W = function (t, n, r) {
        var e, i = 8 * r - n - 1, o = (1 << i) - 1, u = o >> 1, c = i - 7, f = r - 1, a = t[f--], s = 127 & a;
        for (a >>= 7; c > 0; s = 256 * s + t[f], f--, c -= 8) ;
        for (e = s & (1 << -c) - 1, s >>= -c, c += n; c > 0; e = 256 * e + t[f], f--, c -= 8) ;
        if (0 === s) s = 1 - u; else {
          if (s === o) return e ? NaN : a ? -P : P;
          e += M(2, n), s -= u
        }
        return (a ? -1 : 1) * e * M(2, s - n)
      }, G = function (t) {
        return t[3] << 24 | t[2] << 16 | t[1] << 8 | t[0]
      }, B = function (t) {
        return [255 & t]
      }, V = function (t) {
        return [255 & t, t >> 8 & 255]
      }, z = function (t) {
        return [255 & t, t >> 8 & 255, t >> 16 & 255, t >> 24 & 255]
      }, q = function (t) {
        return U(t, 52, 8)
      }, K = function (t) {
        return U(t, 23, 4)
      }, J = function (t, n, r) {
        p(t[m], n, {
          get: function () {
            return this[r]
          }
        })
      }, Y = function (t, n, r, e) {
        var i = +r, o = l(i);
        if (i != o || o < 0 || o + n > t[C]) throw E(w);
        var u = t[R]._b, c = o + t[D], f = u.slice(c, c + n);
        return e ? f : f.reverse()
      }, H = function (t, n, r, e, i, o) {
        var u = +r, c = l(u);
        if (u != c || c < 0 || c + n > t[C]) throw E(w);
        for (var f = t[R]._b, a = c + t[D], s = e(+i), h = 0; h < n; h++) f[a + h] = s[o ? h : n - h - 1]
      }, $ = function (t, n) {
        s(t, S, g);
        var r = +n, e = h(r);
        if (r != e) throw E(x);
        return e
      };
    if (u.ABV) {
      if (!a(function () {
          new S
        }) || !a(function () {
          new S(.5)
        })) {
        S = function (t) {
          return new j($(this, t))
        };
        for (var X, Q = S[m] = j[m], Z = v(j), tt = 0; Z.length > tt;) (X = Z[tt++]) in S || c(S, X, j[X]);
        o || (Q.constructor = S)
      }
      var nt = new _(new S(2)), rt = _[m].setInt8;
      nt.setInt8(0, 2147483648), nt.setInt8(1, 2147483649), !nt.getInt8(0) && nt.getInt8(1) || f(_[m], {
        setInt8: function (t, n) {
          rt.call(this, t, n << 24 >> 24)
        }, setUint8: function (t, n) {
          rt.call(this, t, n << 24 >> 24)
        }
      }, !0)
    } else S = function (t) {
      var n = $(this, t);
      this._b = d.call(Array(n), 0), this[C] = n
    }, _ = function (t, n, r) {
      s(this, _, b), s(t, S, b);
      var e = t[C], i = l(n);
      if (i < 0 || i > e) throw E("Wrong offset!");
      if (r = void 0 === r ? e - i : h(r), i + r > e) throw E(x);
      this[R] = t, this[D] = i, this[C] = r
    }, i && (J(S, k, "_l"), J(_, I, "_b"), J(_, k, "_l"), J(_, L, "_o")), f(_[m], {
      getInt8: function (t) {
        return Y(this, 1, t)[0] << 24 >> 24
      }, getUint8: function (t) {
        return Y(this, 1, t)[0]
      }, getInt16: function (t) {
        var n = Y(this, 2, t, arguments[1]);
        return (n[1] << 8 | n[0]) << 16 >> 16
      }, getUint16: function (t) {
        var n = Y(this, 2, t, arguments[1]);
        return n[1] << 8 | n[0]
      }, getInt32: function (t) {
        return G(Y(this, 4, t, arguments[1]))
      }, getUint32: function (t) {
        return G(Y(this, 4, t, arguments[1])) >>> 0
      }, getFloat32: function (t) {
        return W(Y(this, 4, t, arguments[1]), 23, 4)
      }, getFloat64: function (t) {
        return W(Y(this, 8, t, arguments[1]), 52, 8)
      }, setInt8: function (t, n) {
        H(this, 1, t, B, n)
      }, setUint8: function (t, n) {
        H(this, 1, t, B, n)
      }, setInt16: function (t, n) {
        H(this, 2, t, V, n, arguments[2])
      }, setUint16: function (t, n) {
        H(this, 2, t, V, n, arguments[2])
      }, setInt32: function (t, n) {
        H(this, 4, t, z, n, arguments[2])
      }, setUint32: function (t, n) {
        H(this, 4, t, z, n, arguments[2])
      }, setFloat32: function (t, n) {
        H(this, 4, t, K, n, arguments[2])
      }, setFloat64: function (t, n) {
        H(this, 8, t, q, n, arguments[2])
      }
    });
    y(S, g), y(_, b), c(_[m], u.VIEW, !0), n[g] = S, n[b] = _
  }, function (t, n, r) {
    var e = r(3), i = r(52), o = r(69), u = r(182), c = r(11).f;
    t.exports = function (t) {
      var n = i.Symbol || (i.Symbol = o ? {} : e.Symbol || {});
      "_" == t.charAt(0) || t in n || c(n, t, {value: u.f(t)})
    }
  }, function (t, n, r) {
    var e = r(114), i = r(7)("iterator"), o = r(80);
    t.exports = r(52).getIteratorMethod = function (t) {
      if (void 0 != t) return t[i] || t["@@iterator"] || o[e(t)]
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(78), i = r(170), o = r(80), u = r(30);
    t.exports = r(140)(Array, "Array", function (t, n) {
      this._t = u(t), this._i = 0, this._k = n
    }, function () {
      var t = this._t, n = this._k, r = this._i++;
      return !t || r >= t.length ? (this._t = void 0, i(1)) : "keys" == n ? i(0, r) : "values" == n ? i(0, t[r]) : i(0, [r, t[r]])
    }, "values"), o.Arguments = o.Array, e("keys"), e("values"), e("entries")
  }, function (t, n) {
    function r(t, n) {
      t.classList ? t.classList.add(n) : t.className += " " + n
    }

    t.exports = r
  }, function (t, n) {
    function r(t, n) {
      if (t.classList) t.classList.remove(n); else {
        var r = new RegExp("(^|\\b)" + n.split(" ").join("|") + "(\\b|$)", "gi");
        t.className = t.className.replace(r, " ")
      }
    }

    t.exports = r
  }, function (t, n) {
    function r() {
      throw new Error("setTimeout has not been defined")
    }

    function e() {
      throw new Error("clearTimeout has not been defined")
    }

    function i(t) {
      if (s === setTimeout) return setTimeout(t, 0);
      if ((s === r || !s) && setTimeout) return s = setTimeout, setTimeout(t, 0);
      try {
        return s(t, 0)
      } catch (n) {
        try {
          return s.call(null, t, 0)
        } catch (n) {
          return s.call(this, t, 0)
        }
      }
    }

    function o(t) {
      if (l === clearTimeout) return clearTimeout(t);
      if ((l === e || !l) && clearTimeout) return l = clearTimeout, clearTimeout(t);
      try {
        return l(t)
      } catch (n) {
        try {
          return l.call(null, t)
        } catch (n) {
          return l.call(this, t)
        }
      }
    }

    function u() {
      d && v && (d = !1, v.length ? p = v.concat(p) : y = -1, p.length && c())
    }

    function c() {
      if (!d) {
        var t = i(u);
        d = !0;
        for (var n = p.length; n;) {
          for (v = p, p = []; ++y < n;) v && v[y].run();
          y = -1, n = p.length
        }
        v = null, d = !1, o(t)
      }
    }

    function f(t, n) {
      this.fun = t, this.array = n
    }

    function a() {
    }

    var s, l, h = t.exports = {};
    !function () {
      try {
        s = "function" == typeof setTimeout ? setTimeout : r
      } catch (t) {
        s = r
      }
      try {
        l = "function" == typeof clearTimeout ? clearTimeout : e
      } catch (t) {
        l = e
      }
    }();
    var v, p = [], d = !1, y = -1;
    h.nextTick = function (t) {
      var n = new Array(arguments.length - 1);
      if (arguments.length > 1) for (var r = 1; r < arguments.length; r++) n[r - 1] = arguments[r];
      p.push(new f(t, n)), 1 !== p.length || d || i(c)
    }, f.prototype.run = function () {
      this.fun.apply(null, this.array)
    }, h.title = "browser", h.browser = !0, h.env = {}, h.argv = [], h.version = "", h.versions = {}, h.on = a, h.addListener = a, h.once = a, h.off = a, h.removeListener = a, h.removeAllListeners = a, h.emit = a, h.prependListener = a, h.prependOnceListener = a, h.listeners = function (t) {
      return []
    }, h.binding = function (t) {
      throw new Error("process.binding is not supported")
    }, h.cwd = function () {
      return "/"
    }, h.chdir = function (t) {
      throw new Error("process.chdir is not supported")
    }, h.umask = function () {
      return 0
    }
  }, function (t, n, r) {
    var e = r(45);
    t.exports = function (t, n) {
      if ("number" != typeof t && "Number" != e(t)) throw TypeError(n);
      return +t
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(17), i = r(75), o = r(16);
    t.exports = [].copyWithin || function (t, n) {
      var r = e(this), u = o(r.length), c = i(t, u), f = i(n, u), a = arguments.length > 2 ? arguments[2] : void 0,
        s = Math.min((void 0 === a ? u : i(a, u)) - f, u - c), l = 1;
      for (f < c && c < f + s && (l = -1, f += s - 1, c += s - 1); s-- > 0;) f in r ? r[c] = r[f] : delete r[c], c += l, f += l;
      return r
    }
  }, function (t, n, r) {
    var e = r(79);
    t.exports = function (t, n) {
      var r = [];
      return e(t, !1, r.push, r, n), r
    }
  }, function (t, n, r) {
    var e = r(26), i = r(17), o = r(115), u = r(16);
    t.exports = function (t, n, r, c, f) {
      e(n);
      var a = i(t), s = o(a), l = u(a.length), h = f ? l - 1 : 0, v = f ? -1 : 1;
      if (r < 2) for (; ;) {
        if (h in s) {
          c = s[h], h += v;
          break
        }
        if (h += v, f ? h < 0 : l <= h) throw TypeError("Reduce of empty array with no initial value")
      }
      for (; f ? h >= 0 : l > h; h += v) h in s && (c = n(c, s[h], h, a));
      return c
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(26), i = r(6), o = r(121), u = [].slice, c = {}, f = function (t, n, r) {
      if (!(n in c)) {
        for (var e = [], i = 0; i < n; i++) e[i] = "a[" + i + "]";
        c[n] = Function("F,a", "return new F(" + e.join(",") + ")")
      }
      return c[n](t, r)
    };
    t.exports = Function.bind || function (t) {
      var n = e(this), r = u.call(arguments, 1), c = function () {
        var e = r.concat(u.call(arguments));
        return this instanceof c ? f(n, e.length, e) : o(n, e, t)
      };
      return i(n.prototype) && (c.prototype = n.prototype), c
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(11).f, i = r(70), o = r(73), u = r(53), c = r(68), f = r(46), a = r(79), s = r(140), l = r(170),
      h = r(74), v = r(10), p = r(65).fastKey, d = v ? "_s" : "size", y = function (t, n) {
        var r, e = p(n);
        if ("F" !== e) return t._i[e];
        for (r = t._f; r; r = r.n) if (r.k == n) return r
      };
    t.exports = {
      getConstructor: function (t, n, r, s) {
        var l = t(function (t, e) {
          c(t, l, n, "_i"), t._i = i(null), t._f = void 0, t._l = void 0, t[d] = 0, void 0 != e && a(e, r, t[s], t)
        });
        return o(l.prototype, {
          clear: function () {
            for (var t = this, n = t._i, r = t._f; r; r = r.n) r.r = !0, r.p && (r.p = r.p.n = void 0), delete n[r.i];
            t._f = t._l = void 0, t[d] = 0
          }, delete: function (t) {
            var n = this, r = y(n, t);
            if (r) {
              var e = r.n, i = r.p;
              delete n._i[r.i], r.r = !0, i && (i.n = e), e && (e.p = i), n._f == r && (n._f = e), n._l == r && (n._l = i), n[d]--
            }
            return !!r
          }, forEach: function (t) {
            c(this, l, "forEach");
            for (var n, r = u(t, arguments.length > 1 ? arguments[1] : void 0, 3); n = n ? n.n : this._f;) for (r(n.v, n.k, this); n && n.r;) n = n.p
          }, has: function (t) {
            return !!y(this, t)
          }
        }), v && e(l.prototype, "size", {
          get: function () {
            return f(this[d])
          }
        }), l
      }, def: function (t, n, r) {
        var e, i, o = y(t, n);
        return o ? o.v = r : (t._l = o = {
          i: i = p(n, !0),
          k: n,
          v: r,
          p: e = t._l,
          n: void 0,
          r: !1
        }, t._f || (t._f = o), e && (e.n = o), t[d]++, "F" !== i && (t._i[i] = o)), t
      }, getEntry: y, setStrong: function (t, n, r) {
        s(t, n, function (t, n) {
          this._t = t, this._k = n, this._l = void 0
        }, function () {
          for (var t = this, n = t._k, r = t._l; r && r.r;) r = r.p;
          return t._t && (t._l = r = r ? r.n : t._t._f) ? "keys" == n ? l(0, r.k) : "values" == n ? l(0, r.v) : l(0, [r.k, r.v]) : (t._t = void 0, l(1))
        }, r ? "entries" : "values", !r, !0), h(n)
      }
    }
  }, function (t, n, r) {
    var e = r(114), i = r(161);
    t.exports = function (t) {
      return function () {
        if (e(this) != t) throw TypeError(t + "#toJSON isn't generic");
        return i(this)
      }
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(73), i = r(65).getWeak, o = r(2), u = r(6), c = r(68), f = r(79), a = r(48), s = r(24), l = a(5),
      h = a(6), v = 0, p = function (t) {
        return t._l || (t._l = new d)
      }, d = function () {
        this.a = []
      }, y = function (t, n) {
        return l(t.a, function (t) {
          return t[0] === n
        })
      };
    d.prototype = {
      get: function (t) {
        var n = y(this, t);
        if (n) return n[1]
      }, has: function (t) {
        return !!y(this, t)
      }, set: function (t, n) {
        var r = y(this, t);
        r ? r[1] = n : this.a.push([t, n])
      }, delete: function (t) {
        var n = h(this.a, function (n) {
          return n[0] === t
        });
        return ~n && this.a.splice(n, 1), !!~n
      }
    }, t.exports = {
      getConstructor: function (t, n, r, o) {
        var a = t(function (t, e) {
          c(t, a, n, "_i"), t._i = v++, t._l = void 0, void 0 != e && f(e, r, t[o], t)
        });
        return e(a.prototype, {
          delete: function (t) {
            if (!u(t)) return !1;
            var n = i(t);
            return !0 === n ? p(this).delete(t) : n && s(n, this._i) && delete n[this._i]
          }, has: function (t) {
            if (!u(t)) return !1;
            var n = i(t);
            return !0 === n ? p(this).has(t) : n && s(n, this._i)
          }
        }), a
      }, def: function (t, n, r) {
        var e = i(o(n), !0);
        return !0 === e ? p(t).set(n, r) : e[t._i] = r, t
      }, ufstore: p
    }
  }, function (t, n, r) {
    t.exports = !r(10) && !r(4)(function () {
      return 7 != Object.defineProperty(r(132)("div"), "a", {
        get: function () {
          return 7
        }
      }).a
    })
  }, function (t, n, r) {
    var e = r(6), i = Math.floor;
    t.exports = function (t) {
      return !e(t) && isFinite(t) && i(t) === t
    }
  }, function (t, n, r) {
    var e = r(2);
    t.exports = function (t, n, r, i) {
      try {
        return i ? n(e(r)[0], r[1]) : n(r)
      } catch (n) {
        var o = t.return;
        throw void 0 !== o && e(o.call(t)), n
      }
    }
  }, function (t, n) {
    t.exports = function (t, n) {
      return {value: n, done: !!t}
    }
  }, function (t, n) {
    t.exports = Math.log1p || function (t) {
      return (t = +t) > -1e-8 && t < 1e-8 ? t - t * t / 2 : Math.log(1 + t)
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(72), i = r(125), o = r(116), u = r(17), c = r(115), f = Object.assign;
    t.exports = !f || r(4)(function () {
      var t = {}, n = {}, r = Symbol(), e = "abcdefghijklmnopqrst";
      return t[r] = 7, e.split("").forEach(function (t) {
        n[t] = t
      }), 7 != f({}, t)[r] || Object.keys(f({}, n)).join("") != e
    }) ? function (t, n) {
      for (var r = u(t), f = arguments.length, a = 1, s = i.f, l = o.f; f > a;) for (var h, v = c(arguments[a++]), p = s ? e(v).concat(s(v)) : e(v), d = p.length, y = 0; d > y;) l.call(v, h = p[y++]) && (r[h] = v[h]);
      return r
    } : f
  }, function (t, n, r) {
    var e = r(11), i = r(2), o = r(72);
    t.exports = r(10) ? Object.defineProperties : function (t, n) {
      i(t);
      for (var r, u = o(n), c = u.length, f = 0; c > f;) e.f(t, r = u[f++], n[r]);
      return t
    }
  }, function (t, n, r) {
    var e = r(30), i = r(71).f, o = {}.toString,
      u = "object" == typeof window && window && Object.getOwnPropertyNames ? Object.getOwnPropertyNames(window) : [],
      c = function (t) {
        try {
          return i(t)
        } catch (t) {
          return u.slice()
        }
      };
    t.exports.f = function (t) {
      return u && "[object Window]" == o.call(t) ? c(t) : i(e(t))
    }
  }, function (t, n, r) {
    var e = r(24), i = r(30), o = r(117)(!1), u = r(145)("IE_PROTO");
    t.exports = function (t, n) {
      var r, c = i(t), f = 0, a = [];
      for (r in c) r != u && e(c, r) && a.push(r);
      for (; n.length > f;) e(c, r = n[f++]) && (~o(a, r) || a.push(r));
      return a
    }
  }, function (t, n, r) {
    var e = r(72), i = r(30), o = r(116).f;
    t.exports = function (t) {
      return function (n) {
        for (var r, u = i(n), c = e(u), f = c.length, a = 0, s = []; f > a;) o.call(u, r = c[a++]) && s.push(t ? [r, u[r]] : u[r]);
        return s
      }
    }
  }, function (t, n, r) {
    var e = r(71), i = r(125), o = r(2), u = r(3).Reflect;
    t.exports = u && u.ownKeys || function (t) {
      var n = e.f(o(t)), r = i.f;
      return r ? n.concat(r(t)) : n
    }
  }, function (t, n, r) {
    var e = r(3).parseFloat, i = r(82).trim;
    t.exports = 1 / e(r(150) + "-0") != -1 / 0 ? function (t) {
      var n = i(String(t), 3), r = e(n);
      return 0 === r && "-" == n.charAt(0) ? -0 : r
    } : e
  }, function (t, n, r) {
    var e = r(3).parseInt, i = r(82).trim, o = r(150), u = /^[\-+]?0[xX]/;
    t.exports = 8 !== e(o + "08") || 22 !== e(o + "0x16") ? function (t, n) {
      var r = i(String(t), 3);
      return e(r, n >>> 0 || (u.test(r) ? 16 : 10))
    } : e
  }, function (t, n) {
    t.exports = Object.is || function (t, n) {
      return t === n ? 0 !== t || 1 / t == 1 / n : t != t && n != n
    }
  }, function (t, n, r) {
    var e = r(16), i = r(149), o = r(46);
    t.exports = function (t, n, r, u) {
      var c = String(o(t)), f = c.length, a = void 0 === r ? " " : String(r), s = e(n);
      if (s <= f || "" == a) return c;
      var l = s - f, h = i.call(a, Math.ceil(l / a.length));
      return h.length > l && (h = h.slice(0, l)), u ? h + c : c + h
    }
  }, function (t, n, r) {
    n.f = r(7)
  }, function (t, n, r) {
    "use strict";
    var e = r(164);
    t.exports = r(118)("Map", function (t) {
      return function () {
        return t(this, arguments.length > 0 ? arguments[0] : void 0)
      }
    }, {
      get: function (t) {
        var n = e.getEntry(this, t);
        return n && n.v
      }, set: function (t, n) {
        return e.def(this, 0 === t ? 0 : t, n)
      }
    }, e, !0)
  }, function (t, n, r) {
    r(10) && "g" != /./g.flags && r(11).f(RegExp.prototype, "flags", {configurable: !0, get: r(120)})
  }, function (t, n, r) {
    "use strict";
    var e = r(164);
    t.exports = r(118)("Set", function (t) {
      return function () {
        return t(this, arguments.length > 0 ? arguments[0] : void 0)
      }
    }, {
      add: function (t) {
        return e.def(this, t = 0 === t ? 0 : t, t)
      }
    }, e)
  }, function (t, n, r) {
    "use strict";
    var e, i = r(48)(0), o = r(28), u = r(65), c = r(172), f = r(166), a = r(6), s = u.getWeak, l = Object.isExtensible,
      h = f.ufstore, v = {}, p = function (t) {
        return function () {
          return t(this, arguments.length > 0 ? arguments[0] : void 0)
        }
      }, d = {
        get: function (t) {
          if (a(t)) {
            var n = s(t);
            return !0 === n ? h(this).get(t) : n ? n[this._i] : void 0
          }
        }, set: function (t, n) {
          return f.def(this, t, n)
        }
      }, y = t.exports = r(118)("WeakMap", p, d, f, !0, !0);
    7 != (new y).set((Object.freeze || Object)(v), 7).get(v) && (e = f.getConstructor(p), c(e.prototype, d), u.NEED = !0, i(["delete", "has", "get", "set"], function (t) {
      var n = y.prototype, r = n[t];
      o(n, t, function (n, i) {
        if (a(n) && !l(n)) {
          this._f || (this._f = new e);
          var o = this._f[t](n, i);
          return "set" == t ? this : o
        }
        return r.call(this, n, i)
      })
    }))
  }, , , , function (t, n) {
    "use strict";

    function r() {
      var t = document.querySelector("#page-nav");
      if (t && !document.querySelector("#page-nav .extend.prev") && (t.innerHTML = '<a class="extend prev disabled" rel="prev">&laquo; Prev</a>' + t.innerHTML), t && !document.querySelector("#page-nav .extend.next") && (t.innerHTML = t.innerHTML + '<a class="extend next disabled" rel="next">Next &raquo;</a>'), yiliaConfig && yiliaConfig.open_in_new) {
        document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function (t) {
          var n = t.getAttribute("target");
          n && "" !== n || t.setAttribute("target", "_blank")
        })
      }
      if (yiliaConfig && yiliaConfig.toc_hide_index) {
        document.querySelectorAll(".toc-number").forEach(function (t) {
          t.style.display = "none"
        })
      }
      var n = document.querySelector("#js-aboutme");
      n && 0 !== n.length && (n.innerHTML = n.innerText)
    }

    t.exports = {init: r}
  }, function (t, n, r) {
    "use strict";

    function e(t) {
      return t && t.__esModule ? t : {default: t}
    }

    function i(t, n) {
      var r = /\/|index.html/g;
      return t.replace(r, "") === n.replace(r, "")
    }

    function o() {
      for (var t = document.querySelectorAll(".js-header-menu li a"), n = window.location.pathname, r = 0, e = t.length; r < e; r++) {
        var o = t[r];
        i(n, o.getAttribute("href")) && (0, h.default)(o, "active")
      }
    }

    function u(t) {
      for (var n = t.offsetLeft, r = t.offsetParent; null !== r;) n += r.offsetLeft, r = r.offsetParent;
      return n
    }

    function c(t) {
      for (var n = t.offsetTop, r = t.offsetParent; null !== r;) n += r.offsetTop, r = r.offsetParent;
      return n
    }

    function f(t, n, r, e, i) {
      var o = u(t), f = c(t) - n;
      if (f - r <= i) {
        var a = t.$newDom;
        a || (a = t.cloneNode(!0), (0, d.default)(t, a), t.$newDom = a, a.style.position = "fixed", a.style.top = (r || f) + "px", a.style.left = o + "px", a.style.zIndex = e || 2, a.style.width = "100%", a.style.color = "#fff"), a.style.visibility = "visible", t.style.visibility = "hidden"
      } else {
        t.style.visibility = "visible";
        var s = t.$newDom;
        s && (s.style.visibility = "hidden")
      }
    }

    function a() {
      var t = document.querySelector(".js-overlay"), n = document.querySelector(".js-header-menu");
      f(t, document.body.scrollTop, -63, 2, 0), f(n, document.body.scrollTop, 1, 3, 0)
    }

    function s() {
      document.querySelector("#container").addEventListener("scroll", function (t) {
        a()
      }), window.addEventListener("scroll", function (t) {
        a()
      }), a()
    }

    var l = r(156), h = e(l), v = r(157), p = (e(v), r(382)), d = e(p), y = r(128), g = e(y), b = r(190), m = e(b),
      x = r(129);
    (function () {
      g.default.versions.mobile && window.screen.width < 800 && (o(), s())
    })(), (0, x.addLoadEvent)(function () {
      m.default.init()
    }), t.exports = {}
  }, , , , function (t, n, r) {
    (function (t) {
      "use strict";

      function n(t, n, r) {
        t[n] || Object[e](t, n, {writable: !0, configurable: !0, value: r})
      }

      if (r(381), r(391), r(198), t._babelPolyfill) throw new Error("only one instance of babel-polyfill is allowed");
      t._babelPolyfill = !0;
      var e = "defineProperty";
      n(String.prototype, "padLeft", "".padStart), n(String.prototype, "padRight", "".padEnd), "pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function (t) {
        [][t] && n(Array, t, Function.call.bind([][t]))
      })
    }).call(n, function () {
      return this
    }())
  }, , , function (t, n, r) {
    r(210), t.exports = r(52).RegExp.escape
  }, , , , function (t, n, r) {
    var e = r(6), i = r(138), o = r(7)("species");
    t.exports = function (t) {
      var n;
      return i(t) && (n = t.constructor, "function" != typeof n || n !== Array && !i(n.prototype) || (n = void 0), e(n) && null === (n = n[o]) && (n = void 0)), void 0 === n ? Array : n
    }
  }, function (t, n, r) {
    var e = r(202);
    t.exports = function (t, n) {
      return new (e(t))(n)
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(2), i = r(50), o = "number";
    t.exports = function (t) {
      if ("string" !== t && t !== o && "default" !== t) throw TypeError("Incorrect hint");
      return i(e(this), t != o)
    }
  }, function (t, n, r) {
    var e = r(72), i = r(125), o = r(116);
    t.exports = function (t) {
      var n = e(t), r = i.f;
      if (r) for (var u, c = r(t), f = o.f, a = 0; c.length > a;) f.call(t, u = c[a++]) && n.push(u);
      return n
    }
  }, function (t, n, r) {
    var e = r(72), i = r(30);
    t.exports = function (t, n) {
      for (var r, o = i(t), u = e(o), c = u.length, f = 0; c > f;) if (o[r = u[f++]] === n) return r
    }
  }, function (t, n, r) {
    "use strict";
    var e = r(208), i = r(121), o = r(26);
    t.exports = function () {
      for (var t = o(this), n = arguments.length, r = Array(n), u = 0, c = e._, f = !1; n > u;) (r[u] = arguments[u++]) === c && (f = !0);
      return function () {
        var e, o = this, u = arguments.length, a = 0, s = 0;
        if (!f && !u) return i(t, r, o);
        if (e = r.slice(), f) for (; n > a; a++) e[a] === c && (e[a] = arguments[s++]);
        for (; u > s;) e.push(arguments[s++]);
        return i(t, e, o)
      }
    }
  }, function (t, n, r) {
    t.exports = r(3)
  }, function (t, n) {
    t.exports = function (t, n) {
      var r = n === Object(n) ? function (t) {
        return n[t]
      } : n;
      return function (n) {
        return String(n).replace(t, r)
      }
    }
  }, function (t, n, r) {
    var e = r(1), i = r(209)(/[\\^$*+?.()|[\]{}]/g, "\\$&");
    e(e.S, "RegExp", {
      escape: function (t) {
        return i(t)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.P, "Array", {copyWithin: r(160)}), r(78)("copyWithin")
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(4);
    e(e.P + e.F * !r(47)([].every, !0), "Array", {
      every: function (t) {
        return i(this, t, arguments[1])
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.P, "Array", {fill: r(130)}), r(78)("fill")
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(2);
    e(e.P + e.F * !r(47)([].filter, !0), "Array", {
      filter: function (t) {
        return i(this, t, arguments[1])
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(6), o = "findIndex", u = !0;
    o in [] && Array(1)[o](function () {
      u = !1
    }), e(e.P + e.F * u, "Array", {
      findIndex: function (t) {
        return i(this, t, arguments.length > 1 ? arguments[1] : void 0)
      }
    }), r(78)(o)
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(5), o = "find", u = !0;
    o in [] && Array(1)[o](function () {
      u = !1
    }), e(e.P + e.F * u, "Array", {
      find: function (t) {
        return i(this, t, arguments.length > 1 ? arguments[1] : void 0)
      }
    }), r(78)(o)
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(0), o = r(47)([].forEach, !0);
    e(e.P + e.F * !o, "Array", {
      forEach: function (t) {
        return i(this, t, arguments[1])
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(53), i = r(1), o = r(17), u = r(169), c = r(137), f = r(16), a = r(131), s = r(154);
    i(i.S + i.F * !r(123)(function (t) {
      Array.from(t)
    }), "Array", {
      from: function (t) {
        var n, r, i, l, h = o(t), v = "function" == typeof this ? this : Array, p = arguments.length,
          d = p > 1 ? arguments[1] : void 0, y = void 0 !== d, g = 0, b = s(h);
        if (y && (d = e(d, p > 2 ? arguments[2] : void 0, 2)), void 0 == b || v == Array && c(b)) for (n = f(h.length), r = new v(n); n > g; g++) a(r, g, y ? d(h[g], g) : h[g]); else for (l = b.call(h), r = new v; !(i = l.next()).done; g++) a(r, g, y ? u(l, d, [i.value, g], !0) : i.value);
        return r.length = g, r
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(117)(!1), o = [].indexOf, u = !!o && 1 / [1].indexOf(1, -0) < 0;
    e(e.P + e.F * (u || !r(47)(o)), "Array", {
      indexOf: function (t) {
        return u ? o.apply(this, arguments) || 0 : i(this, t, arguments[1])
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Array", {isArray: r(138)})
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(30), o = [].join;
    e(e.P + e.F * (r(115) != Object || !r(47)(o)), "Array", {
      join: function (t) {
        return o.call(i(this), void 0 === t ? "," : t)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(30), o = r(67), u = r(16), c = [].lastIndexOf, f = !!c && 1 / [1].lastIndexOf(1, -0) < 0;
    e(e.P + e.F * (f || !r(47)(c)), "Array", {
      lastIndexOf: function (t) {
        if (f) return c.apply(this, arguments) || 0;
        var n = i(this), r = u(n.length), e = r - 1;
        for (arguments.length > 1 && (e = Math.min(e, o(arguments[1]))), e < 0 && (e = r + e); e >= 0; e--) if (e in n && n[e] === t) return e || 0;
        return -1
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(1);
    e(e.P + e.F * !r(47)([].map, !0), "Array", {
      map: function (t) {
        return i(this, t, arguments[1])
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(131);
    e(e.S + e.F * r(4)(function () {
      function t() {
      }

      return !(Array.of.call(t) instanceof t)
    }), "Array", {
      of: function () {
        for (var t = 0, n = arguments.length, r = new ("function" == typeof this ? this : Array)(n); n > t;) i(r, t, arguments[t++]);
        return r.length = n, r
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(162);
    e(e.P + e.F * !r(47)([].reduceRight, !0), "Array", {
      reduceRight: function (t) {
        return i(this, t, arguments.length, arguments[1], !0)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(162);
    e(e.P + e.F * !r(47)([].reduce, !0), "Array", {
      reduce: function (t) {
        return i(this, t, arguments.length, arguments[1], !1)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(135), o = r(45), u = r(75), c = r(16), f = [].slice;
    e(e.P + e.F * r(4)(function () {
      i && f.call(i)
    }), "Array", {
      slice: function (t, n) {
        var r = c(this.length), e = o(this);
        if (n = void 0 === n ? r : n, "Array" == e) return f.call(this, t, n);
        for (var i = u(t, r), a = u(n, r), s = c(a - i), l = Array(s), h = 0; h < s; h++) l[h] = "String" == e ? this.charAt(i + h) : this[i + h];
        return l
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(48)(3);
    e(e.P + e.F * !r(47)([].some, !0), "Array", {
      some: function (t) {
        return i(this, t, arguments[1])
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(26), o = r(17), u = r(4), c = [].sort, f = [1, 2, 3];
    e(e.P + e.F * (u(function () {
      f.sort(void 0)
    }) || !u(function () {
      f.sort(null)
    }) || !r(47)(c)), "Array", {
      sort: function (t) {
        return void 0 === t ? c.call(o(this)) : c.call(o(this), i(t))
      }
    })
  }, function (t, n, r) {
    r(74)("Array")
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Date", {
      now: function () {
        return (new Date).getTime()
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(4), o = Date.prototype.getTime, u = function (t) {
      return t > 9 ? t : "0" + t
    };
    e(e.P + e.F * (i(function () {
      return "0385-07-25T07:06:39.999Z" != new Date(-5e13 - 1).toISOString()
    }) || !i(function () {
      new Date(NaN).toISOString()
    })), "Date", {
      toISOString: function () {
        if (!isFinite(o.call(this))) throw RangeError("Invalid time value");
        var t = this, n = t.getUTCFullYear(), r = t.getUTCMilliseconds(), e = n < 0 ? "-" : n > 9999 ? "+" : "";
        return e + ("00000" + Math.abs(n)).slice(e ? -6 : -4) + "-" + u(t.getUTCMonth() + 1) + "-" + u(t.getUTCDate()) + "T" + u(t.getUTCHours()) + ":" + u(t.getUTCMinutes()) + ":" + u(t.getUTCSeconds()) + "." + (r > 99 ? r : "0" + u(r)) + "Z"
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(17), o = r(50);
    e(e.P + e.F * r(4)(function () {
      return null !== new Date(NaN).toJSON() || 1 !== Date.prototype.toJSON.call({
        toISOString: function () {
          return 1
        }
      })
    }), "Date", {
      toJSON: function (t) {
        var n = i(this), r = o(n);
        return "number" != typeof r || isFinite(r) ? n.toISOString() : null
      }
    })
  }, function (t, n, r) {
    var e = r(7)("toPrimitive"), i = Date.prototype;
    e in i || r(27)(i, e, r(204))
  }, function (t, n, r) {
    var e = Date.prototype, i = "Invalid Date", o = "toString", u = e[o], c = e.getTime;
    new Date(NaN) + "" != i && r(28)(e, o, function () {
      var t = c.call(this);
      return t === t ? u.call(this) : i
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.P, "Function", {bind: r(163)})
  }, function (t, n, r) {
    "use strict";
    var e = r(6), i = r(32), o = r(7)("hasInstance"), u = Function.prototype;
    o in u || r(11).f(u, o, {
      value: function (t) {
        if ("function" != typeof this || !e(t)) return !1;
        if (!e(this.prototype)) return t instanceof this;
        for (; t = i(t);) if (this.prototype === t) return !0;
        return !1
      }
    })
  }, function (t, n, r) {
    var e = r(11).f, i = r(66), o = r(24), u = Function.prototype, c = "name", f = Object.isExtensible || function () {
      return !0
    };
    c in u || r(10) && e(u, c, {
      configurable: !0, get: function () {
        try {
          var t = this, n = ("" + t).match(/^\s*function ([^ (]*)/)[1];
          return o(t, c) || !f(t) || e(t, c, i(5, n)), n
        } catch (t) {
          return ""
        }
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(171), o = Math.sqrt, u = Math.acosh;
    e(e.S + e.F * !(u && 710 == Math.floor(u(Number.MAX_VALUE)) && u(1 / 0) == 1 / 0), "Math", {
      acosh: function (t) {
        return (t = +t) < 1 ? NaN : t > 94906265.62425156 ? Math.log(t) + Math.LN2 : i(t - 1 + o(t - 1) * o(t + 1))
      }
    })
  }, function (t, n, r) {
    function e(t) {
      return isFinite(t = +t) && 0 != t ? t < 0 ? -e(-t) : Math.log(t + Math.sqrt(t * t + 1)) : t
    }

    var i = r(1), o = Math.asinh;
    i(i.S + i.F * !(o && 1 / o(0) > 0), "Math", {asinh: e})
  }, function (t, n, r) {
    var e = r(1), i = Math.atanh;
    e(e.S + e.F * !(i && 1 / i(-0) < 0), "Math", {
      atanh: function (t) {
        return 0 == (t = +t) ? t : Math.log((1 + t) / (1 - t)) / 2
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(142);
    e(e.S, "Math", {
      cbrt: function (t) {
        return i(t = +t) * Math.pow(Math.abs(t), 1 / 3)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      clz32: function (t) {
        return (t >>>= 0) ? 31 - Math.floor(Math.log(t + .5) * Math.LOG2E) : 32
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = Math.exp;
    e(e.S, "Math", {
      cosh: function (t) {
        return (i(t = +t) + i(-t)) / 2
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(141);
    e(e.S + e.F * (i != Math.expm1), "Math", {expm1: i})
  }, function (t, n, r) {
    var e = r(1), i = r(142), o = Math.pow, u = o(2, -52), c = o(2, -23), f = o(2, 127) * (2 - c), a = o(2, -126),
      s = function (t) {
        return t + 1 / u - 1 / u
      };
    e(e.S, "Math", {
      fround: function (t) {
        var n, r, e = Math.abs(t), o = i(t);
        return e < a ? o * s(e / a / c) * a * c : (n = (1 + c / u) * e, r = n - (n - e), r > f || r != r ? o * (1 / 0) : o * r)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = Math.abs;
    e(e.S, "Math", {
      hypot: function (t, n) {
        for (var r, e, o = 0, u = 0, c = arguments.length, f = 0; u < c;) r = i(arguments[u++]), f < r ? (e = f / r, o = o * e * e + 1, f = r) : r > 0 ? (e = r / f, o += e * e) : o += r;
        return f === 1 / 0 ? 1 / 0 : f * Math.sqrt(o)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = Math.imul;
    e(e.S + e.F * r(4)(function () {
      return -5 != i(4294967295, 5) || 2 != i.length
    }), "Math", {
      imul: function (t, n) {
        var r = 65535, e = +t, i = +n, o = r & e, u = r & i;
        return 0 | o * u + ((r & e >>> 16) * u + o * (r & i >>> 16) << 16 >>> 0)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      log10: function (t) {
        return Math.log(t) / Math.LN10
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {log1p: r(171)})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      log2: function (t) {
        return Math.log(t) / Math.LN2
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {sign: r(142)})
  }, function (t, n, r) {
    var e = r(1), i = r(141), o = Math.exp;
    e(e.S + e.F * r(4)(function () {
      return -2e-17 != !Math.sinh(-2e-17)
    }), "Math", {
      sinh: function (t) {
        return Math.abs(t = +t) < 1 ? (i(t) - i(-t)) / 2 : (o(t - 1) - o(-t - 1)) * (Math.E / 2)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(141), o = Math.exp;
    e(e.S, "Math", {
      tanh: function (t) {
        var n = i(t = +t), r = i(-t);
        return n == 1 / 0 ? 1 : r == 1 / 0 ? -1 : (n - r) / (o(t) + o(-t))
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      trunc: function (t) {
        return (t > 0 ? Math.floor : Math.ceil)(t)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(3), i = r(24), o = r(45), u = r(136), c = r(50), f = r(4), a = r(71).f, s = r(31).f, l = r(11).f,
      h = r(82).trim, v = "Number", p = e[v], d = p, y = p.prototype, g = o(r(70)(y)) == v,
      b = "trim" in String.prototype, m = function (t) {
        var n = c(t, !1);
        if ("string" == typeof n && n.length > 2) {
          n = b ? n.trim() : h(n, 3);
          var r, e, i, o = n.charCodeAt(0);
          if (43 === o || 45 === o) {
            if (88 === (r = n.charCodeAt(2)) || 120 === r) return NaN
          } else if (48 === o) {
            switch (n.charCodeAt(1)) {
              case 66:
              case 98:
                e = 2, i = 49;
                break;
              case 79:
              case 111:
                e = 8, i = 55;
                break;
              default:
                return +n
            }
            for (var u, f = n.slice(2), a = 0, s = f.length; a < s; a++) if ((u = f.charCodeAt(a)) < 48 || u > i) return NaN;
            return parseInt(f, e)
          }
        }
        return +n
      };
    if (!p(" 0o1") || !p("0b1") || p("+0x1")) {
      p = function (t) {
        var n = arguments.length < 1 ? 0 : t, r = this;
        return r instanceof p && (g ? f(function () {
          y.valueOf.call(r)
        }) : o(r) != v) ? u(new d(m(n)), r, p) : m(n)
      };
      for (var x, w = r(10) ? a(d) : "MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","), S = 0; w.length > S; S++) i(d, x = w[S]) && !i(p, x) && l(p, x, s(d, x));
      p.prototype = y, y.constructor = p, r(28)(e, v, p)
    }
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Number", {EPSILON: Math.pow(2, -52)})
  }, function (t, n, r) {
    var e = r(1), i = r(3).isFinite;
    e(e.S, "Number", {
      isFinite: function (t) {
        return "number" == typeof t && i(t)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Number", {isInteger: r(168)})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Number", {
      isNaN: function (t) {
        return t != t
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(168), o = Math.abs;
    e(e.S, "Number", {
      isSafeInteger: function (t) {
        return i(t) && o(t) <= 9007199254740991
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Number", {MAX_SAFE_INTEGER: 9007199254740991})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Number", {MIN_SAFE_INTEGER: -9007199254740991})
  }, function (t, n, r) {
    var e = r(1), i = r(178);
    e(e.S + e.F * (Number.parseFloat != i), "Number", {parseFloat: i})
  }, function (t, n, r) {
    var e = r(1), i = r(179);
    e(e.S + e.F * (Number.parseInt != i), "Number", {parseInt: i})
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(67), o = r(159), u = r(149), c = 1..toFixed, f = Math.floor, a = [0, 0, 0, 0, 0, 0],
      s = "Number.toFixed: incorrect invocation!", l = "0", h = function (t, n) {
        for (var r = -1, e = n; ++r < 6;) e += t * a[r], a[r] = e % 1e7, e = f(e / 1e7)
      }, v = function (t) {
        for (var n = 6, r = 0; --n >= 0;) r += a[n], a[n] = f(r / t), r = r % t * 1e7
      }, p = function () {
        for (var t = 6, n = ""; --t >= 0;) if ("" !== n || 0 === t || 0 !== a[t]) {
          var r = String(a[t]);
          n = "" === n ? r : n + u.call(l, 7 - r.length) + r
        }
        return n
      }, d = function (t, n, r) {
        return 0 === n ? r : n % 2 == 1 ? d(t, n - 1, r * t) : d(t * t, n / 2, r)
      }, y = function (t) {
        for (var n = 0, r = t; r >= 4096;) n += 12, r /= 4096;
        for (; r >= 2;) n += 1, r /= 2;
        return n
      };
    e(e.P + e.F * (!!c && ("0.000" !== 8e-5.toFixed(3) || "1" !== .9.toFixed(0) || "1.25" !== 1.255.toFixed(2) || "1000000000000000128" !== (0xde0b6b3a7640080).toFixed(0)) || !r(4)(function () {
      c.call({})
    })), "Number", {
      toFixed: function (t) {
        var n, r, e, c, f = o(this, s), a = i(t), g = "", b = l;
        if (a < 0 || a > 20) throw RangeError(s);
        if (f != f) return "NaN";
        if (f <= -1e21 || f >= 1e21) return String(f);
        if (f < 0 && (g = "-", f = -f), f > 1e-21) if (n = y(f * d(2, 69, 1)) - 69, r = n < 0 ? f * d(2, -n, 1) : f / d(2, n, 1), r *= 4503599627370496, (n = 52 - n) > 0) {
          for (h(0, r), e = a; e >= 7;) h(1e7, 0), e -= 7;
          for (h(d(10, e, 1), 0), e = n - 1; e >= 23;) v(1 << 23), e -= 23;
          v(1 << e), h(1, 1), v(2), b = p()
        } else h(0, r), h(1 << -n, 0), b = p() + u.call(l, a);
        return a > 0 ? (c = b.length, b = g + (c <= a ? "0." + u.call(l, a - c) + b : b.slice(0, c - a) + "." + b.slice(c - a))) : b = g + b, b
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(4), o = r(159), u = 1..toPrecision;
    e(e.P + e.F * (i(function () {
      return "1" !== u.call(1, void 0)
    }) || !i(function () {
      u.call({})
    })), "Number", {
      toPrecision: function (t) {
        var n = o(this, "Number#toPrecision: incorrect invocation!");
        return void 0 === t ? u.call(n) : u.call(n, t)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S + e.F, "Object", {assign: r(172)})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Object", {create: r(70)})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S + e.F * !r(10), "Object", {defineProperties: r(173)})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S + e.F * !r(10), "Object", {defineProperty: r(11).f})
  }, function (t, n, r) {
    var e = r(6), i = r(65).onFreeze;
    r(49)("freeze", function (t) {
      return function (n) {
        return t && e(n) ? t(i(n)) : n
      }
    })
  }, function (t, n, r) {
    var e = r(30), i = r(31).f;
    r(49)("getOwnPropertyDescriptor", function () {
      return function (t, n) {
        return i(e(t), n)
      }
    })
  }, function (t, n, r) {
    r(49)("getOwnPropertyNames", function () {
      return r(174).f
    })
  }, function (t, n, r) {
    var e = r(17), i = r(32);
    r(49)("getPrototypeOf", function () {
      return function (t) {
        return i(e(t))
      }
    })
  }, function (t, n, r) {
    var e = r(6);
    r(49)("isExtensible", function (t) {
      return function (n) {
        return !!e(n) && (!t || t(n))
      }
    })
  }, function (t, n, r) {
    var e = r(6);
    r(49)("isFrozen", function (t) {
      return function (n) {
        return !e(n) || !!t && t(n)
      }
    })
  }, function (t, n, r) {
    var e = r(6);
    r(49)("isSealed", function (t) {
      return function (n) {
        return !e(n) || !!t && t(n)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Object", {is: r(180)})
  }, function (t, n, r) {
    var e = r(17), i = r(72);
    r(49)("keys", function () {
      return function (t) {
        return i(e(t))
      }
    })
  }, function (t, n, r) {
    var e = r(6), i = r(65).onFreeze;
    r(49)("preventExtensions", function (t) {
      return function (n) {
        return t && e(n) ? t(i(n)) : n
      }
    })
  }, function (t, n, r) {
    var e = r(6), i = r(65).onFreeze;
    r(49)("seal", function (t) {
      return function (n) {
        return t && e(n) ? t(i(n)) : n
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Object", {setPrototypeOf: r(144).set})
  }, function (t, n, r) {
    "use strict";
    var e = r(114), i = {};
    i[r(7)("toStringTag")] = "z", i + "" != "[object z]" && r(28)(Object.prototype, "toString", function () {
      return "[object " + e(this) + "]"
    }, !0)
  }, function (t, n, r) {
    var e = r(1), i = r(178);
    e(e.G + e.F * (parseFloat != i), {parseFloat: i})
  }, function (t, n, r) {
    var e = r(1), i = r(179);
    e(e.G + e.F * (parseInt != i), {parseInt: i})
  }, function (t, n, r) {
    "use strict";
    var e, i, o, u = r(69), c = r(3), f = r(53), a = r(114), s = r(1), l = r(6), h = r(26), v = r(68), p = r(79),
      d = r(146), y = r(151).set, g = r(143)(), b = "Promise", m = c.TypeError, x = c.process, w = c[b], x = c.process,
      S = "process" == a(x), _ = function () {
      }, O = !!function () {
        try {
          var t = w.resolve(1), n = (t.constructor = {})[r(7)("species")] = function (t) {
            t(_, _)
          };
          return (S || "function" == typeof PromiseRejectionEvent) && t.then(_) instanceof n
        } catch (t) {
        }
      }(), E = function (t, n) {
        return t === n || t === w && n === o
      }, P = function (t) {
        var n;
        return !(!l(t) || "function" != typeof(n = t.then)) && n
      }, j = function (t) {
        return E(w, t) ? new F(t) : new i(t)
      }, F = i = function (t) {
        var n, r;
        this.promise = new t(function (t, e) {
          if (void 0 !== n || void 0 !== r) throw m("Bad Promise constructor");
          n = t, r = e
        }), this.resolve = h(n), this.reject = h(r)
      }, M = function (t) {
        try {
          t()
        } catch (t) {
          return {error: t}
        }
      }, A = function (t, n) {
        if (!t._n) {
          t._n = !0;
          var r = t._c;
          g(function () {
            for (var e = t._v, i = 1 == t._s, o = 0; r.length > o;) !function (n) {
              var r, o, u = i ? n.ok : n.fail, c = n.resolve, f = n.reject, a = n.domain;
              try {
                u ? (i || (2 == t._h && I(t), t._h = 1), !0 === u ? r = e : (a && a.enter(), r = u(e), a && a.exit()), r === n.promise ? f(m("Promise-chain cycle")) : (o = P(r)) ? o.call(r, c, f) : c(r)) : f(e)
              } catch (t) {
                f(t)
              }
            }(r[o++]);
            t._c = [], t._n = !1, n && !t._h && N(t)
          })
        }
      }, N = function (t) {
        y.call(c, function () {
          var n, r, e, i = t._v;
          if (T(t) && (n = M(function () {
              S ? x.emit("unhandledRejection", i, t) : (r = c.onunhandledrejection) ? r({
                promise: t,
                reason: i
              }) : (e = c.console) && e.error && e.error("Unhandled promise rejection", i)
            }), t._h = S || T(t) ? 2 : 1), t._a = void 0, n) throw n.error
        })
      }, T = function (t) {
        if (1 == t._h) return !1;
        for (var n, r = t._a || t._c, e = 0; r.length > e;) if (n = r[e++], n.fail || !T(n.promise)) return !1;
        return !0
      }, I = function (t) {
        y.call(c, function () {
          var n;
          S ? x.emit("rejectionHandled", t) : (n = c.onrejectionhandled) && n({promise: t, reason: t._v})
        })
      }, k = function (t) {
        var n = this;
        n._d || (n._d = !0, n = n._w || n, n._v = t, n._s = 2, n._a || (n._a = n._c.slice()), A(n, !0))
      }, L = function (t) {
        var n, r = this;
        if (!r._d) {
          r._d = !0, r = r._w || r;
          try {
            if (r === t) throw m("Promise can't be resolved itself");
            (n = P(t)) ? g(function () {
              var e = {_w: r, _d: !1};
              try {
                n.call(t, f(L, e, 1), f(k, e, 1))
              } catch (t) {
                k.call(e, t)
              }
            }) : (r._v = t, r._s = 1, A(r, !1))
          } catch (t) {
            k.call({_w: r, _d: !1}, t)
          }
        }
      };
    O || (w = function (t) {
      v(this, w, b, "_h"), h(t), e.call(this);
      try {
        t(f(L, this, 1), f(k, this, 1))
      } catch (t) {
        k.call(this, t)
      }
    }, e = function (t) {
      this._c = [], this._a = void 0, this._s = 0, this._d = !1, this._v = void 0, this._h = 0, this._n = !1
    }, e.prototype = r(73)(w.prototype, {
      then: function (t, n) {
        var r = j(d(this, w));
        return r.ok = "function" != typeof t || t, r.fail = "function" == typeof n && n, r.domain = S ? x.domain : void 0, this._c.push(r), this._a && this._a.push(r), this._s && A(this, !1), r.promise
      }, catch: function (t) {
        return this.then(void 0, t)
      }
    }), F = function () {
      var t = new e;
      this.promise = t, this.resolve = f(L, t, 1), this.reject = f(k, t, 1)
    }), s(s.G + s.W + s.F * !O, {Promise: w}), r(81)(w, b), r(74)(b), o = r(52)[b], s(s.S + s.F * !O, b, {
      reject: function (t) {
        var n = j(this);
        return (0, n.reject)(t), n.promise
      }
    }), s(s.S + s.F * (u || !O), b, {
      resolve: function (t) {
        if (t instanceof w && E(t.constructor, this)) return t;
        var n = j(this);
        return (0, n.resolve)(t), n.promise
      }
    }), s(s.S + s.F * !(O && r(123)(function (t) {
      w.all(t).catch(_)
    })), b, {
      all: function (t) {
        var n = this, r = j(n), e = r.resolve, i = r.reject, o = M(function () {
          var r = [], o = 0, u = 1;
          p(t, !1, function (t) {
            var c = o++, f = !1;
            r.push(void 0), u++, n.resolve(t).then(function (t) {
              f || (f = !0, r[c] = t, --u || e(r))
            }, i)
          }), --u || e(r)
        });
        return o && i(o.error), r.promise
      }, race: function (t) {
        var n = this, r = j(n), e = r.reject, i = M(function () {
          p(t, !1, function (t) {
            n.resolve(t).then(r.resolve, e)
          })
        });
        return i && e(i.error), r.promise
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(26), o = r(2), u = (r(3).Reflect || {}).apply, c = Function.apply;
    e(e.S + e.F * !r(4)(function () {
      u(function () {
      })
    }), "Reflect", {
      apply: function (t, n, r) {
        var e = i(t), f = o(r);
        return u ? u(e, n, f) : c.call(e, n, f)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(70), o = r(26), u = r(2), c = r(6), f = r(4), a = r(163), s = (r(3).Reflect || {}).construct,
      l = f(function () {
        function t() {
        }

        return !(s(function () {
        }, [], t) instanceof t)
      }), h = !f(function () {
        s(function () {
        })
      });
    e(e.S + e.F * (l || h), "Reflect", {
      construct: function (t, n) {
        o(t), u(n);
        var r = arguments.length < 3 ? t : o(arguments[2]);
        if (h && !l) return s(t, n, r);
        if (t == r) {
          switch (n.length) {
            case 0:
              return new t;
            case 1:
              return new t(n[0]);
            case 2:
              return new t(n[0], n[1]);
            case 3:
              return new t(n[0], n[1], n[2]);
            case 4:
              return new t(n[0], n[1], n[2], n[3])
          }
          var e = [null];
          return e.push.apply(e, n), new (a.apply(t, e))
        }
        var f = r.prototype, v = i(c(f) ? f : Object.prototype), p = Function.apply.call(t, v, n);
        return c(p) ? p : v
      }
    })
  }, function (t, n, r) {
    var e = r(11), i = r(1), o = r(2), u = r(50);
    i(i.S + i.F * r(4)(function () {
      Reflect.defineProperty(e.f({}, 1, {value: 1}), 1, {value: 2})
    }), "Reflect", {
      defineProperty: function (t, n, r) {
        o(t), n = u(n, !0), o(r);
        try {
          return e.f(t, n, r), !0
        } catch (t) {
          return !1
        }
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(31).f, o = r(2);
    e(e.S, "Reflect", {
      deleteProperty: function (t, n) {
        var r = i(o(t), n);
        return !(r && !r.configurable) && delete t[n]
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(2), o = function (t) {
      this._t = i(t), this._i = 0;
      var n, r = this._k = [];
      for (n in t) r.push(n)
    };
    r(139)(o, "Object", function () {
      var t, n = this, r = n._k;
      do {
        if (n._i >= r.length) return {value: void 0, done: !0}
      } while (!((t = r[n._i++]) in n._t));
      return {value: t, done: !1}
    }), e(e.S, "Reflect", {
      enumerate: function (t) {
        return new o(t)
      }
    })
  }, function (t, n, r) {
    var e = r(31), i = r(1), o = r(2);
    i(i.S, "Reflect", {
      getOwnPropertyDescriptor: function (t, n) {
        return e.f(o(t), n)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(32), o = r(2);
    e(e.S, "Reflect", {
      getPrototypeOf: function (t) {
        return i(o(t))
      }
    })
  }, function (t, n, r) {
    function e(t, n) {
      var r, c, s = arguments.length < 3 ? t : arguments[2];
      return a(t) === s ? t[n] : (r = i.f(t, n)) ? u(r, "value") ? r.value : void 0 !== r.get ? r.get.call(s) : void 0 : f(c = o(t)) ? e(c, n, s) : void 0
    }

    var i = r(31), o = r(32), u = r(24), c = r(1), f = r(6), a = r(2);
    c(c.S, "Reflect", {get: e})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Reflect", {
      has: function (t, n) {
        return n in t
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(2), o = Object.isExtensible;
    e(e.S, "Reflect", {
      isExtensible: function (t) {
        return i(t), !o || o(t)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Reflect", {ownKeys: r(177)})
  }, function (t, n, r) {
    var e = r(1), i = r(2), o = Object.preventExtensions;
    e(e.S, "Reflect", {
      preventExtensions: function (t) {
        i(t);
        try {
          return o && o(t), !0
        } catch (t) {
          return !1
        }
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(144);
    i && e(e.S, "Reflect", {
      setPrototypeOf: function (t, n) {
        i.check(t, n);
        try {
          return i.set(t, n), !0
        } catch (t) {
          return !1
        }
      }
    })
  }, function (t, n, r) {
    function e(t, n, r) {
      var f, h, v = arguments.length < 4 ? t : arguments[3], p = o.f(s(t), n);
      if (!p) {
        if (l(h = u(t))) return e(h, n, r, v);
        p = a(0)
      }
      return c(p, "value") ? !(!1 === p.writable || !l(v) || (f = o.f(v, n) || a(0), f.value = r, i.f(v, n, f), 0)) : void 0 !== p.set && (p.set.call(v, r), !0)
    }

    var i = r(11), o = r(31), u = r(32), c = r(24), f = r(1), a = r(66), s = r(2), l = r(6);
    f(f.S, "Reflect", {set: e})
  }, function (t, n, r) {
    var e = r(3), i = r(136), o = r(11).f, u = r(71).f, c = r(122), f = r(120), a = e.RegExp, s = a, l = a.prototype,
      h = /a/g, v = /a/g, p = new a(h) !== h;
    if (r(10) && (!p || r(4)(function () {
        return v[r(7)("match")] = !1, a(h) != h || a(v) == v || "/a/i" != a(h, "i")
      }))) {
      a = function (t, n) {
        var r = this instanceof a, e = c(t), o = void 0 === n;
        return !r && e && t.constructor === a && o ? t : i(p ? new s(e && !o ? t.source : t, n) : s((e = t instanceof a) ? t.source : t, e && o ? f.call(t) : n), r ? this : l, a)
      };
      for (var d = u(s), y = 0; d.length > y;) !function (t) {
        t in a || o(a, t, {
          configurable: !0, get: function () {
            return s[t]
          }, set: function (n) {
            s[t] = n
          }
        })
      }(d[y++]);
      l.constructor = a, a.prototype = l, r(28)(e, "RegExp", a)
    }
    r(74)("RegExp")
  }, function (t, n, r) {
    r(119)("match", 1, function (t, n, r) {
      return [function (r) {
        "use strict";
        var e = t(this), i = void 0 == r ? void 0 : r[n];
        return void 0 !== i ? i.call(r, e) : new RegExp(r)[n](String(e))
      }, r]
    })
  }, function (t, n, r) {
    r(119)("replace", 2, function (t, n, r) {
      return [function (e, i) {
        "use strict";
        var o = t(this), u = void 0 == e ? void 0 : e[n];
        return void 0 !== u ? u.call(e, o, i) : r.call(String(o), e, i)
      }, r]
    })
  }, function (t, n, r) {
    r(119)("search", 1, function (t, n, r) {
      return [function (r) {
        "use strict";
        var e = t(this), i = void 0 == r ? void 0 : r[n];
        return void 0 !== i ? i.call(r, e) : new RegExp(r)[n](String(e))
      }, r]
    })
  }, function (t, n, r) {
    r(119)("split", 2, function (t, n, e) {
      "use strict";
      var i = r(122), o = e, u = [].push, c = "split", f = "length", a = "lastIndex";
      if ("c" == "abbc"[c](/(b)*/)[1] || 4 != "test"[c](/(?:)/, -1)[f] || 2 != "ab"[c](/(?:ab)*/)[f] || 4 != "."[c](/(.?)(.?)/)[f] || "."[c](/()()/)[f] > 1 || ""[c](/.?/)[f]) {
        var s = void 0 === /()??/.exec("")[1];
        e = function (t, n) {
          var r = String(this);
          if (void 0 === t && 0 === n) return [];
          if (!i(t)) return o.call(r, t, n);
          var e, c, l, h, v, p = [],
            d = (t.ignoreCase ? "i" : "") + (t.multiline ? "m" : "") + (t.unicode ? "u" : "") + (t.sticky ? "y" : ""),
            y = 0, g = void 0 === n ? 4294967295 : n >>> 0, b = new RegExp(t.source, d + "g");
          for (s || (e = new RegExp("^" + b.source + "$(?!\\s)", d)); (c = b.exec(r)) && !((l = c.index + c[0][f]) > y && (p.push(r.slice(y, c.index)), !s && c[f] > 1 && c[0].replace(e, function () {
            for (v = 1; v < arguments[f] - 2; v++) void 0 === arguments[v] && (c[v] = void 0)
          }), c[f] > 1 && c.index < r[f] && u.apply(p, c.slice(1)), h = c[0][f], y = l, p[f] >= g));) b[a] === c.index && b[a]++;
          return y === r[f] ? !h && b.test("") || p.push("") : p.push(r.slice(y)), p[f] > g ? p.slice(0, g) : p
        }
      } else "0"[c](void 0, 0)[f] && (e = function (t, n) {
        return void 0 === t && 0 === n ? [] : o.call(this, t, n)
      });
      return [function (r, i) {
        var o = t(this), u = void 0 == r ? void 0 : r[n];
        return void 0 !== u ? u.call(r, o, i) : e.call(String(o), r, i)
      }, e]
    })
  }, function (t, n, r) {
    "use strict";
    r(184);
    var e = r(2), i = r(120), o = r(10), u = "toString", c = /./[u], f = function (t) {
      r(28)(RegExp.prototype, u, t, !0)
    };
    r(4)(function () {
      return "/a/b" != c.call({source: "a", flags: "b"})
    }) ? f(function () {
      var t = e(this);
      return "/".concat(t.source, "/", "flags" in t ? t.flags : !o && t instanceof RegExp ? i.call(t) : void 0)
    }) : c.name != u && f(function () {
      return c.call(this)
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("anchor", function (t) {
      return function (n) {
        return t(this, "a", "name", n)
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("big", function (t) {
      return function () {
        return t(this, "big", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("blink", function (t) {
      return function () {
        return t(this, "blink", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("bold", function (t) {
      return function () {
        return t(this, "b", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(147)(!1);
    e(e.P, "String", {
      codePointAt: function (t) {
        return i(this, t)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(16), o = r(148), u = "endsWith", c = ""[u];
    e(e.P + e.F * r(134)(u), "String", {
      endsWith: function (t) {
        var n = o(this, t, u), r = arguments.length > 1 ? arguments[1] : void 0, e = i(n.length),
          f = void 0 === r ? e : Math.min(i(r), e), a = String(t);
        return c ? c.call(n, a, f) : n.slice(f - a.length, f) === a
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("fixed", function (t) {
      return function () {
        return t(this, "tt", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("fontcolor", function (t) {
      return function (n) {
        return t(this, "font", "color", n)
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("fontsize", function (t) {
      return function (n) {
        return t(this, "font", "size", n)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(75), o = String.fromCharCode, u = String.fromCodePoint;
    e(e.S + e.F * (!!u && 1 != u.length), "String", {
      fromCodePoint: function (t) {
        for (var n, r = [], e = arguments.length, u = 0; e > u;) {
          if (n = +arguments[u++], i(n, 1114111) !== n) throw RangeError(n + " is not a valid code point");
          r.push(n < 65536 ? o(n) : o(55296 + ((n -= 65536) >> 10), n % 1024 + 56320))
        }
        return r.join("")
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(148), o = "includes";
    e(e.P + e.F * r(134)(o), "String", {
      includes: function (t) {
        return !!~i(this, t, o).indexOf(t, arguments.length > 1 ? arguments[1] : void 0)
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("italics", function (t) {
      return function () {
        return t(this, "i", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(147)(!0);
    r(140)(String, "String", function (t) {
      this._t = String(t), this._i = 0
    }, function () {
      var t, n = this._t, r = this._i;
      return r >= n.length ? {value: void 0, done: !0} : (t = e(n, r), this._i += t.length, {value: t, done: !1})
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("link", function (t) {
      return function (n) {
        return t(this, "a", "href", n)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(30), o = r(16);
    e(e.S, "String", {
      raw: function (t) {
        for (var n = i(t.raw), r = o(n.length), e = arguments.length, u = [], c = 0; r > c;) u.push(String(n[c++])), c < e && u.push(String(arguments[c]));
        return u.join("")
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.P, "String", {repeat: r(149)})
  }, function (t, n, r) {
    "use strict";
    r(29)("small", function (t) {
      return function () {
        return t(this, "small", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(16), o = r(148), u = "startsWith", c = ""[u];
    e(e.P + e.F * r(134)(u), "String", {
      startsWith: function (t) {
        var n = o(this, t, u), r = i(Math.min(arguments.length > 1 ? arguments[1] : void 0, n.length)), e = String(t);
        return c ? c.call(n, e, r) : n.slice(r, r + e.length) === e
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("strike", function (t) {
      return function () {
        return t(this, "strike", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("sub", function (t) {
      return function () {
        return t(this, "sub", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(29)("sup", function (t) {
      return function () {
        return t(this, "sup", "", "")
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(82)("trim", function (t) {
      return function () {
        return t(this, 3)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(3), i = r(24), o = r(10), u = r(1), c = r(28), f = r(65).KEY, a = r(4), s = r(126), l = r(81), h = r(76),
      v = r(7), p = r(182), d = r(153), y = r(206), g = r(205), b = r(138), m = r(2), x = r(30), w = r(50), S = r(66),
      _ = r(70), O = r(174), E = r(31), P = r(11), j = r(72), F = E.f, M = P.f, A = O.f, N = e.Symbol, T = e.JSON,
      I = T && T.stringify, k = "prototype", L = v("_hidden"), R = v("toPrimitive"), C = {}.propertyIsEnumerable,
      D = s("symbol-registry"), U = s("symbols"), W = s("op-symbols"), G = Object[k], B = "function" == typeof N,
      V = e.QObject, z = !V || !V[k] || !V[k].findChild, q = o && a(function () {
        return 7 != _(M({}, "a", {
          get: function () {
            return M(this, "a", {value: 7}).a
          }
        })).a
      }) ? function (t, n, r) {
        var e = F(G, n);
        e && delete G[n], M(t, n, r), e && t !== G && M(G, n, e)
      } : M, K = function (t) {
        var n = U[t] = _(N[k]);
        return n._k = t, n
      }, J = B && "symbol" == typeof N.iterator ? function (t) {
        return "symbol" == typeof t
      } : function (t) {
        return t instanceof N
      }, Y = function (t, n, r) {
        return t === G && Y(W, n, r), m(t), n = w(n, !0), m(r), i(U, n) ? (r.enumerable ? (i(t, L) && t[L][n] && (t[L][n] = !1), r = _(r, {enumerable: S(0, !1)})) : (i(t, L) || M(t, L, S(1, {})), t[L][n] = !0), q(t, n, r)) : M(t, n, r)
      }, H = function (t, n) {
        m(t);
        for (var r, e = g(n = x(n)), i = 0, o = e.length; o > i;) Y(t, r = e[i++], n[r]);
        return t
      }, $ = function (t, n) {
        return void 0 === n ? _(t) : H(_(t), n)
      }, X = function (t) {
        var n = C.call(this, t = w(t, !0));
        return !(this === G && i(U, t) && !i(W, t)) && (!(n || !i(this, t) || !i(U, t) || i(this, L) && this[L][t]) || n)
      }, Q = function (t, n) {
        if (t = x(t), n = w(n, !0), t !== G || !i(U, n) || i(W, n)) {
          var r = F(t, n);
          return !r || !i(U, n) || i(t, L) && t[L][n] || (r.enumerable = !0), r
        }
      }, Z = function (t) {
        for (var n, r = A(x(t)), e = [], o = 0; r.length > o;) i(U, n = r[o++]) || n == L || n == f || e.push(n);
        return e
      }, tt = function (t) {
        for (var n, r = t === G, e = A(r ? W : x(t)), o = [], u = 0; e.length > u;) !i(U, n = e[u++]) || r && !i(G, n) || o.push(U[n]);
        return o
      };
    B || (N = function () {
      if (this instanceof N) throw TypeError("Symbol is not a constructor!");
      var t = h(arguments.length > 0 ? arguments[0] : void 0), n = function (r) {
        this === G && n.call(W, r), i(this, L) && i(this[L], t) && (this[L][t] = !1), q(this, t, S(1, r))
      };
      return o && z && q(G, t, {configurable: !0, set: n}), K(t)
    }, c(N[k], "toString", function () {
      return this._k
    }), E.f = Q, P.f = Y, r(71).f = O.f = Z, r(116).f = X, r(125).f = tt, o && !r(69) && c(G, "propertyIsEnumerable", X, !0), p.f = function (t) {
      return K(v(t))
    }), u(u.G + u.W + u.F * !B, {Symbol: N});
    for (var nt = "hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","), rt = 0; nt.length > rt;) v(nt[rt++]);
    for (var nt = j(v.store), rt = 0; nt.length > rt;) d(nt[rt++]);
    u(u.S + u.F * !B, "Symbol", {
      for: function (t) {
        return i(D, t += "") ? D[t] : D[t] = N(t)
      }, keyFor: function (t) {
        if (J(t)) return y(D, t);
        throw TypeError(t + " is not a symbol!")
      }, useSetter: function () {
        z = !0
      }, useSimple: function () {
        z = !1
      }
    }), u(u.S + u.F * !B, "Object", {
      create: $,
      defineProperty: Y,
      defineProperties: H,
      getOwnPropertyDescriptor: Q,
      getOwnPropertyNames: Z,
      getOwnPropertySymbols: tt
    }), T && u(u.S + u.F * (!B || a(function () {
      var t = N();
      return "[null]" != I([t]) || "{}" != I({a: t}) || "{}" != I(Object(t))
    })), "JSON", {
      stringify: function (t) {
        if (void 0 !== t && !J(t)) {
          for (var n, r, e = [t], i = 1; arguments.length > i;) e.push(arguments[i++]);
          return n = e[1], "function" == typeof n && (r = n), !r && b(n) || (n = function (t, n) {
            if (r && (n = r.call(this, t, n)), !J(n)) return n
          }), e[1] = n, I.apply(T, e)
        }
      }
    }), N[k][R] || r(27)(N[k], R, N[k].valueOf), l(N, "Symbol"), l(Math, "Math", !0), l(e.JSON, "JSON", !0)
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(127), o = r(152), u = r(2), c = r(75), f = r(16), a = r(6), s = r(3).ArrayBuffer, l = r(146),
      h = o.ArrayBuffer, v = o.DataView, p = i.ABV && s.isView, d = h.prototype.slice, y = i.VIEW, g = "ArrayBuffer";
    e(e.G + e.W + e.F * (s !== h), {ArrayBuffer: h}), e(e.S + e.F * !i.CONSTR, g, {
      isView: function (t) {
        return p && p(t) || a(t) && y in t
      }
    }), e(e.P + e.U + e.F * r(4)(function () {
      return !new h(2).slice(1, void 0).byteLength
    }), g, {
      slice: function (t, n) {
        if (void 0 !== d && void 0 === n) return d.call(u(this), t);
        for (var r = u(this).byteLength, e = c(t, r), i = c(void 0 === n ? r : n, r), o = new (l(this, h))(f(i - e)), a = new v(this), s = new v(o), p = 0; e < i;) s.setUint8(p++, a.getUint8(e++));
        return o
      }
    }), r(74)(g)
  }, function (t, n, r) {
    var e = r(1);
    e(e.G + e.W + e.F * !r(127).ABV, {DataView: r(152).DataView})
  }, function (t, n, r) {
    r(55)("Float32", 4, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Float64", 8, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Int16", 2, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Int32", 4, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Int8", 1, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Uint16", 2, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Uint32", 4, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Uint8", 1, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    })
  }, function (t, n, r) {
    r(55)("Uint8", 1, function (t) {
      return function (n, r, e) {
        return t(this, n, r, e)
      }
    }, !0)
  }, function (t, n, r) {
    "use strict";
    var e = r(166);
    r(118)("WeakSet", function (t) {
      return function () {
        return t(this, arguments.length > 0 ? arguments[0] : void 0)
      }
    }, {
      add: function (t) {
        return e.def(this, t, !0)
      }
    }, e, !1, !0)
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(117)(!0);
    e(e.P, "Array", {
      includes: function (t) {
        return i(this, t, arguments.length > 1 ? arguments[1] : void 0)
      }
    }), r(78)("includes")
  }, function (t, n, r) {
    var e = r(1), i = r(143)(), o = r(3).process, u = "process" == r(45)(o);
    e(e.G, {
      asap: function (t) {
        var n = u && o.domain;
        i(n ? n.bind(t) : t)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(45);
    e(e.S, "Error", {
      isError: function (t) {
        return "Error" === i(t)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.P + e.R, "Map", {toJSON: r(165)("Map")})
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      iaddh: function (t, n, r, e) {
        var i = t >>> 0, o = n >>> 0, u = r >>> 0;
        return o + (e >>> 0) + ((i & u | (i | u) & ~(i + u >>> 0)) >>> 31) | 0
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      imulh: function (t, n) {
        var r = 65535, e = +t, i = +n, o = e & r, u = i & r, c = e >> 16, f = i >> 16,
          a = (c * u >>> 0) + (o * u >>> 16);
        return c * f + (a >> 16) + ((o * f >>> 0) + (a & r) >> 16)
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      isubh: function (t, n, r, e) {
        var i = t >>> 0, o = n >>> 0, u = r >>> 0;
        return o - (e >>> 0) - ((~i & u | ~(i ^ u) & i - u >>> 0) >>> 31) | 0
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "Math", {
      umulh: function (t, n) {
        var r = 65535, e = +t, i = +n, o = e & r, u = i & r, c = e >>> 16, f = i >>> 16,
          a = (c * u >>> 0) + (o * u >>> 16);
        return c * f + (a >>> 16) + ((o * f >>> 0) + (a & r) >>> 16)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(17), o = r(26), u = r(11);
    r(10) && e(e.P + r(124), "Object", {
      __defineGetter__: function (t, n) {
        u.f(i(this), t, {get: o(n), enumerable: !0, configurable: !0})
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(17), o = r(26), u = r(11);
    r(10) && e(e.P + r(124), "Object", {
      __defineSetter__: function (t, n) {
        u.f(i(this), t, {set: o(n), enumerable: !0, configurable: !0})
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(176)(!0);
    e(e.S, "Object", {
      entries: function (t) {
        return i(t)
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(177), o = r(30), u = r(31), c = r(131);
    e(e.S, "Object", {
      getOwnPropertyDescriptors: function (t) {
        for (var n, r = o(t), e = u.f, f = i(r), a = {}, s = 0; f.length > s;) c(a, n = f[s++], e(r, n));
        return a
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(17), o = r(50), u = r(32), c = r(31).f;
    r(10) && e(e.P + r(124), "Object", {
      __lookupGetter__: function (t) {
        var n, r = i(this), e = o(t, !0);
        do {
          if (n = c(r, e)) return n.get
        } while (r = u(r))
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(17), o = r(50), u = r(32), c = r(31).f;
    r(10) && e(e.P + r(124), "Object", {
      __lookupSetter__: function (t) {
        var n, r = i(this), e = o(t, !0);
        do {
          if (n = c(r, e)) return n.set
        } while (r = u(r))
      }
    })
  }, function (t, n, r) {
    var e = r(1), i = r(176)(!1);
    e(e.S, "Object", {
      values: function (t) {
        return i(t)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(3), o = r(52), u = r(143)(), c = r(7)("observable"), f = r(26), a = r(2), s = r(68), l = r(73),
      h = r(27), v = r(79), p = v.RETURN, d = function (t) {
        return null == t ? void 0 : f(t)
      }, y = function (t) {
        var n = t._c;
        n && (t._c = void 0, n())
      }, g = function (t) {
        return void 0 === t._o
      }, b = function (t) {
        g(t) || (t._o = void 0, y(t))
      }, m = function (t, n) {
        a(t), this._c = void 0, this._o = t, t = new x(this);
        try {
          var r = n(t), e = r;
          null != r && ("function" == typeof r.unsubscribe ? r = function () {
            e.unsubscribe()
          } : f(r), this._c = r)
        } catch (n) {
          return void t.error(n)
        }
        g(this) && y(this)
      };
    m.prototype = l({}, {
      unsubscribe: function () {
        b(this)
      }
    });
    var x = function (t) {
      this._s = t
    };
    x.prototype = l({}, {
      next: function (t) {
        var n = this._s;
        if (!g(n)) {
          var r = n._o;
          try {
            var e = d(r.next);
            if (e) return e.call(r, t)
          } catch (t) {
            try {
              b(n)
            } finally {
              throw t
            }
          }
        }
      }, error: function (t) {
        var n = this._s;
        if (g(n)) throw t;
        var r = n._o;
        n._o = void 0;
        try {
          var e = d(r.error);
          if (!e) throw t;
          t = e.call(r, t)
        } catch (t) {
          try {
            y(n)
          } finally {
            throw t
          }
        }
        return y(n), t
      }, complete: function (t) {
        var n = this._s;
        if (!g(n)) {
          var r = n._o;
          n._o = void 0;
          try {
            var e = d(r.complete);
            t = e ? e.call(r, t) : void 0
          } catch (t) {
            try {
              y(n)
            } finally {
              throw t
            }
          }
          return y(n), t
        }
      }
    });
    var w = function (t) {
      s(this, w, "Observable", "_f")._f = f(t)
    };
    l(w.prototype, {
      subscribe: function (t) {
        return new m(t, this._f)
      }, forEach: function (t) {
        var n = this;
        return new (o.Promise || i.Promise)(function (r, e) {
          f(t);
          var i = n.subscribe({
            next: function (n) {
              try {
                return t(n)
              } catch (t) {
                e(t), i.unsubscribe()
              }
            }, error: e, complete: r
          })
        })
      }
    }), l(w, {
      from: function (t) {
        var n = "function" == typeof this ? this : w, r = d(a(t)[c]);
        if (r) {
          var e = a(r.call(t));
          return e.constructor === n ? e : new n(function (t) {
            return e.subscribe(t)
          })
        }
        return new n(function (n) {
          var r = !1;
          return u(function () {
            if (!r) {
              try {
                if (v(t, !1, function (t) {
                    if (n.next(t), r) return p
                  }) === p) return
              } catch (t) {
                if (r) throw t;
                return void n.error(t)
              }
              n.complete()
            }
          }), function () {
            r = !0
          }
        })
      }, of: function () {
        for (var t = 0, n = arguments.length, r = Array(n); t < n;) r[t] = arguments[t++];
        return new ("function" == typeof this ? this : w)(function (t) {
          var n = !1;
          return u(function () {
            if (!n) {
              for (var e = 0; e < r.length; ++e) if (t.next(r[e]), n) return;
              t.complete()
            }
          }), function () {
            n = !0
          }
        })
      }
    }), h(w.prototype, c, function () {
      return this
    }), e(e.G, {Observable: w}), r(74)("Observable")
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = e.key, u = e.set;
    e.exp({
      defineMetadata: function (t, n, r, e) {
        u(t, n, i(r), o(e))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = e.key, u = e.map, c = e.store;
    e.exp({
      deleteMetadata: function (t, n) {
        var r = arguments.length < 3 ? void 0 : o(arguments[2]), e = u(i(n), r, !1);
        if (void 0 === e || !e.delete(t)) return !1;
        if (e.size) return !0;
        var f = c.get(n);
        return f.delete(r), !!f.size || c.delete(n)
      }
    })
  }, function (t, n, r) {
    var e = r(185), i = r(161), o = r(54), u = r(2), c = r(32), f = o.keys, a = o.key, s = function (t, n) {
      var r = f(t, n), o = c(t);
      if (null === o) return r;
      var u = s(o, n);
      return u.length ? r.length ? i(new e(r.concat(u))) : u : r
    };
    o.exp({
      getMetadataKeys: function (t) {
        return s(u(t), arguments.length < 2 ? void 0 : a(arguments[1]))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = r(32), u = e.has, c = e.get, f = e.key, a = function (t, n, r) {
      if (u(t, n, r)) return c(t, n, r);
      var e = o(n);
      return null !== e ? a(t, e, r) : void 0
    };
    e.exp({
      getMetadata: function (t, n) {
        return a(t, i(n), arguments.length < 3 ? void 0 : f(arguments[2]))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = e.keys, u = e.key;
    e.exp({
      getOwnMetadataKeys: function (t) {
        return o(i(t), arguments.length < 2 ? void 0 : u(arguments[1]))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = e.get, u = e.key;
    e.exp({
      getOwnMetadata: function (t, n) {
        return o(t, i(n), arguments.length < 3 ? void 0 : u(arguments[2]))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = r(32), u = e.has, c = e.key, f = function (t, n, r) {
      if (u(t, n, r)) return !0;
      var e = o(n);
      return null !== e && f(t, e, r)
    };
    e.exp({
      hasMetadata: function (t, n) {
        return f(t, i(n), arguments.length < 3 ? void 0 : c(arguments[2]))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = e.has, u = e.key;
    e.exp({
      hasOwnMetadata: function (t, n) {
        return o(t, i(n), arguments.length < 3 ? void 0 : u(arguments[2]))
      }
    })
  }, function (t, n, r) {
    var e = r(54), i = r(2), o = r(26), u = e.key, c = e.set;
    e.exp({
      metadata: function (t, n) {
        return function (r, e) {
          c(t, n, (void 0 !== e ? i : o)(r), u(e))
        }
      }
    })
  }, function (t, n, r) {
    var e = r(1);
    e(e.P + e.R, "Set", {toJSON: r(165)("Set")})
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(147)(!0);
    e(e.P, "String", {
      at: function (t) {
        return i(this, t)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(46), o = r(16), u = r(122), c = r(120), f = RegExp.prototype, a = function (t, n) {
      this._r = t, this._s = n
    };
    r(139)(a, "RegExp String", function () {
      var t = this._r.exec(this._s);
      return {value: t, done: null === t}
    }), e(e.P, "String", {
      matchAll: function (t) {
        if (i(this), !u(t)) throw TypeError(t + " is not a regexp!");
        var n = String(this), r = "flags" in f ? String(t.flags) : c.call(t),
          e = new RegExp(t.source, ~r.indexOf("g") ? r : "g" + r);
        return e.lastIndex = o(t.lastIndex), new a(e, n)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(181);
    e(e.P, "String", {
      padEnd: function (t) {
        return i(this, t, arguments.length > 1 ? arguments[1] : void 0, !1)
      }
    })
  }, function (t, n, r) {
    "use strict";
    var e = r(1), i = r(181);
    e(e.P, "String", {
      padStart: function (t) {
        return i(this, t, arguments.length > 1 ? arguments[1] : void 0, !0)
      }
    })
  }, function (t, n, r) {
    "use strict";
    r(82)("trimLeft", function (t) {
      return function () {
        return t(this, 1)
      }
    }, "trimStart")
  }, function (t, n, r) {
    "use strict";
    r(82)("trimRight", function (t) {
      return function () {
        return t(this, 2)
      }
    }, "trimEnd")
  }, function (t, n, r) {
    r(153)("asyncIterator")
  }, function (t, n, r) {
    r(153)("observable")
  }, function (t, n, r) {
    var e = r(1);
    e(e.S, "System", {global: r(3)})
  }, function (t, n, r) {
    for (var e = r(155), i = r(28), o = r(3), u = r(27), c = r(80), f = r(7), a = f("iterator"), s = f("toStringTag"), l = c.Array, h = ["NodeList", "DOMTokenList", "MediaList", "StyleSheetList", "CSSRuleList"], v = 0; v < 5; v++) {
      var p, d = h[v], y = o[d], g = y && y.prototype;
      if (g) {
        g[a] || u(g, a, l), g[s] || u(g, s, d), c[d] = l;
        for (p in e) g[p] || i(g, p, e[p], !0)
      }
    }
  }, function (t, n, r) {
    var e = r(1), i = r(151);
    e(e.G + e.B, {setImmediate: i.set, clearImmediate: i.clear})
  }, function (t, n, r) {
    var e = r(3), i = r(1), o = r(121), u = r(207), c = e.navigator, f = !!c && /MSIE .\./.test(c.userAgent),
      a = function (t) {
        return f ? function (n, r) {
          return t(o(u, [].slice.call(arguments, 2), "function" == typeof n ? n : Function(n)), r)
        } : t
      };
    i(i.G + i.B + i.F * f, {setTimeout: a(e.setTimeout), setInterval: a(e.setInterval)})
  }, function (t, n, r) {
    r(330), r(269), r(271), r(270), r(273), r(275), r(280), r(274), r(272), r(282), r(281), r(277), r(278), r(276), r(268), r(279), r(283), r(284), r(236), r(238), r(237), r(286), r(285), r(256), r(266), r(267), r(257), r(258), r(259), r(260), r(261), r(262), r(263), r(264), r(265), r(239), r(240), r(241), r(242), r(243), r(244), r(245), r(246), r(247), r(248), r(249), r(250), r(251), r(252), r(253), r(254), r(255), r(317), r(322), r(329), r(320), r(312), r(313), r(318), r(323), r(325), r(308), r(309), r(310), r(311), r(314), r(315), r(316), r(319), r(321), r(324), r(326), r(327), r(328), r(231), r(233), r(232), r(235), r(234), r(220), r(218), r(224), r(221), r(227), r(229), r(217), r(223), r(214), r(228), r(212), r(226), r(225), r(219), r(222), r(211), r(213), r(216), r(215), r(230), r(155), r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports = r(52)
  }, function (t, n) {
    function r(t, n) {
      if ("string" == typeof n) return t.insertAdjacentHTML("afterend", n);
      var r = t.nextSibling;
      return r ? t.parentNode.insertBefore(n, r) : t.parentNode.appendChild(n)
    }

    t.exports = r
  }, , , , , , , , , function (t, n, r) {
    (function (n, r) {
      !function (n) {
        "use strict";

        function e(t, n, r, e) {
          var i = n && n.prototype instanceof o ? n : o, u = Object.create(i.prototype), c = new p(e || []);
          return u._invoke = s(t, r, c), u
        }

        function i(t, n, r) {
          try {
            return {type: "normal", arg: t.call(n, r)}
          } catch (t) {
            return {type: "throw", arg: t}
          }
        }

        function o() {
        }

        function u() {
        }

        function c() {
        }

        function f(t) {
          ["next", "throw", "return"].forEach(function (n) {
            t[n] = function (t) {
              return this._invoke(n, t)
            }
          })
        }

        function a(t) {
          function n(r, e, o, u) {
            var c = i(t[r], t, e);
            if ("throw" !== c.type) {
              var f = c.arg, a = f.value;
              return a && "object" == typeof a && m.call(a, "__await") ? Promise.resolve(a.__await).then(function (t) {
                n("next", t, o, u)
              }, function (t) {
                n("throw", t, o, u)
              }) : Promise.resolve(a).then(function (t) {
                f.value = t, o(f)
              }, u)
            }
            u(c.arg)
          }

          function e(t, r) {
            function e() {
              return new Promise(function (e, i) {
                n(t, r, e, i)
              })
            }

            return o = o ? o.then(e, e) : e()
          }

          "object" == typeof r && r.domain && (n = r.domain.bind(n));
          var o;
          this._invoke = e
        }

        function s(t, n, r) {
          var e = P;
          return function (o, u) {
            if (e === F) throw new Error("Generator is already running");
            if (e === M) {
              if ("throw" === o) throw u;
              return y()
            }
            for (r.method = o, r.arg = u; ;) {
              var c = r.delegate;
              if (c) {
                var f = l(c, r);
                if (f) {
                  if (f === A) continue;
                  return f
                }
              }
              if ("next" === r.method) r.sent = r._sent = r.arg; else if ("throw" === r.method) {
                if (e === P) throw e = M, r.arg;
                r.dispatchException(r.arg)
              } else "return" === r.method && r.abrupt("return", r.arg);
              e = F;
              var a = i(t, n, r);
              if ("normal" === a.type) {
                if (e = r.done ? M : j, a.arg === A) continue;
                return {value: a.arg, done: r.done}
              }
              "throw" === a.type && (e = M, r.method = "throw", r.arg = a.arg)
            }
          }
        }

        function l(t, n) {
          var r = t.iterator[n.method];
          if (r === g) {
            if (n.delegate = null, "throw" === n.method) {
              if (t.iterator.return && (n.method = "return", n.arg = g, l(t, n), "throw" === n.method)) return A;
              n.method = "throw", n.arg = new TypeError("The iterator does not provide a 'throw' method")
            }
            return A
          }
          var e = i(r, t.iterator, n.arg);
          if ("throw" === e.type) return n.method = "throw", n.arg = e.arg, n.delegate = null, A;
          var o = e.arg;
          return o ? o.done ? (n[t.resultName] = o.value, n.next = t.nextLoc, "return" !== n.method && (n.method = "next", n.arg = g), n.delegate = null, A) : o : (n.method = "throw", n.arg = new TypeError("iterator result is not an object"), n.delegate = null, A)
        }

        function h(t) {
          var n = {tryLoc: t[0]};
          1 in t && (n.catchLoc = t[1]), 2 in t && (n.finallyLoc = t[2], n.afterLoc = t[3]), this.tryEntries.push(n)
        }

        function v(t) {
          var n = t.completion || {};
          n.type = "normal", delete n.arg, t.completion = n
        }

        function p(t) {
          this.tryEntries = [{tryLoc: "root"}], t.forEach(h, this), this.reset(!0)
        }

        function d(t) {
          if (t) {
            var n = t[w];
            if (n) return n.call(t);
            if ("function" == typeof t.next) return t;
            if (!isNaN(t.length)) {
              var r = -1, e = function n() {
                for (; ++r < t.length;) if (m.call(t, r)) return n.value = t[r], n.done = !1, n;
                return n.value = g, n.done = !0, n
              };
              return e.next = e
            }
          }
          return {next: y}
        }

        function y() {
          return {value: g, done: !0}
        }

        var g, b = Object.prototype, m = b.hasOwnProperty, x = "function" == typeof Symbol ? Symbol : {},
          w = x.iterator || "@@iterator", S = x.asyncIterator || "@@asyncIterator",
          _ = x.toStringTag || "@@toStringTag", O = "object" == typeof t, E = n.regeneratorRuntime;
        if (E) return void(O && (t.exports = E));
        E = n.regeneratorRuntime = O ? t.exports : {}, E.wrap = e;
        var P = "suspendedStart", j = "suspendedYield", F = "executing", M = "completed", A = {}, N = {};
        N[w] = function () {
          return this
        };
        var T = Object.getPrototypeOf, I = T && T(T(d([])));
        I && I !== b && m.call(I, w) && (N = I);
        var k = c.prototype = o.prototype = Object.create(N);
        u.prototype = k.constructor = c, c.constructor = u, c[_] = u.displayName = "GeneratorFunction", E.isGeneratorFunction = function (t) {
          var n = "function" == typeof t && t.constructor;
          return !!n && (n === u || "GeneratorFunction" === (n.displayName || n.name))
        }, E.mark = function (t) {
          return Object.setPrototypeOf ? Object.setPrototypeOf(t, c) : (t.__proto__ = c, _ in t || (t[_] = "GeneratorFunction")), t.prototype = Object.create(k), t
        }, E.awrap = function (t) {
          return {__await: t}
        }, f(a.prototype), a.prototype[S] = function () {
          return this
        }, E.AsyncIterator = a, E.async = function (t, n, r, i) {
          var o = new a(e(t, n, r, i));
          return E.isGeneratorFunction(n) ? o : o.next().then(function (t) {
            return t.done ? t.value : o.next()
          })
        }, f(k), k[_] = "Generator", k.toString = function () {
          return "[object Generator]"
        }, E.keys = function (t) {
          var n = [];
          for (var r in t) n.push(r);
          return n.reverse(), function r() {
            for (; n.length;) {
              var e = n.pop();
              if (e in t) return r.value = e, r.done = !1, r
            }
            return r.done = !0, r
          }
        }, E.values = d, p.prototype = {
          constructor: p, reset: function (t) {
            if (this.prev = 0, this.next = 0, this.sent = this._sent = g, this.done = !1, this.delegate = null, this.method = "next", this.arg = g, this.tryEntries.forEach(v), !t) for (var n in this) "t" === n.charAt(0) && m.call(this, n) && !isNaN(+n.slice(1)) && (this[n] = g)
          }, stop: function () {
            this.done = !0;
            var t = this.tryEntries[0], n = t.completion;
            if ("throw" === n.type) throw n.arg;
            return this.rval
          }, dispatchException: function (t) {
            function n(n, e) {
              return o.type = "throw", o.arg = t, r.next = n, e && (r.method = "next", r.arg = g), !!e
            }

            if (this.done) throw t;
            for (var r = this, e = this.tryEntries.length - 1; e >= 0; --e) {
              var i = this.tryEntries[e], o = i.completion;
              if ("root" === i.tryLoc) return n("end");
              if (i.tryLoc <= this.prev) {
                var u = m.call(i, "catchLoc"), c = m.call(i, "finallyLoc");
                if (u && c) {
                  if (this.prev < i.catchLoc) return n(i.catchLoc, !0);
                  if (this.prev < i.finallyLoc) return n(i.finallyLoc)
                } else if (u) {
                  if (this.prev < i.catchLoc) return n(i.catchLoc, !0)
                } else {
                  if (!c) throw new Error("try statement without catch or finally");
                  if (this.prev < i.finallyLoc) return n(i.finallyLoc)
                }
              }
            }
          }, abrupt: function (t, n) {
            for (var r = this.tryEntries.length - 1; r >= 0; --r) {
              var e = this.tryEntries[r];
              if (e.tryLoc <= this.prev && m.call(e, "finallyLoc") && this.prev < e.finallyLoc) {
                var i = e;
                break
              }
            }
            i && ("break" === t || "continue" === t) && i.tryLoc <= n && n <= i.finallyLoc && (i = null);
            var o = i ? i.completion : {};
            return o.type = t, o.arg = n, i ? (this.method = "next", this.next = i.finallyLoc, A) : this.complete(o)
          }, complete: function (t, n) {
            if ("throw" === t.type) throw t.arg;
            return "break" === t.type || "continue" === t.type ? this.next = t.arg : "return" === t.type ? (this.rval = this.arg = t.arg, this.method = "return", this.next = "end") : "normal" === t.type && n && (this.next = n), A
          }, finish: function (t) {
            for (var n = this.tryEntries.length - 1; n >= 0; --n) {
              var r = this.tryEntries[n];
              if (r.finallyLoc === t) return this.complete(r.completion, r.afterLoc), v(r), A
            }
          }, catch: function (t) {
            for (var n = this.tryEntries.length - 1; n >= 0; --n) {
              var r = this.tryEntries[n];
              if (r.tryLoc === t) {
                var e = r.completion;
                if ("throw" === e.type) {
                  var i = e.arg;
                  v(r)
                }
                return i
              }
            }
            throw new Error("illegal catch attempt")
          }, delegateYield: function (t, n, r) {
            return this.delegate = {
              iterator: d(t),
              resultName: n,
              nextLoc: r
            }, "next" === this.method && (this.arg = g), A
          }
        }
      }("object" == typeof n ? n : "object" == typeof window ? window : "object" == typeof self ? self : this)
    }).call(n, function () {
      return this
    }(), r(158))
  }])</script>
<script src="/./main.0cf68a.js"></script>
<script>!function () {
    !function (e) {
      var t = document.createElement("script");
      document.getElementsByTagName("body")[0].appendChild(t), t.setAttribute("src", e)
    }("/slider.e37972.js")
  }()</script>
  <script>pangu.spacingPage();</script>
</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 50%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
        
      
      <li style="width: 50%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="搜索文章">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">标签:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">计算机网络</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">MySQL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">收藏</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Redis</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Spring</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">备忘录</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">读书笔记</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">密码学</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">本科毕业于电子科大，现电子科大研究生在读&lt;br&gt;坐标成都，一枚奋进的Java程序猿</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>